{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-02-04T15:07:31.000Z",
    "createdAt": "2026-02-04T15:07:16.385Z",
    "versionId": "12e5a58a-68dc-4eea-a17b-f58ae1a9ed76",
    "workflowId": "8zLv7DpNHO5BT9ay",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "monto-descuentos",
          "options": {}
        },
        "name": "Webhook2",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1,
        "position": [
          -2608,
          1376
        ],
        "id": "37e24b67-a5c8-483d-9cbb-d6deb3bffc60",
        "webhookId": "7ffd809b-cd97-4781-bbac-1cd59c4cf3d4"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.headers[\"x-shopify-topic\"] }}",
                      "rightValue": "refunds/create",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      },
                      "id": "05df5634-175d-4197-9602-04063623ac57"
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 1
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.headers[\"x-shopify-topic\"] }}",
                      "rightValue": "orders/create",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      },
                      "id": "b7de8ecd-dbbe-4ba1-8cbf-a320b3f20ff8"
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "name": "Switch Topic1",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3,
        "position": [
          -2416,
          1376
        ],
        "id": "ad3ea731-07dc-45f4-ab7f-2fa1122403fb"
      },
      {
        "parameters": {
          "jsCode": "// ================================================================\n// 1. OBTENCIÓN ROBUSTA DE DATOS (WEBHOOK VS GRAPHQL)\n// ================================================================\nlet webhookNode;\nlet webhookBody;\nlet webhookHeaders;\n\ntry {\n    // Intentamos leer el nodo \"Webhook2\" explícitamente\n    if ($('Webhook2') && $('Webhook2').first()) {\n        webhookNode = $('Webhook2').first().json;\n    } else {\n        // Fallback: Si no se llama \"Webhook2\", usamos el primer input disponible\n        webhookNode = $input.all()[0].json;\n    }\n} catch (error) {\n    webhookNode = {};\n}\n\n// Normalización: Asegurar que tenemos headers y body disponibles\nif (webhookNode.headers && webhookNode.body) {\n    // Caso A: Venimos directo del Webhook\n    webhookHeaders = webhookNode.headers;\n    webhookBody = webhookNode.body;\n} else if ($input.item.json.headers && $input.item.json.body) {\n    // Caso B: El input actual conserva la estructura del webhook\n    webhookHeaders = $input.item.json.headers;\n    webhookBody = $input.item.json.body;\n} else {\n    // Caso C: Estamos tras el nodo GraphQL (\"Get Refund Customer1\").\n    // Aquí el $input es la respuesta de Shopify, así que forzamos la lectura del nodo Webhook2\n    // para recuperar las transacciones originales.\n    try {\n        const whSource = $('Webhook2').first().json;\n        webhookHeaders = whSource.headers;\n        webhookBody = whSource.body;\n    } catch(e) {\n        // Si todo falla, dejamos objetos vacíos para evitar crash, pero el flujo fallará lógicamente\n        webhookHeaders = {};\n        webhookBody = {};\n    }\n}\n\nconst topic = webhookHeaders[\"x-shopify-topic\"] || \"\";\nconst body = webhookBody || {};\n\n// Variables de salida\nlet customerId = \"\";\nlet amountToProcess = 0;\nlet discountCode = null;\n\n// ================================================================\n// 2. LÓGICA PRINCIPAL (PEDIDOS VS DEVOLUCIONES)\n// ================================================================\n\nif (topic.includes('orders/create')) {\n    // ------------------------------------------------------------\n    // CASO: NUEVO PEDIDO\n    // ------------------------------------------------------------\n    \n    // A. Obtener ID Cliente\n    if (body.customer && body.customer.admin_graphql_api_id) {\n        customerId = body.customer.admin_graphql_api_id;\n    }\n\n    // B. Detectar Descuento\n    if (body.discount_codes && body.discount_codes.length > 0) {\n        discountCode = body.discount_codes[0].code;\n    } else if (body.discount_applications && body.discount_applications.length > 0) {\n        discountCode = body.discount_applications[0].title;\n    }\n\n    // C. Calcular Monto (Solo si hubo descuento aplicado)\n    const totalDiscounts = parseFloat(body.total_discounts || \"0\");\n    if (totalDiscounts > 0) {\n        amountToProcess = parseFloat(body.total_price);\n    } else {\n        amountToProcess = 0;\n    }\n\n} else if (topic.includes('refunds/create')) {\n    // ------------------------------------------------------------\n    // CASO: DEVOLUCIÓN (REFUND)\n    // ------------------------------------------------------------\n\n    // A. Obtener datos enriquecidos desde GraphQL (Nodo anterior)\n    let orderData = null;\n    try {\n        orderData = $input.item.json.data ? $input.item.json.data.order : null;\n    } catch(e) {}\n    \n    // B. Obtener ID Cliente y Código del pedido original\n    if (orderData && orderData.customer) {\n         customerId = orderData.customer.id;\n         \n         if (orderData.discountCodes && orderData.discountCodes.length > 0) {\n             const codeItem = orderData.discountCodes[0];\n             discountCode = (typeof codeItem === 'string') ? codeItem : codeItem.code;\n         } \n    } else {\n         // Fallback de emergencia\n         customerId = body.order_id; \n    }\n\n    // C. CALCULAR MONTO A RESTAR (LÓGICA CRÍTICA \"FOLLOW THE MONEY\")\n    // Buscamos el array de transacciones financieras en el cuerpo del webhook.\n    const transactions = body.transactions || [];\n    \n    // Sumamos solo si hay dinero devuelto. \n    // Si transactions es [] (Cambio de Talla), el total será 0.\n    const totalRefunded = transactions.reduce((acc, curr) => {\n        return acc + parseFloat(curr.amount || 0);\n    }, 0);\n    \n    // Convertimos a negativo para restar del saldo acumulado\n    amountToProcess = -Math.abs(totalRefunded);\n}\n\n// ================================================================\n// 3. RETORNO FINAL\n// ================================================================\nreturn {\n    json: {\n        customerId: customerId,\n        amountToProcess: amountToProcess,\n        discountCode: discountCode\n    }\n};"
        },
        "name": "Code Unificador1",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1952,
          1392
        ],
        "id": "c095aca7-cd13-45a4-92a7-86c98e6a5ea8"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
          "requestFormat": "json",
          "query": "query getCustomerMetafields($customerId: ID!) {\n  customer(id: $customerId) {\n    id\n    total: metafield(namespace: \"custom\", key: \"monto_total\") {\n      value\n    }\n    profesor: metafield(namespace: \"custom\", key: \"monto_profesor_40\") {\n      value\n    }\n    club: metafield(namespace: \"custom\", key: \"monto_club_30\") {\n      value\n    }\n    empleado: metafield(namespace: \"custom\", key: \"monto_empleado_25\") {\n      value\n    }\n  }\n}",
          "variables": "={\n  \"customerId\": \"{{ $json.customerId }}\"\n}"
        },
        "name": "Get Current Balance1",
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1,
        "position": [
          -1504,
          1376
        ],
        "id": "4961ca21-970f-492d-b305-b2610d3336a4",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// === CONFIGURACIÓN ===\nconst codeMap = {\n    \"40%PROFESOR\": \"monto_profesor_40\",\n    \"30%CLUB\": \"monto_club_30\",\n    \"25%EMPLEADO\": \"monto_empleado_25\"\n};\n\nconst rules = [\n  { threshold: 600, tagToRemove: \"DescuentoEmpleado\" },\n  { threshold: 1000, tagToRemove: \"DescuentoClub\" },\n  { threshold: 1200, tagToRemove: \"DescuentoProfesor\" }\n];\n\n// === DATOS DE ENTRADA ===\nconst processData = $('Code Unificador1').first().json; \nconst amount = processData.amountToProcess;\nconst codeUsed = processData.discountCode;\n\nconst customerData = $input.item.json.data.customer;\nconst customerId = customerData.id;\n\nconst getVal = (metafieldObj) => {\n    if (!metafieldObj || !metafieldObj.value) return 0;\n    try {\n        const parsed = JSON.parse(metafieldObj.value);\n        return parseFloat(parsed.amount);\n    } catch (e) {\n        return 0;\n    }\n};\n\n// === 1. CALCULAR MONTO TOTAL ===\n// (Acumula cualquier pedido con descuento, sea código o personalizado)\nlet currentTotal = getVal(customerData.total);\nlet newTotal = currentTotal + amount;\nif (newTotal < 0) newTotal = 0;\n\nlet metafieldsToUpdate = [];\n\n// Actualizar TOTAL\nmetafieldsToUpdate.push({\n    ownerId: customerId,\n    namespace: \"custom\",\n    key: \"monto_total\",\n    type: \"money\",\n    value: JSON.stringify({ amount: newTotal.toFixed(2), currency_code: \"EUR\" })\n});\n\n// === 2. CALCULAR MONTO ESPECÍFICO ===\n// (Solo si coincide el código string exacto)\nif (codeUsed && codeMap[codeUsed]) {\n    const specificKey = codeMap[codeUsed];\n    let currentSpecific = 0;\n    \n    if (codeUsed === \"40%PROFESOR\") currentSpecific = getVal(customerData.profesor);\n    else if (codeUsed === \"30%CLUB\") currentSpecific = getVal(customerData.club);\n    else if (codeUsed === \"25%EMPLEADO\") currentSpecific = getVal(customerData.empleado);\n    \n    let newSpecific = currentSpecific + amount;\n    if (newSpecific < 0) newSpecific = 0;\n\n    metafieldsToUpdate.push({\n        ownerId: customerId,\n        namespace: \"custom\",\n        key: specificKey,\n        type: \"money\",\n        value: JSON.stringify({ amount: newSpecific.toFixed(2), currency_code: \"EUR\" })\n    });\n}\n\n// === 3. GESTIÓN DE ETIQUETAS ===\nlet tagsToRemove = [];\nfor (const rule of rules) {\n    if (newTotal >= rule.threshold) {\n        tagsToRemove.push(rule.tagToRemove);\n    }\n}\n\nreturn {\n    json: {\n        customerId: customerId,\n        metafieldsToUpdate: metafieldsToUpdate,\n        tagsToRemove: tagsToRemove,\n        shouldRemoveTags: tagsToRemove.length > 0\n    }\n};"
        },
        "name": "Code Calculator1",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1280,
          1376
        ],
        "id": "1b8bd03a-39c9-4ec6-851e-306fc9eec61b"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
          "requestFormat": "json",
          "query": "mutation updateMetafields($metafields: [MetafieldsSetInput!]!) {\n  metafieldsSet(metafields: $metafields) {\n    metafields {\n      key\n      value\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={{ { \"metafields\": $json.metafieldsToUpdate } }}"
        },
        "name": "Update Balance1",
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1,
        "position": [
          -1056,
          1376
        ],
        "id": "441cfb48-0d9d-4403-9797-b74cc0f280ec",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "leftValue": "={{ $('Code Calculator1').item.json.shouldRemoveTags }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                },
                "id": "cd6e4c85-4d37-4c62-bd25-7ed5625c424e"
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "name": "Check Tags1",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -832,
          1376
        ],
        "id": "66f01a6d-e07d-4949-b148-53bf5452046f"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
          "requestFormat": "json",
          "query": "mutation removeCustomerTags($id: ID!, $tags: [String!]!) {\n  tagsRemove(id: $id, tags: $tags) {\n    userErrors {\n      field\n      message\n    }\n    node {\n      id\n    }\n  }\n}",
          "variables": "={{\n  {\n    \"id\": $('Code Calculator1').item.json.customerId,\n    \"tags\": $('Code Calculator1').item.json.tagsToRemove\n  }\n}}"
        },
        "name": "Remove Tags1",
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1,
        "position": [
          -608,
          1296
        ],
        "id": "d3a5382b-317e-41a7-8298-e660bb66d383",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -608,
          1488
        ],
        "id": "0d1a024e-1aaa-49a1-a085-55e9d67e95e8",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "e15f527b-54b1-4b5e-be43-2d09dfe005a4",
                "leftValue": "={{ $json.customerId }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -1744,
          1392
        ],
        "id": "44a004bc-871a-41cc-a3ec-50116c15db08",
        "name": "If"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -1504,
          1536
        ],
        "id": "65e5f3b5-b2ea-4207-bcd4-2069c9519464",
        "name": "No Operation, do nothing1"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
          "query": "query getOrderCompleteDetails($id: ID!) {\n  order(id: $id) {\n    id\n    name\n    createdAt\n    processedAt\n    displayFinancialStatus\n    displayFulfillmentStatus\n    tags\n    note\n    email\n    phone\n    sourceIdentifier\n    app {\n      name\n    }\n    \n    # 1. CLIENTE\n    customer {\n      id\n      firstName\n      lastName\n      email\n      numberOfOrders\n    }\n\n    # 2. DINERO Y TOTALES\n    currentSubtotalPriceSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    totalPriceSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    totalReceivedSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    totalDiscountsSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n\n    # DETALLE DE DESCUENTOS\n    discountApplications(first: 10) {\n      edges {\n        node {\n          targetSelection\n          allocationMethod\n          value {\n            ... on MoneyV2 {\n              amount\n              currencyCode\n            }\n            ... on PricingPercentageValue {\n              percentage\n            }\n          }\n          ... on DiscountCodeApplication {\n            code\n          }\n          ... on ManualDiscountApplication {\n            title\n            description\n          }\n          ... on AutomaticDiscountApplication {\n            title\n          }\n          ... on ScriptDiscountApplication {\n            title\n          }\n        }\n      }\n    }\n\n    # 3. LÍNEAS DE PRODUCTO\n    lineItems(first: 50) {\n      edges {\n        node {\n          id\n          title\n          variantTitle\n          sku\n          quantity\n          originalTotalSet {\n            shopMoney {\n              amount\n              currencyCode\n            }\n          }\n          variant {\n            id\n            price\n          }\n        }\n      }\n    }\n\n    # 4. CUMPLIMIENTOS (Fulfillments) - SECCIÓN CORREGIDA\n    fulfillments(first: 10) {\n      id\n      name\n      status\n      createdAt\n      # 'trackingCompany' eliminado. Ahora se pide dentro de trackingInfo:\n      trackingInfo {\n        company\n        number\n        url\n      }\n      location {\n        name\n      }\n      fulfillmentLineItems(first: 20) {\n        edges {\n          node {\n            quantity\n            lineItem {\n              title\n              variantTitle\n            }\n          }\n        }\n      }\n    }\n\n    # 5. DEVOLUCIONES (Refunds)\n    refunds(first: 10) {\n      id\n      createdAt\n      note\n      refundLineItems(first: 20) {\n        edges {\n          node {\n            quantity\n            lineItem {\n              title\n              variantTitle\n              sku\n            }\n            subtotalSet {\n              shopMoney {\n                amount\n                currencyCode\n              }\n            }\n          }\n        }\n      }\n    }\n\n    # 6. EVENTOS (Timeline)\n    events(first: 50) {\n      edges {\n        node {\n          id\n          message\n          createdAt\n        }\n      }\n    }\n  }\n}",
          "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $json.body.order_id }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          -2176,
          1248
        ],
        "id": "75217c5a-468f-49ce-8da2-f12e4026194f",
        "name": "GraphQL",
        "credentials": {
          "httpHeaderAuth": {
            "id": "THkhgrtze1uBo6Ft",
            "name": "Token Informes Shopify"
          }
        }
      }
    ],
    "connections": {
      "Webhook2": {
        "main": [
          [
            {
              "node": "Switch Topic1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch Topic1": {
        "main": [
          [
            {
              "node": "GraphQL",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Code Unificador1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code Unificador1": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Current Balance1": {
        "main": [
          [
            {
              "node": "Code Calculator1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code Calculator1": {
        "main": [
          [
            {
              "node": "Update Balance1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Balance1": {
        "main": [
          [
            {
              "node": "Check Tags1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Tags1": {
        "main": [
          [
            {
              "node": "Remove Tags1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "Get Current Balance1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL": {
        "main": [
          [
            {
              "node": "Code Unificador1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Tailwind Media",
    "name": "Version 12e5a58a",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "12e5a58a-68dc-4eea-a17b-f58ae1a9ed76",
  "connections": {
    "Webhook2": {
      "main": [
        [
          {
            "node": "Switch Topic1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Topic1": {
      "main": [
        [
          {
            "node": "GraphQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code Unificador1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Unificador1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Current Balance1": {
      "main": [
        [
          {
            "node": "Code Calculator1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Calculator1": {
      "main": [
        [
          {
            "node": "Update Balance1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Balance1": {
      "main": [
        [
          {
            "node": "Check Tags1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Tags1": {
      "main": [
        [
          {
            "node": "Remove Tags1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Get Current Balance1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL": {
      "main": [
        [
          {
            "node": "Code Unificador1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-26T09:47:12.180Z",
  "id": "8zLv7DpNHO5BT9ay",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Monto_Hibrido_Descuentos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "monto-descuentos",
        "options": {}
      },
      "name": "Webhook2",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -2608,
        1376
      ],
      "id": "37e24b67-a5c8-483d-9cbb-d6deb3bffc60",
      "webhookId": "7ffd809b-cd97-4781-bbac-1cd59c4cf3d4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.headers[\"x-shopify-topic\"] }}",
                    "rightValue": "refunds/create",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "05df5634-175d-4197-9602-04063623ac57"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.headers[\"x-shopify-topic\"] }}",
                    "rightValue": "orders/create",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "b7de8ecd-dbbe-4ba1-8cbf-a320b3f20ff8"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "name": "Switch Topic1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -2416,
        1376
      ],
      "id": "ad3ea731-07dc-45f4-ab7f-2fa1122403fb"
    },
    {
      "parameters": {
        "jsCode": "// ================================================================\n// 1. OBTENCIÓN ROBUSTA DE DATOS (WEBHOOK VS GRAPHQL)\n// ================================================================\nlet webhookNode;\nlet webhookBody;\nlet webhookHeaders;\n\ntry {\n    // Intentamos leer el nodo \"Webhook2\" explícitamente\n    if ($('Webhook2') && $('Webhook2').first()) {\n        webhookNode = $('Webhook2').first().json;\n    } else {\n        // Fallback: Si no se llama \"Webhook2\", usamos el primer input disponible\n        webhookNode = $input.all()[0].json;\n    }\n} catch (error) {\n    webhookNode = {};\n}\n\n// Normalización: Asegurar que tenemos headers y body disponibles\nif (webhookNode.headers && webhookNode.body) {\n    // Caso A: Venimos directo del Webhook\n    webhookHeaders = webhookNode.headers;\n    webhookBody = webhookNode.body;\n} else if ($input.item.json.headers && $input.item.json.body) {\n    // Caso B: El input actual conserva la estructura del webhook\n    webhookHeaders = $input.item.json.headers;\n    webhookBody = $input.item.json.body;\n} else {\n    // Caso C: Estamos tras el nodo GraphQL (\"Get Refund Customer1\").\n    // Aquí el $input es la respuesta de Shopify, así que forzamos la lectura del nodo Webhook2\n    // para recuperar las transacciones originales.\n    try {\n        const whSource = $('Webhook2').first().json;\n        webhookHeaders = whSource.headers;\n        webhookBody = whSource.body;\n    } catch(e) {\n        // Si todo falla, dejamos objetos vacíos para evitar crash, pero el flujo fallará lógicamente\n        webhookHeaders = {};\n        webhookBody = {};\n    }\n}\n\nconst topic = webhookHeaders[\"x-shopify-topic\"] || \"\";\nconst body = webhookBody || {};\n\n// Variables de salida\nlet customerId = \"\";\nlet amountToProcess = 0;\nlet discountCode = null;\n\n// ================================================================\n// 2. LÓGICA PRINCIPAL (PEDIDOS VS DEVOLUCIONES)\n// ================================================================\n\nif (topic.includes('orders/create')) {\n    // ------------------------------------------------------------\n    // CASO: NUEVO PEDIDO\n    // ------------------------------------------------------------\n    \n    // A. Obtener ID Cliente\n    if (body.customer && body.customer.admin_graphql_api_id) {\n        customerId = body.customer.admin_graphql_api_id;\n    }\n\n    // B. Detectar Descuento\n    if (body.discount_codes && body.discount_codes.length > 0) {\n        discountCode = body.discount_codes[0].code;\n    } else if (body.discount_applications && body.discount_applications.length > 0) {\n        discountCode = body.discount_applications[0].title;\n    }\n\n    // C. Calcular Monto (Solo si hubo descuento aplicado)\n    const totalDiscounts = parseFloat(body.total_discounts || \"0\");\n    if (totalDiscounts > 0) {\n        amountToProcess = parseFloat(body.total_price);\n    } else {\n        amountToProcess = 0;\n    }\n\n} else if (topic.includes('refunds/create')) {\n    // ------------------------------------------------------------\n    // CASO: DEVOLUCIÓN (REFUND)\n    // ------------------------------------------------------------\n\n    // A. Obtener datos enriquecidos desde GraphQL (Nodo anterior)\n    let orderData = null;\n    try {\n        orderData = $input.item.json.data ? $input.item.json.data.order : null;\n    } catch(e) {}\n    \n    // B. Obtener ID Cliente y Código del pedido original\n    if (orderData && orderData.customer) {\n         customerId = orderData.customer.id;\n         \n         if (orderData.discountCodes && orderData.discountCodes.length > 0) {\n             const codeItem = orderData.discountCodes[0];\n             discountCode = (typeof codeItem === 'string') ? codeItem : codeItem.code;\n         } \n    } else {\n         // Fallback de emergencia\n         customerId = body.order_id; \n    }\n\n    // C. CALCULAR MONTO A RESTAR (LÓGICA CRÍTICA \"FOLLOW THE MONEY\")\n    // Buscamos el array de transacciones financieras en el cuerpo del webhook.\n    const transactions = body.transactions || [];\n    \n    // Sumamos solo si hay dinero devuelto. \n    // Si transactions es [] (Cambio de Talla), el total será 0.\n    const totalRefunded = transactions.reduce((acc, curr) => {\n        return acc + parseFloat(curr.amount || 0);\n    }, 0);\n    \n    // Convertimos a negativo para restar del saldo acumulado\n    amountToProcess = -Math.abs(totalRefunded);\n}\n\n// ================================================================\n// 3. RETORNO FINAL\n// ================================================================\nreturn {\n    json: {\n        customerId: customerId,\n        amountToProcess: amountToProcess,\n        discountCode: discountCode\n    }\n};"
      },
      "name": "Code Unificador1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1952,
        1392
      ],
      "id": "c095aca7-cd13-45a4-92a7-86c98e6a5ea8"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "requestFormat": "json",
        "query": "query getCustomerMetafields($customerId: ID!) {\n  customer(id: $customerId) {\n    id\n    total: metafield(namespace: \"custom\", key: \"monto_total\") {\n      value\n    }\n    profesor: metafield(namespace: \"custom\", key: \"monto_profesor_40\") {\n      value\n    }\n    club: metafield(namespace: \"custom\", key: \"monto_club_30\") {\n      value\n    }\n    empleado: metafield(namespace: \"custom\", key: \"monto_empleado_25\") {\n      value\n    }\n  }\n}",
        "variables": "={\n  \"customerId\": \"{{ $json.customerId }}\"\n}"
      },
      "name": "Get Current Balance1",
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1,
      "position": [
        -1504,
        1376
      ],
      "id": "4961ca21-970f-492d-b305-b2610d3336a4",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// === CONFIGURACIÓN ===\nconst codeMap = {\n    \"40%PROFESOR\": \"monto_profesor_40\",\n    \"30%CLUB\": \"monto_club_30\",\n    \"25%EMPLEADO\": \"monto_empleado_25\"\n};\n\nconst rules = [\n  { threshold: 600, tagToRemove: \"DescuentoEmpleado\" },\n  { threshold: 1000, tagToRemove: \"DescuentoClub\" },\n  { threshold: 1200, tagToRemove: \"DescuentoProfesor\" }\n];\n\n// === DATOS DE ENTRADA ===\nconst processData = $('Code Unificador1').first().json; \nconst amount = processData.amountToProcess;\nconst codeUsed = processData.discountCode;\n\nconst customerData = $input.item.json.data.customer;\nconst customerId = customerData.id;\n\nconst getVal = (metafieldObj) => {\n    if (!metafieldObj || !metafieldObj.value) return 0;\n    try {\n        const parsed = JSON.parse(metafieldObj.value);\n        return parseFloat(parsed.amount);\n    } catch (e) {\n        return 0;\n    }\n};\n\n// === 1. CALCULAR MONTO TOTAL ===\n// (Acumula cualquier pedido con descuento, sea código o personalizado)\nlet currentTotal = getVal(customerData.total);\nlet newTotal = currentTotal + amount;\nif (newTotal < 0) newTotal = 0;\n\nlet metafieldsToUpdate = [];\n\n// Actualizar TOTAL\nmetafieldsToUpdate.push({\n    ownerId: customerId,\n    namespace: \"custom\",\n    key: \"monto_total\",\n    type: \"money\",\n    value: JSON.stringify({ amount: newTotal.toFixed(2), currency_code: \"EUR\" })\n});\n\n// === 2. CALCULAR MONTO ESPECÍFICO ===\n// (Solo si coincide el código string exacto)\nif (codeUsed && codeMap[codeUsed]) {\n    const specificKey = codeMap[codeUsed];\n    let currentSpecific = 0;\n    \n    if (codeUsed === \"40%PROFESOR\") currentSpecific = getVal(customerData.profesor);\n    else if (codeUsed === \"30%CLUB\") currentSpecific = getVal(customerData.club);\n    else if (codeUsed === \"25%EMPLEADO\") currentSpecific = getVal(customerData.empleado);\n    \n    let newSpecific = currentSpecific + amount;\n    if (newSpecific < 0) newSpecific = 0;\n\n    metafieldsToUpdate.push({\n        ownerId: customerId,\n        namespace: \"custom\",\n        key: specificKey,\n        type: \"money\",\n        value: JSON.stringify({ amount: newSpecific.toFixed(2), currency_code: \"EUR\" })\n    });\n}\n\n// === 3. GESTIÓN DE ETIQUETAS ===\nlet tagsToRemove = [];\nfor (const rule of rules) {\n    if (newTotal >= rule.threshold) {\n        tagsToRemove.push(rule.tagToRemove);\n    }\n}\n\nreturn {\n    json: {\n        customerId: customerId,\n        metafieldsToUpdate: metafieldsToUpdate,\n        tagsToRemove: tagsToRemove,\n        shouldRemoveTags: tagsToRemove.length > 0\n    }\n};"
      },
      "name": "Code Calculator1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        1376
      ],
      "id": "1b8bd03a-39c9-4ec6-851e-306fc9eec61b"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "requestFormat": "json",
        "query": "mutation updateMetafields($metafields: [MetafieldsSetInput!]!) {\n  metafieldsSet(metafields: $metafields) {\n    metafields {\n      key\n      value\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={{ { \"metafields\": $json.metafieldsToUpdate } }}"
      },
      "name": "Update Balance1",
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1,
      "position": [
        -1056,
        1376
      ],
      "id": "441cfb48-0d9d-4403-9797-b74cc0f280ec",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $('Code Calculator1').item.json.shouldRemoveTags }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "cd6e4c85-4d37-4c62-bd25-7ed5625c424e"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Check Tags1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -832,
        1376
      ],
      "id": "66f01a6d-e07d-4949-b148-53bf5452046f"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "requestFormat": "json",
        "query": "mutation removeCustomerTags($id: ID!, $tags: [String!]!) {\n  tagsRemove(id: $id, tags: $tags) {\n    userErrors {\n      field\n      message\n    }\n    node {\n      id\n    }\n  }\n}",
        "variables": "={{\n  {\n    \"id\": $('Code Calculator1').item.json.customerId,\n    \"tags\": $('Code Calculator1').item.json.tagsToRemove\n  }\n}}"
      },
      "name": "Remove Tags1",
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1,
      "position": [
        -608,
        1296
      ],
      "id": "d3a5382b-317e-41a7-8298-e660bb66d383",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -608,
        1488
      ],
      "id": "0d1a024e-1aaa-49a1-a085-55e9d67e95e8",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "e15f527b-54b1-4b5e-be43-2d09dfe005a4",
              "leftValue": "={{ $json.customerId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1744,
        1392
      ],
      "id": "44a004bc-871a-41cc-a3ec-50116c15db08",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1504,
        1536
      ],
      "id": "65e5f3b5-b2ea-4207-bcd4-2069c9519464",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "query": "query getOrderCompleteDetails($id: ID!) {\n  order(id: $id) {\n    id\n    name\n    createdAt\n    processedAt\n    displayFinancialStatus\n    displayFulfillmentStatus\n    tags\n    note\n    email\n    phone\n    sourceIdentifier\n    app {\n      name\n    }\n    \n    # 1. CLIENTE\n    customer {\n      id\n      firstName\n      lastName\n      email\n      numberOfOrders\n    }\n\n    # 2. DINERO Y TOTALES\n    currentSubtotalPriceSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    totalPriceSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    totalReceivedSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    totalDiscountsSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n\n    # DETALLE DE DESCUENTOS\n    discountApplications(first: 10) {\n      edges {\n        node {\n          targetSelection\n          allocationMethod\n          value {\n            ... on MoneyV2 {\n              amount\n              currencyCode\n            }\n            ... on PricingPercentageValue {\n              percentage\n            }\n          }\n          ... on DiscountCodeApplication {\n            code\n          }\n          ... on ManualDiscountApplication {\n            title\n            description\n          }\n          ... on AutomaticDiscountApplication {\n            title\n          }\n          ... on ScriptDiscountApplication {\n            title\n          }\n        }\n      }\n    }\n\n    # 3. LÍNEAS DE PRODUCTO\n    lineItems(first: 50) {\n      edges {\n        node {\n          id\n          title\n          variantTitle\n          sku\n          quantity\n          originalTotalSet {\n            shopMoney {\n              amount\n              currencyCode\n            }\n          }\n          variant {\n            id\n            price\n          }\n        }\n      }\n    }\n\n    # 4. CUMPLIMIENTOS (Fulfillments) - SECCIÓN CORREGIDA\n    fulfillments(first: 10) {\n      id\n      name\n      status\n      createdAt\n      # 'trackingCompany' eliminado. Ahora se pide dentro de trackingInfo:\n      trackingInfo {\n        company\n        number\n        url\n      }\n      location {\n        name\n      }\n      fulfillmentLineItems(first: 20) {\n        edges {\n          node {\n            quantity\n            lineItem {\n              title\n              variantTitle\n            }\n          }\n        }\n      }\n    }\n\n    # 5. DEVOLUCIONES (Refunds)\n    refunds(first: 10) {\n      id\n      createdAt\n      note\n      refundLineItems(first: 20) {\n        edges {\n          node {\n            quantity\n            lineItem {\n              title\n              variantTitle\n              sku\n            }\n            subtotalSet {\n              shopMoney {\n                amount\n                currencyCode\n              }\n            }\n          }\n        }\n      }\n    }\n\n    # 6. EVENTOS (Timeline)\n    events(first: 50) {\n      edges {\n        node {\n          id\n          message\n          createdAt\n        }\n      }\n    }\n  }\n}",
        "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $json.body.order_id }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        -2176,
        1248
      ],
      "id": "75217c5a-468f-49ce-8da2-f12e4026194f",
      "name": "GraphQL",
      "credentials": {
        "httpHeaderAuth": {
          "id": "THkhgrtze1uBo6Ft",
          "name": "Token Informes Shopify"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-01-26T09:47:12.184Z",
      "createdAt": "2026-01-26T09:47:12.184Z",
      "role": "workflow:owner",
      "workflowId": "8zLv7DpNHO5BT9ay",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-02-05T13:49:52.607Z",
  "versionId": "12e5a58a-68dc-4eea-a17b-f58ae1a9ed76"
}