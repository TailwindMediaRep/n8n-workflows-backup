{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-02-09T09:55:35.000Z",
    "createdAt": "2026-02-09T09:55:34.022Z",
    "versionId": "df2fe689-b537-4f92-9e34-917bde686457",
    "workflowId": "qYqXKqcZ774d2bpa",
    "nodes": [
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "months",
                "triggerAtHour": 5
              }
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.1,
        "position": [
          -1952,
          336
        ],
        "id": "ba278eca-b5c0-42c2-b2d7-1cb4eb28ad14",
        "name": "Inicio de Mes (Día 1)"
      },
      {
        "parameters": {
          "operation": "copy",
          "fileId": {
            "__rl": true,
            "value": "1yCvIQHJhAdzdoRBuiEodGI2Dh0eUD9K7SImZgr8Hq1k",
            "mode": "id"
          },
          "name": "=PRUEBAPRUEBAPRUEBAPRUEBA COMPLETO - {{ $json.NOMBRE_MES }}",
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          -1616,
          608
        ],
        "id": "8916f4e2-0878-4287-90a8-ea2845be9296",
        "name": "Crear Informe Maestro",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "N7JXWgOiVoyCTaVL",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "8GDVj673ag0hCrVt",
            "mode": "list",
            "cachedResultName": "Informe Mensual"
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          -1264,
          368
        ],
        "id": "da0a4e1a-bf85-45ae-9403-8f89aaa615ba",
        "name": "Obtener Informes Diarios"
      },
      {
        "parameters": {
          "jsCode": "// Lógica de limpieza original + Agrupación de Top Productos\nconst inputItems = items;\nconst uniqueStrings = new Set();\nconst uniqueItems = [];\nconst productCounts = {};\n\n// 1. Limpieza de duplicados\nfor (const item of inputItems) {\n    const itemString = JSON.stringify(item.json);\n    if (!uniqueStrings.has(itemString)) {\n        uniqueStrings.add(itemString);\n        uniqueItems.push(item);\n        \n        // 2. Contar para Ranking\n        const prodName = item.json['NOMBRE DE PRODUCTO'];\n        if(prodName && prodName !== 'SEPARADOR') {\n             if(!productCounts[prodName]) productCounts[prodName] = 0;\n             productCounts[prodName]++;\n        }\n    }\n}\n\nreturn uniqueItems;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1056,
          368
        ],
        "id": "e27b3624-d883-4b1d-bddc-7934b890fc06",
        "name": "Limpiar y Analizar Productos"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "url_shopify",
                "name": "url_proxima",
                "value": "=https://rulesshop.myshopify.com/admin/api/2025-01/orders.json?limit=250&status=any&created_at_min={{ $('Configurar Fechas').item.json.FECHA_INICIO }}&created_at_max={{ $('Configurar Fechas').item.json.FECHA_FIN }}&fields=id,name,total_price,user_id",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1264,
          848
        ],
        "id": "e5411988-7c02-483e-8420-ac2e12aa615a",
        "name": "Prep Shopify"
      },
      {
        "parameters": {
          "url": "={{ $json.url_proxima }}",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -1088,
          848
        ],
        "id": "518b3741-7d29-4729-be2c-b78172a14a40",
        "name": "Shopify API",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "cond_link",
                "leftValue": "={{ $('Shopify API').item.json.headers.link }}",
                "rightValue": "next",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -768,
          848
        ],
        "id": "6f1925d2-06f9-4916-8223-0d748ee25c76",
        "name": "Hay más páginas?"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "next_url",
                "name": "url_proxima",
                "value": "={{ $json.headers.link.match(/<([^>]+)>;\\s*rel=\"next\"/)[1] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -608,
          832
        ],
        "id": "b24e5b37-3f22-4b3e-842f-12c4cafad8d5",
        "name": "Set Next Page"
      },
      {
        "parameters": {
          "jsCode": "const staticData = $getWorkflowStaticData('global');\nconst listaAcumulada = staticData.listaTemporal || [];\nconst nuevosPedidos = $('Shopify API').item.json.body.orders || [];\nconst listaCompleta = listaAcumulada.concat(nuevosPedidos);\nstaticData.listaTemporal = [];\nreturn listaCompleta.map(p => ({ json: p }));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -576,
          1040
        ],
        "id": "a5e7501f-ad93-43b6-bb94-2dd14abcadc0",
        "name": "Unir Todos los Pedidos"
      },
      {
        "parameters": {
          "jsCode": "const staticData = $getWorkflowStaticData('global');\nif (!staticData.listaTemporal) staticData.listaTemporal = [];\n\n// 1. Capturamos los datos de entrada (incluidos los encabezados/headers)\n// Usamos items[0] porque en n8n v1+ items es el array de entrada\nconst inputData = items[0].json;\nconst pedidos = inputData.body.orders;\n\n// 2. Guardamos los pedidos en la mochila\nstaticData.listaTemporal.push(...pedidos);\n\n// 3. ¡IMPORTANTE! Devolvemos los 'headers' hacia afuera.\n// Así el siguiente nodo podrá leer el link de la página siguiente.\nreturn {\n  json: {\n    status: 'accumulating',\n    headers: inputData.headers\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -928,
          848
        ],
        "id": "02bcc516-97d5-4773-a875-6c174ef083b0",
        "name": "Acumular en Memoria"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Crear Informe Maestro').first().json.id }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Bonos Empleados",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.numero_fila }}",
              "BONOS INDIVIDUALES": "={{ $json[\"Nombre Empleado\"] }}",
              "TOTAL VENDIDO": "={{ $json[\"Total Vendido\"] }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "BONOS INDIVIDUALES",
                "displayName": "BONOS INDIVIDUALES",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL VENDIDO",
                "displayName": "TOTAL VENDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "BONO 90€",
                "displayName": "BONO 90€",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "BONO 120€",
                "displayName": "BONO 120€",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "BONO 150€",
                "displayName": "BONO 150€",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "BONO 200€",
                "displayName": "BONO 200€",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          112,
          1056
        ],
        "id": "e5203c4f-7924-48e3-a64d-d34d119ef791",
        "name": "Escribir Empleados",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "content": "RUTA 1: VENTAS\nEl ID del archivo viene del nodo principal, así que ahora podemos escribir directamente.",
          "height": 140,
          "width": 304,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1264,
          224
        ],
        "id": "3a549215-5258-40d6-9eb8-ad59dcda8c59",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "RUTA 2: BONOS\nShopify procesa todo y al final escribe en el archivo creado al principio.",
          "height": 140,
          "width": 304,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1296,
          640
        ],
        "id": "204f972e-72a4-4184-b598-714928a95083",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -640,
          368
        ],
        "id": "b7320c16-4c2d-4328-a3c4-cd6225d9c362",
        "name": "Bucle: Uno a Uno"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Crear Informe Maestro').first().json.id }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Top Productos",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.fila_excel }}",
              "NOMBRE PRODUCTO": "={{ $json.Producto }}",
              "VARIANTE": "={{ $json.Variante }}",
              "PRECIO": "={{ $json.Precio }}",
              "UNIDADES VENDIDAS": "={{ $json.Unidades }}",
              "TOTAL": "={{ $json.Total }}",
              "TICKETS VENDIDOS": "={{ $json.Skatepark_Entradas_Vendidas }}",
              "PRECIO TOTAL": "={{ $json.Skatepark_Ingresos_Totales }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "VARIANTE",
                "displayName": "VARIANTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO",
                "displayName": "PRECIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "UNIDADES VENDIDAS",
                "displayName": "UNIDADES VENDIDAS",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL",
                "displayName": "TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TICKETS VENDIDOS",
                "displayName": "TICKETS VENDIDOS",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO TOTAL",
                "displayName": "PRECIO TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          416,
          32
        ],
        "id": "e719c9c9-c485-4d34-86da-a51e868ef63b",
        "name": "Escribir detalle",
        "alwaysOutputData": false,
        "executeOnce": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "={{ $json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Hoja 1",
            "mode": "name"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -448,
          432
        ],
        "id": "715c3b3f-0444-435f-ac20-8188d186e39d",
        "name": "Leer Informe de ese Día",
        "alwaysOutputData": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "id_fecha",
                "name": "NOMBRE_MES",
                "value": "={{ $today.minus({months: 1}).setLocale('es').format('MMMM').toUpperCase() }}",
                "type": "string"
              },
              {
                "id": "id_rango_inicio",
                "name": "FECHA_INICIO",
                "value": "={{ $today.minus({months: 1}).startOf('month').format('yyyy-MM-dd') }}T00:00:00Z",
                "type": "string"
              },
              {
                "id": "id_rango_fin",
                "name": "FECHA_FIN",
                "value": "={{ $today.minus({months: 1}).endOf('month').format('yyyy-MM-dd') }}T23:59:59Z",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1792,
          608
        ],
        "id": "b214af46-3394-4866-bbe1-53422bd52f0d",
        "name": "Configurar Fechas"
      },
      {
        "parameters": {
          "jsCode": "// 1. Recuperamos la lista de pedidos (Input)\nconst orders = items.map(item => item.json);\n\n// 2. Diccionario de Nombres\nconst employeeMap = {\n    \"126641570139\": \"Arturo Fernandez Caballero\",\n    \"126890148187\": \"Sandra Rogel Aguilera\",\n    \"126889361755\": \"Alejandro Pavon\",\n    \"127346573659\": \"Facundo Altamirano Pozzi\",\n    \"127144952155\": \"Jose Maria Restoy Varela\",\n    \"126790828379\": \"Florencia cielo Alarcon\",\n    \"115464700251\": \"Miguel Navarro\",\n    \"126641602907\": \"Eugenia La Piettra\",\n    \"126759141723\": \"Lorenzo Jimenez\",\n    \"127472533851\": \"Pablo roldan\",\n    \"127149113691\": \"Facundo Pereira\",\n    \"127346606427\": \"Nerea Fernández\",\n    \"125804478811\": \"Anabel Labella\",\n    \"127578997083\": \"Cesar Moreno\",\n    \"126889165147\": \"Julio Hermoso Fernández\",\n    \"126766121307\": \"Unai Rodríguez Alarcón\",\n    \"127048155483\": \"Gerardo Cairo\",\n    \"126888640859\": \"Facundo Altamirano Pozzi\",\n    \"123965866331\": \"Thomas Fontoura\",\n    \"126895620443\": \"Fabio Cortés Martín\",\n    \"126953292123\": \"Carlota Ramirez Palacios\",\n    \"126905516379\": \"André Ferreira\", \n    \"126888149339\": \"Alejandro Vasallo Bancalero\",\n    \"126905123163\": \"Ana Isabel Robles González\",\n    \"127310987611\": \"Paula Perez\",\n    \"114932875611\": \"Emiliano Martinez Verdecchia\",\n    \"125110976859\": \"Adrián Azorín\",\n    \"127346704731\": \"Rober Alonso\",\n    \"114884346203\": \"Lorena Verdecchia\",\n    \"126812389723\": \"Cuenta Multiusuario\",\n    \"115083706715\": \"Antonio Gabriel Lopez Moreno\"\n};\n\n// Objeto para acumular las ventas por ID\nconst salesSummary = {};\n\n// 3. Bucle para SUMAR ventas\nfor (const order of orders) {\n    const userId = order.user_id;\n    if (!userId) continue;\n\n    let price = parseFloat(order.total_price);\n    if (isNaN(price)) price = 0;\n\n    if (salesSummary[userId]) {\n        salesSummary[userId] += price;\n    } else {\n        salesSummary[userId] = price;\n    }\n}\n\n// 4. Transformar a lista temporal\nlet tempResults = [];\nfor (const [id, total] of Object.entries(salesSummary)) {\n    const nombre = employeeMap[id] || \"Desconocido (\" + id + \")\";\n    tempResults.push({\n        nombre: nombre,\n        total: parseFloat(total.toFixed(2))\n    });\n}\n\n// 5. Ordenar de mayor a menor venta\ntempResults.sort((a, b) => b.total - a.total);\n\n// 6. Generar JSON final con NUMERO DE FILA ACTUALIZADO\nconst finalResults = tempResults.map((item, index) => {\n    return {\n        json: {\n            \"numero_fila\": index + 31, // <--- Ahora empieza en 30\n            \"Nombre Empleado\": item.nombre,\n            \"Total Vendido\": item.total\n        }\n    };\n});\n\nreturn finalResults;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -224,
          1040
        ],
        "id": "b3531d9c-b6d2-447e-8f39-14124207a8a3",
        "name": "Calcular Ranking Empleados"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Crear Informe Maestro').first().json.id }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Top Productos",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.fila_excel }}",
              "NOMBRE PRODUCTO": "=",
              "VARIANTE": "=",
              "PRECIO": "={{ $json.Marca }}",
              "UNIDADES VENDIDAS": "={{ $json.Unidades }}",
              "TOTAL": "={{ $json.Total }}",
              "TICKETS VENDIDOS": "=",
              "PRECIO TOTAL": "="
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "VARIANTE",
                "displayName": "VARIANTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO",
                "displayName": "PRECIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "UNIDADES VENDIDAS",
                "displayName": "UNIDADES VENDIDAS",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL",
                "displayName": "TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TICKETS VENDIDOS",
                "displayName": "TICKETS VENDIDOS",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO TOTAL",
                "displayName": "PRECIO TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          416,
          176
        ],
        "id": "897d3242-f971-4099-9e99-57f654a990b9",
        "name": "Escribir marcas",
        "alwaysOutputData": false,
        "executeOnce": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "KvNMRefeRetJtcGA",
            "mode": "list",
            "cachedResultName": "marcas_summit",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/KvNMRefeRetJtcGA"
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -128,
          176
        ],
        "id": "db96fd26-93bc-4607-a88d-9250030054ed",
        "name": "Tabla Marcas"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Crear Informe Maestro').first().json.id }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Top Productos",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.fila_excel }}",
              "NOMBRE PRODUCTO": "=",
              "VARIANTE": "=",
              "PRECIO": "={{ $json.Sucursal }}",
              "UNIDADES VENDIDAS": "={{ $json.Transacciones }}",
              "TOTAL": "={{ $json.Total }}",
              "TICKETS VENDIDOS": "=",
              "PRECIO TOTAL": "="
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "VARIANTE",
                "displayName": "VARIANTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO",
                "displayName": "PRECIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "UNIDADES VENDIDAS",
                "displayName": "UNIDADES VENDIDAS",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL",
                "displayName": "TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TICKETS VENDIDOS",
                "displayName": "TICKETS VENDIDOS",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO TOTAL",
                "displayName": "PRECIO TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          624,
          320
        ],
        "id": "45fa8839-fbd2-4465-80a2-d6434cd645ae",
        "name": "Escribir sucursales",
        "alwaysOutputData": false,
        "executeOnce": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "batchSize": 10,
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -48,
          1040
        ],
        "id": "eb786408-7b2c-4450-aeb3-9247cdd563d1",
        "name": "Loop Over Items"
      },
      {
        "parameters": {
          "jsCode": "// 1. CONFIGURACIÓN Y DATOS\nconst staticData = $getWorkflowStaticData('global');\nconst allSales = staticData.allProducts || [];\n\nif (allSales.length === 0) {\n    return [{ json: { mensaje: \"⚠️ Ejecuta el bucle primero.\" } }];\n}\n\n// NORMALIZACIÓN DE MARCAS: Limpiamos espacios y pasamos a MAYÚSCULAS\nconst LISTA_MARCAS = items\n    .map(item => (item.json['Nombre_del_Proveedor'] || '').toString().trim().toUpperCase())\n    .filter(marca => marca.length > 1);\n\n// Ordenamos por longitud de mayor a menor para evitar que \"NIKE\" se coma a \"NIKE SB\"\nLISTA_MARCAS.sort((a, b) => b.length - a.length);\n\n// Contenedores\nconst productStats = {};\nconst brandStats = {};\nconst branchStats = {};\n\n// Configuración Skatepark\nlet skateparkCount = 0;\nlet skateparkRevenue = 0;\nconst SKATEPARK_NAME = \"TICKET ENTRADA SKATEPARK\";\nconst FILA_SUCURSALES = 26; \n\n// 2. PROCESAMIENTO ÚNICO (Con Normalización)\nfor (const sale of allSales) {\n    // --- LA REGLA DE ORO: NORMALIZACIÓN ---\n    // Convertimos a texto, quitamos espacios fantasma y pasamos a MAYÚSCULAS\n    const productName = (sale['NOMBRE DE PRODUCTO'] || \"SIN NOMBRE\").toString().trim().toUpperCase();\n    const branchName = (sale['SUCURSAL DE VENTA'] || \"N/A\").toString().trim().toUpperCase();\n    const variantOriginal = (sale['VARIANTE'] || '').toString().trim(); \n    const variantKey = variantOriginal.toUpperCase(); \n\n    // Limpieza números (mantienes tu lógica original que estaba perfecta)\n    let priceStr = (sale['PRECIO PAGADO'] || '0').toString();\n    let costStr = (sale['COSTE DE PRODUCTO'] || '0').toString();\n    let unitPriceStr = (sale['PRECIO DE PRODUCTO'] || '0').toString();\n    \n    const paidPrice = parseFloat(priceStr.replace(',', '.')) || 0;\n    const cost = parseFloat(costStr.replace(',', '.')) || 0;\n    const listPrice = parseFloat(unitPriceStr.replace(',', '.')) || 0;\n\n    // Lógica Skatepark (buscamos en el nombre ya en mayúsculas)\n    if (productName.includes(SKATEPARK_NAME)) {\n        skateparkCount += 1;\n        skateparkRevenue += paidPrice;\n        continue; \n    }\n\n    if (productName !== \"SIN NOMBRE\") {\n        // A) PRODUCTOS\n        const prodKey = `${productName} - ${variantKey}`;\n        \n        if (!productStats[prodKey]) {\n            productStats[prodKey] = {\n                Producto: productName, \n                Variante: variantOriginal, // Guardamos la original para que quede bonita en el Excel\n                Precio: listPrice,\n                Ventas: 0, Unidades: 0, Beneficio: 0\n            };\n        }\n        productStats[prodKey].Ventas += paidPrice;\n        productStats[prodKey].Unidades += 1;\n        productStats[prodKey].Beneficio += (paidPrice - cost);\n\n        // B) MARCAS\n        let detectedBrand = \"OTRAS\"; // Usamos mayúsculas por consistencia\n        \n        for (const marca of LISTA_MARCAS) {\n            // Si la marca es un número (ej. \"686\"), usamos Regex de coincidencia exacta\n            if (!isNaN(marca)) {\n                const regex = new RegExp(`\\\\b${marca}\\\\b`);\n                if (regex.test(productName)) {\n                    detectedBrand = marca;\n                    break;\n                }\n            } else {\n                // Si es texto normal\n                if (productName.includes(marca)) {\n                    detectedBrand = marca;\n                    break;\n                }\n            }\n        }\n\n        // Parche manual para The North Face (buscando en mayúsculas)\n        if (detectedBrand === \"OTRAS\" && (productName.includes(\"NORTH FACE\") || productName.includes(\" TNF \"))) {\n            detectedBrand = \"THE NORTH FACE\";\n        }\n\n        if (!brandStats[detectedBrand]) {\n            brandStats[detectedBrand] = { Marca: detectedBrand, Ventas: 0, Unidades: 0 };\n        }\n        brandStats[detectedBrand].Ventas += paidPrice;\n        brandStats[detectedBrand].Unidades += 1;\n    }\n\n    // C) SUCURSALES\n    if (branchName !== \"N/A\" && branchName !== \"\") {\n        if (!branchStats[branchName]) {\n            branchStats[branchName] = { Sucursal: branchName, Ventas: 0, Transacciones: 0 };\n        }\n        branchStats[branchName].Ventas += paidPrice;\n        branchStats[branchName].Transacciones += 1;\n    }\n}\n\n// 3. GENERAR RESULTADOS (TOP 10 y demás lógica original)\nconst finalOutput = [];\n\n// --- PRODUCTOS ---\nconst sortedProds = Object.values(productStats).sort((a, b) => \n    b.Unidades !== a.Unidades ? b.Unidades - a.Unidades : b.Ventas - a.Ventas\n).slice(0, 10);\n\nsortedProds.forEach((p, i) => {\n    const item = {\n        tipo: \"producto\",\n        fila_excel: i + 2,\n        Producto: p.Producto,\n        Variante: p.Variante,\n        Precio: parseFloat(p.Precio.toFixed(2)),\n        Unidades: p.Unidades,\n        Total: parseFloat(p.Ventas.toFixed(2)),\n        Beneficio: parseFloat(p.Beneficio.toFixed(2))\n    };\n    if (i === 0) {\n        item.Skatepark_Entradas_Vendidas = skateparkCount;\n        item.Skatepark_Ingresos_Totales = parseFloat(skateparkRevenue.toFixed(2));\n    }\n    finalOutput.push({ json: item });\n});\n\n// --- MARCAS ---\nconst sortedBrands = Object.values(brandStats)\n    .filter(b => b.Marca !== \"OTRAS\")\n    .sort((a, b) => b.Unidades !== a.Unidades ? b.Unidades - a.Unidades : b.Ventas - a.Ventas)\n    .slice(0, 10);\n\nsortedBrands.forEach((b, i) => {\n    finalOutput.push({\n        json: {\n            tipo: \"marca\",\n            fila_excel: i + 14, \n            Marca: b.Marca,\n            Unidades: b.Unidades,\n            Total: parseFloat(b.Ventas.toFixed(2))\n        }\n    });\n});\n\n// --- SUCURSALES ---\nconst sortedBranches = Object.values(branchStats).sort((a, b) => b.Ventas - a.Ventas);\n\nsortedBranches.forEach((b, i) => {\n    finalOutput.push({\n        json: {\n            tipo: \"sucursal\",\n            fila_excel: i + FILA_SUCURSALES, \n            Sucursal: b.Sucursal,\n            Transacciones: b.Transacciones,\n            Total: parseFloat(b.Ventas.toFixed(2))\n        }\n    });\n});\n\n// 4. LIMPIEZA FINAL\nstaticData.allProducts = [];\n\nreturn finalOutput;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          32,
          176
        ],
        "id": "c209e694-cb8f-4f98-97d6-a3615a3b4f24",
        "name": "Calculo_Maestro"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.tipo }}",
                      "rightValue": "producto",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "e3281762-2b3c-41e1-bcd5-6d1e82e10c0d"
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "bd5f0dee-b77a-43e9-a0d6-b1df7ccd262c",
                      "leftValue": "={{ $json.tipo }}",
                      "rightValue": "marca",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "395d8bc3-96de-4d5b-be62-bec164fe3c72",
                      "leftValue": "={{ $json.tipo }}",
                      "rightValue": "sucursal",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          192,
          160
        ],
        "id": "c8b2be2b-d78b-4c9c-bb18-568b645a8124",
        "name": "Elegir tipo de input"
      },
      {
        "parameters": {
          "content": "COPIA DE LA PLANTILLA\n",
          "height": 192,
          "width": 528,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -2000,
          576
        ],
        "id": "54f3936a-7187-4043-aa2a-4ab0c2f00674",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "content": "ESCRIBIR EN EL ARCHIVO\n",
          "height": 512,
          "width": 160,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          592,
          -32
        ],
        "id": "79c5364e-a76f-41a8-a1e2-19c333fa6e0d",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "content": "HACER LOS CÁLCULOS CON LA INFORMACIÓN DE LOS INFORMES DIARIOS\n",
          "height": 224,
          "width": 528,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          48,
          112
        ],
        "id": "34ecc7f4-0731-40bc-bdc8-cf008a10aadf",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "jsCode": "// --- TU LÓGICA DE LIMPIEZA (NO TOCAR) ---\nconst allItems = $input.all();\nconst columnasAceptadas = [\n  \"row_number\", \"SUCURSAL DE VENTA\", \"MÉTODO DE PAGO\", \n  \"COSTE POR UNIDAD\", \"PRECIO DE PRODUCTO\", \"PRECIO PAGADO\", \n  \"DESCUENTO\", \"NOMBRE DE PRODUCTO\", \"VARIANTE\"\n];\n\nconst itemsLimpios = allItems\n  .map(item => item.json)\n  .filter(data => data[\"NOMBRE DE PRODUCTO\"] && data[\"NOMBRE DE PRODUCTO\"].toString().trim() !== \"\")\n  .map(data => {\n    let nuevoObjeto = {};\n    columnasAceptadas.forEach(col => nuevoObjeto[col] = data[col]);\n    return nuevoObjeto;\n  });\n\n// --- PARTE NUEVA: ACUMULAR EN MEMORIA GLOBAL ---\n\n// 1. Accedemos a la memoria global\nconst staticData = $getWorkflowStaticData('global');\n\n// 2. DETECTAMOS SI ES LA PRIMERA VUELTA DEL BUCLE\n// Usamos el nombre exacto de tu nodo SplitInBatches: \"Bucle: Uno a Uno\"\n// Si el índice es 0, significa que el bucle acaba de empezar -> Limpiamos la bolsa\nif ($node[\"Bucle: Uno a Uno\"].runIndex === 0) {\n    staticData.misItemsGuardados = [];\n}\n\n// 3. Aseguramos que el array existe\nif (!staticData.misItemsGuardados) {\n    staticData.misItemsGuardados = [];\n}\n\n// 4. Guardamos los items de ESTA vuelta en la bolsa común\nif (itemsLimpios.length > 0) {\n    staticData.misItemsGuardados.push(...itemsLimpios);\n}\n\n// Devolvemos los datos procesados para que el flujo siga\nreturn { processed: true, count: itemsLimpios.length };"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -256,
          432
        ],
        "id": "0566c206-7b5a-4e3d-8278-a300db2b6a6a",
        "name": "Acumular en memoria"
      },
      {
        "parameters": {
          "content": "LEER LOS INFORMES DIARIOS DE TODO EL MES\n",
          "height": 288,
          "width": 784,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -704,
          336
        ],
        "id": "0a7df961-56a6-4e5d-a97b-eb7ba5c6bd0d",
        "name": "Sticky Note5"
      },
      {
        "parameters": {
          "content": "ESCRIBIR EN EL ARCHIVO\n",
          "height": 192,
          "width": 336,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -96,
          1008
        ],
        "id": "0aeb0ec2-4e5d-4c51-80c8-7d9481f5a459",
        "name": "Sticky Note6"
      },
      {
        "parameters": {
          "content": "LEER INFORMACIÓN DE LOS EMPLEADOS EN SHOPIFY\n",
          "height": 400,
          "width": 992,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1296,
          784
        ],
        "id": "9eb648e0-0ffb-4d9c-b3c1-616e633836df",
        "name": "Sticky Note7"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [
          -2224,
          608
        ],
        "id": "e51c40f8-a227-4f9c-b137-75968f2de83e",
        "name": "When clicking ‘Execute workflow’"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "bad4145c-a3f9-4296-9b75-e9e61b7dd389",
                "name": "row_number",
                "value": "={{ $json.row_number }}",
                "type": "number"
              },
              {
                "id": "4e122c68-7526-4f4d-9b69-85dbab87f1ee",
                "name": "ID PEDIDO",
                "value": "={{ $json[\"ID PEDIDO\"] }}",
                "type": "number"
              },
              {
                "id": "eac9c408-338c-47f3-b984-9e1827bc21da",
                "name": "SUCURSAL DE VENTA",
                "value": "={{ $json[\"SUCURSAL DE VENTA\"] }}",
                "type": "string"
              },
              {
                "id": "8a4c4a70-2652-4d3b-b122-620f3069e408",
                "name": "MÉTODO DE PAGO",
                "value": "={{ $json[\"MÉTODO DE PAGO\"] }}",
                "type": "string"
              },
              {
                "id": "06e472a9-5941-4f37-be43-3b3fdeace260",
                "name": "COSTE POR UNIDAD",
                "value": "={{ $json[\"COSTE POR UNIDAD\"] }}",
                "type": "string"
              },
              {
                "id": "75e6dd83-a1ed-48ff-a468-9c7dfb1ce315",
                "name": "PRECIO DE PRODUCTO",
                "value": "={{ $json[\"PRECIO DE PRODUCTO\"] }}",
                "type": "string"
              },
              {
                "id": "1caa6898-22d0-4133-b537-2866221affea",
                "name": "PRECIO PAGADO",
                "value": "={{ $json[\"PRECIO PAGADO\"] }}",
                "type": "string"
              },
              {
                "id": "14b9324f-1569-4a39-a4f9-25df8e645089",
                "name": "DESCUENTO",
                "value": "={{ $json.DESCUENTO }}",
                "type": "string"
              },
              {
                "id": "c7841413-e5cb-4a32-a802-e8167a0968fc",
                "name": "NOMBRE DE PRODUCTO",
                "value": "={{ $json[\"NOMBRE DE PRODUCTO\"] }}",
                "type": "string"
              },
              {
                "id": "0bb512b8-8f4f-482d-a218-6d6ad154e388",
                "name": "VARIANTE",
                "value": "={{ $json.VARIANTE }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          32,
          704
        ],
        "id": "e019d66f-62e8-4243-8f76-05626c049638",
        "name": "Edit Fields",
        "executeOnce": false
      },
      {
        "parameters": {
          "amount": 10
        },
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          -80,
          432
        ],
        "id": "28d6ad39-a80e-4fd9-a5eb-df2466e8b96f",
        "name": "Espera 1s",
        "webhookId": "57665f85-f34c-4a9b-81e3-71d620974b94"
      },
      {
        "parameters": {
          "jsCode": "// Accedemos a la memoria global del workflow\nconst staticData = getWorkflowStaticData('global');\n\n// La limpiamos por si quedó basura de una ejecución anterior fallida\nstaticData.misItemsAcumulados = [];\n\nreturn { status: \"Memoria Limpia\" };"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -2128,
          288
        ],
        "id": "83db026a-74cf-496c-b945-9e2d9bece458",
        "name": "iniciar memoria"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a la misma memoria global\nconst staticData = $getWorkflowStaticData('global');\n\n// 2. Sacamos todo lo que fuimos guardando vuelta a vuelta\nconst todosLosItems = staticData.misItemsGuardados || [];\n\n// 3. ¡Listo! Aquí tienes tus 600 items\nreturn todosLosItems;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -464,
          144
        ],
        "id": "c53daf0e-4785-4887-8415-45a4af841923",
        "name": "juntar datos"
      }
    ],
    "connections": {
      "Inicio de Mes (Día 1)": {
        "main": [
          []
        ]
      },
      "Crear Informe Maestro": {
        "main": [
          [
            {
              "node": "Obtener Informes Diarios",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Obtener Informes Diarios": {
        "main": [
          [
            {
              "node": "Limpiar y Analizar Productos",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Limpiar y Analizar Productos": {
        "main": [
          [
            {
              "node": "Bucle: Uno a Uno",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prep Shopify": {
        "main": [
          [
            {
              "node": "Shopify API",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Shopify API": {
        "main": [
          [
            {
              "node": "Acumular en Memoria",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Hay más páginas?": {
        "main": [
          [
            {
              "node": "Set Next Page",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Unir Todos los Pedidos",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Next Page": {
        "main": [
          [
            {
              "node": "Shopify API",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Unir Todos los Pedidos": {
        "main": [
          []
        ]
      },
      "Acumular en Memoria": {
        "main": [
          [
            {
              "node": "Hay más páginas?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir Empleados": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Bucle: Uno a Uno": {
        "main": [
          [
            {
              "node": "juntar datos",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Leer Informe de ese Día",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Leer Informe de ese Día": {
        "main": [
          [
            {
              "node": "Acumular en memoria",
              "type": "main",
              "index": 0
            }
          ],
          []
        ]
      },
      "Configurar Fechas": {
        "main": [
          [
            {
              "node": "Crear Informe Maestro",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Calcular Ranking Empleados": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tabla Marcas": {
        "main": [
          [
            {
              "node": "Calculo_Maestro",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [],
          [
            {
              "node": "Escribir Empleados",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Calculo_Maestro": {
        "main": [
          [
            {
              "node": "Elegir tipo de input",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Elegir tipo de input": {
        "main": [
          [
            {
              "node": "Escribir detalle",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Escribir marcas",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Escribir sucursales",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Acumular en memoria": {
        "main": [
          [
            {
              "node": "Espera 1s",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "When clicking ‘Execute workflow’": {
        "main": [
          [
            {
              "node": "Configurar Fechas",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          []
        ]
      },
      "Espera 1s": {
        "main": [
          [
            {
              "node": "Bucle: Uno a Uno",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "iniciar memoria": {
        "main": [
          []
        ]
      }
    },
    "authors": "Tailwind Media",
    "name": "Version df2fe689",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "df2fe689-b537-4f92-9e34-917bde686457",
  "connections": {
    "Crear Informe Maestro": {
      "main": [
        [
          {
            "node": "crear vista",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prep Shopify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bucle: Uno a Uno": {
      "main": [
        [
          {
            "node": "juntar datos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Leer Informe de ese Día",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Leer Informe de ese Día": {
      "main": [
        [
          {
            "node": "Acumular en memoria",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Calcular Ranking Empleados": {
      "main": [
        [
          {
            "node": "escribir bonos empleados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acumular en memoria": {
      "main": [
        [
          {
            "node": "Espera 1s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera 1s": {
      "main": [
        [
          {
            "node": "Bucle: Uno a Uno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "juntar datos": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "datos finales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calcular ventas empleados": {
      "main": [
        [
          {
            "node": "escribir ranking empleados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "datos finales": {
      "main": [
        [
          {
            "node": "calcular ventas empleados",
            "type": "main",
            "index": 0
          },
          {
            "node": "Calcular Ranking Empleados",
            "type": "main",
            "index": 0
          },
          {
            "node": "calcular sucursales",
            "type": "main",
            "index": 0
          },
          {
            "node": "obtener marcas",
            "type": "main",
            "index": 0
          },
          {
            "node": "calcular productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener marcas": {
      "main": [
        [
          {
            "node": "calcular marcas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calcular sucursales": {
      "main": [
        [
          {
            "node": "escribir sucursales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calcular productos": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          },
          {
            "node": "escribir tickets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calcular marcas": {
      "main": [
        [
          {
            "node": "escribir marcas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "escribir productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "escribir productos": {
      "main": [
        []
      ]
    },
    "crear vista": {
      "main": [
        [
          {
            "node": "obtener vista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener vista": {
      "main": [
        [
          {
            "node": "Bucle: Uno a Uno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "escribir marcas": {
      "main": [
        [
          {
            "node": "eliminar vista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "GraphQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "GraphQL2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL2": {
      "main": [
        [
          {
            "node": "GraphQL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Configurar Fechas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configurar Fechas": {
      "main": [
        [
          {
            "node": "Crear Informe Maestro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acumular en Memoria": {
      "main": [
        [
          {
            "node": "Hay más páginas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Next Page": {
      "main": [
        [
          {
            "node": "Shopify API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Hay más páginas?": {
      "main": [
        [
          {
            "node": "Set Next Page",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unir Todos los Pedidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Shopify API": {
      "main": [
        [
          {
            "node": "Acumular en Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Shopify": {
      "main": [
        [
          {
            "node": "Shopify API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-11-28T09:20:31.945Z",
  "id": "qYqXKqcZ774d2bpa",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "PRUEBA INFORME MENSUAL",
  "nodes": [
    {
      "parameters": {
        "operation": "copy",
        "fileId": {
          "__rl": true,
          "value": "1yCvIQHJhAdzdoRBuiEodGI2Dh0eUD9K7SImZgr8Hq1k",
          "mode": "id"
        },
        "name": "=PRUEBAPRUEBAPRUEBAPRUEBA COMPLETO - {{ $json.NOMBRE_MES }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -1600,
        656
      ],
      "id": "8916f4e2-0878-4287-90a8-ea2845be9296",
      "name": "Crear Informe Maestro",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "N7JXWgOiVoyCTaVL",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "content": "RUTA 1: VENTAS\nEl ID del archivo viene del nodo principal, así que ahora podemos escribir directamente.",
        "height": 140,
        "width": 304,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1264,
        224
      ],
      "id": "3a549215-5258-40d6-9eb8-ad59dcda8c59",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "RUTA 2: BONOS\nShopify procesa todo y al final escribe en el archivo creado al principio.",
        "height": 140,
        "width": 304,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1296,
        640
      ],
      "id": "204f972e-72a4-4184-b598-714928a95083",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -640,
        432
      ],
      "id": "b7320c16-4c2d-4328-a3c4-cd6225d9c362",
      "name": "Bucle: Uno a Uno"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $json.id_documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Hoja 1",
          "mode": "name"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -448,
        432
      ],
      "id": "715c3b3f-0444-435f-ac20-8188d186e39d",
      "name": "Leer Informe de ese Día",
      "alwaysOutputData": false,
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Objeto para acumular las ventas por empleado\nconst ventasPorEmpleado = {};\n\n// 1. Recorremos todos los items de entrada para sumar\nfor (const item of $input.all()) {\n  const data = item.json;\n\n  // Construir nombre completo\n  const nombre = data[\"Nombre empleado\"] || \"Desconocido\";\n  const apellidos = data[\"Apellidos empleado\"] || \"\";\n  const nombreCompleto = `${nombre} ${apellidos}`.trim();\n\n  // Obtener el precio pagado\n  const precio = parseFloat(data[\"PRECIO PAGADO\"]) || 0;\n\n  // Sumar al acumulado\n  if (!ventasPorEmpleado[nombreCompleto]) {\n    ventasPorEmpleado[nombreCompleto] = 0;\n  }\n  ventasPorEmpleado[nombreCompleto] += precio;\n}\n\n// 2. Transformar el objeto en un array temporal\nlet listaEmpleados = Object.keys(ventasPorEmpleado).map(nombre => {\n  return {\n    \"nombre\": nombre,\n    \"total facturado\": Number(ventasPorEmpleado[nombre].toFixed(2))\n  };\n});\n\n// 3. ORDENAR de Mayor a Menor facturación\nlistaEmpleados.sort((a, b) => b[\"total facturado\"] - a[\"total facturado\"]);\n\n// 4. Asignar el contador y el formato final para n8n\nconst resultado = listaEmpleados.map((empleado, index) => {\n  // Añadimos el contador al objeto ya ordenado\n  empleado[\"contador\"] = 31 + index;\n  \n  return { json: empleado };\n});\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        608
      ],
      "id": "b3531d9c-b6d2-447e-8f39-14124207a8a3",
      "name": "Calcular Ranking Empleados"
    },
    {
      "parameters": {
        "content": "COPIA DE LA PLANTILLA\n",
        "height": 192,
        "width": 528,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1984,
        624
      ],
      "id": "54f3936a-7187-4043-aa2a-4ab0c2f00674",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "jsCode": "// --- 1. CONFIGURACIÓN ---\nconst allItems = $input.all();\n\n// LISTA DE COLUMNAS EXACTAS QUE QUEREMOS\nconst columnasAceptadas = [\n  \"ID PEDIDO\", \n  \"row_number\", \n  \"SUCURSAL DE VENTA\", \n  \"MÉTODO DE PAGO\", \n  \"COSTE POR UNIDAD\", \n  \"PRECIO DE PRODUCTO\", \n  \"PRECIO PAGADO\", \n  \"DESCUENTO\", \n  \"NOMBRE DE PRODUCTO\", \n  \"VARIANTE\"\n];\n\n// --- 2. PROCESAMIENTO ---\nconst itemsLimpios = allItems\n  .map(item => item.json)\n  .filter(data => data[\"NOMBRE DE PRODUCTO\"] && data[\"NOMBRE DE PRODUCTO\"].toString().trim() !== \"\")\n  .map(data => {\n    let nuevoObjeto = {};\n    \n    columnasAceptadas.forEach(col => {\n      // LOGICA ID PEDIDO\n      if (col === \"ID PEDIDO\") {\n        const valor = data[col];\n        // Si existe y no está vacío, lo ponemos. Si no, texto por defecto.\n        if (valor && valor.toString().trim() !== \"\") {\n           nuevoObjeto[col] = valor;\n        } else {\n           nuevoObjeto[col] = \"Sin código de pedido\";\n        }\n      } \n      // RESTO DE COLUMNAS\n      else {\n        // Si la columna no existe en el Excel, ponemos undefined o lo dejamos vacío\n        nuevoObjeto[col] = data[col];\n      }\n    });\n    \n    return nuevoObjeto;\n  });\n\n// --- 3. MEMORIA GLOBAL (NOMBRE NUEVO) ---\nconst staticData = $getWorkflowStaticData('global');\n\n// Detectamos si es la primera vuelta para reiniciar la lista NUEVA\nif ($node[\"Bucle: Uno a Uno\"].runIndex === 0) {\n    staticData.inventarioLimpio = []; \n}\n\n// Inicializamos si no existe\nif (!staticData.inventarioLimpio) {\n    staticData.inventarioLimpio = [];\n}\n\n// Guardamos\nif (itemsLimpios.length > 0) {\n    staticData.inventarioLimpio.push(...itemsLimpios);\n}\n\nreturn { \n    processed: true, \n    count: itemsLimpios.length \n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -256,
        432
      ],
      "id": "0566c206-7b5a-4e3d-8278-a300db2b6a6a",
      "name": "Acumular en memoria"
    },
    {
      "parameters": {
        "content": "LEER LOS INFORMES DIARIOS DE TODO EL MES\n",
        "height": 288,
        "width": 784,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -704,
        336
      ],
      "id": "0a7df961-56a6-4e5d-a97b-eb7ba5c6bd0d",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "LEER INFORMACIÓN DE LOS EMPLEADOS EN SHOPIFY\n",
        "height": 240,
        "width": 992,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1296,
        784
      ],
      "id": "9eb648e0-0ffb-4d9c-b3c1-616e633836df",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -80,
        432
      ],
      "id": "28d6ad39-a80e-4fd9-a5eb-df2466e8b96f",
      "name": "Espera 1s",
      "webhookId": "57665f85-f34c-4a9b-81e3-71d620974b94"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a la memoria global\nconst staticData = $getWorkflowStaticData('global');\n\n// 2. IMPORTANTE: Leemos la variable NUEVA \"inventarioLimpio\"\n// (Antes buscabas \"misItemsGuardados\", por eso salía vacío)\nconst todosLosItems = staticData.inventarioLimpio || [];\n\n// 3. Verificación extra: Si está vacío, avisamos\nif (todosLosItems.length === 0) {\n    return [\n        { warning: \"La lista está vacía. Asegúrate de haber ejecutado el botón 'Execute Workflow' completo.\" }\n    ];\n}\n\n// 4. ¡Listo! Aquí tienes tus items\nreturn todosLosItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        704
      ],
      "id": "c53daf0e-4785-4887-8415-45a4af841923",
      "name": "juntar datos"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "ID PEDIDO",
              "field2": "id"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -64,
        768
      ],
      "id": "db67b35e-1a58-4246-a1a5-9f9554515e6e",
      "name": "Merge"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "Empleados",
          "mode": "list",
          "cachedResultName": "Empleados"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "id_empleado",
              "value": "={{ $json.user_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        112,
        768
      ],
      "id": "578355d2-24cb-465e-b0a9-0c41e3a1ccc1",
      "name": "Select rows from a table",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener todos los items de entrada\nconst allItems = $input.all();\nconst reporte = {};\n\n// 2. Identificar todas las sucursales únicas primero\nconst listaSucursales = new Set();\n\nfor (const item of allItems) {\n  const sucursal = item.json[\"SUCURSAL DE VENTA\"];\n  if (sucursal) {\n    listaSucursales.add(sucursal);\n  }\n}\n\n// 3. Recorrer los datos para agrupar por empleado\nfor (const item of allItems) {\n  const data = item.json;\n\n  // Construir nombre completo\n  const nombre = data[\"Nombre empleado\"] || \"Desconocido\";\n  const apellidos = data[\"Apellidos empleado\"] || \"\";\n  const nombreCompleto = `${nombre} ${apellidos}`.trim();\n\n  const sucursalActual = data[\"SUCURSAL DE VENTA\"];\n  const precio = parseFloat(data[\"PRECIO PAGADO\"]) || 0;\n\n  // Si es la primera vez que vemos a este empleado, inicializamos su estructura\n  if (!reporte[nombreCompleto]) {\n    reporte[nombreCompleto] = {\n      \"Empleado\": nombreCompleto\n      // El contador lo asignaremos al final para que sea correlativo\n    };\n\n    // Inicializamos TODAS las sucursales en 0 para este empleado\n    listaSucursales.forEach(sucursal => {\n      reporte[nombreCompleto][sucursal] = {\n        \"ventas\": 0,\n        \"facturado\": 0\n      };\n    });\n  }\n\n  // Sumamos los datos a la sucursal correspondiente\n  if (reporte[nombreCompleto][sucursalActual]) {\n    reporte[nombreCompleto][sucursalActual].ventas += 1;\n    reporte[nombreCompleto][sucursalActual].facturado += precio;\n  }\n}\n\n// 4. Generar el resultado final, redondeando decimales y añadiendo el contador\n// Object.values(reporte) nos da un array con los objetos de los empleados\nconst resultado = Object.values(reporte).map((filaEmpleado, index) => {\n\n  // AÑADIMOS EL CONTADOR:\n  // index empieza en 0, así que: 0 + 4 = 4, 1 + 4 = 5, etc.\n  filaEmpleado[\"contador\"] = index + 4;\n\n  // Redondeamos los montos facturados a 2 decimales\n  for (const key in filaEmpleado) {\n    if (typeof filaEmpleado[key] === 'object' && filaEmpleado[key] !== null) {\n      filaEmpleado[key].facturado = Number(filaEmpleado[key].facturado.toFixed(2));\n    }\n  }\n\n  return { json: filaEmpleado };\n});\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        448
      ],
      "id": "5e19dfa0-36cf-4015-a7fb-19f1ea6fdfdb",
      "name": "calcular ventas empleados"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Crear Informe Maestro').first().json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Ranking Empleados",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.contador }}",
            "Surfin Ventas": "={{ $json['Surfin Sierra Nevada'].ventas }}",
            "Surfin Facturado": "={{ $json['Surfin Sierra Nevada'].facturado }}",
            "Rules Ventas": "={{ $json['Rules Shop'].ventas }}",
            "Rules Facturado": "={{ $json['Rules Shop'].facturado }}",
            "Rules Oakley Ventas": "={{ $json['Rules Oakley'].ventas }}",
            "Rules Oakley Facturado": "={{ $json['Rules Oakley'].facturado }}",
            "Rules The North Face Ventas": "={{ $json['Rules The North Face'].ventas }}",
            "Rules The North Face Facturado": "={{ $json['Rules The North Face'].facturado }}",
            "Nuance Ventas": "={{ $json.Nuance.ventas }}",
            "Nuance Facturado": "={{ $json.Nuance.facturado }}",
            "Nuance Lodge Ventas": "={{ $json['Nuance Lodge'].ventas }}",
            "Nuance Lodge Facturado": "={{ $json['Nuance Lodge'].facturado }}",
            "Melia Ventas": "={{ $json['Melia Sierra Nevada'].ventas }}",
            "Melia Facturado": "={{ $json['Melia Sierra Nevada'].facturado }}",
            "Empleado": "={{ $json.Empleado }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Empleado",
              "displayName": "Empleado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Surfin Ventas",
              "displayName": "Surfin Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Surfin Facturado",
              "displayName": "Surfin Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Rules Ventas",
              "displayName": "Rules Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Rules Facturado",
              "displayName": "Rules Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Rules Oakley Ventas",
              "displayName": "Rules Oakley Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Rules Oakley Facturado",
              "displayName": "Rules Oakley Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Rules The North Face Ventas",
              "displayName": "Rules The North Face Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Rules The North Face Facturado",
              "displayName": "Rules The North Face Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nuance Ventas",
              "displayName": "Nuance Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nuance Facturado",
              "displayName": "Nuance Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nuance Lodge Ventas",
              "displayName": "Nuance Lodge Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nuance Lodge Facturado",
              "displayName": "Nuance Lodge Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Melia Ventas",
              "displayName": "Melia Ventas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Melia Facturado",
              "displayName": "Melia Facturado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        704,
        448
      ],
      "id": "111ca10e-00a2-46d3-a64a-4f4412f98d11",
      "name": "escribir ranking empleados",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Objeto para acumular estadísticas por sucursal\nconst estadisticasSucursales = {};\n\n// 1. Recorremos todos los items de entrada\nfor (const item of $input.all()) {\n  const data = item.json;\n\n  // Obtenemos el nombre de la sucursal (o \"Desconocida\" si viene vacío)\n  const sucursal = data[\"SUCURSAL DE VENTA\"] || \"Desconocida\";\n  \n  // Obtenemos el precio pagado, asegurando que sea un número\n  const precio = parseFloat(data[\"PRECIO PAGADO\"]) || 0;\n\n  // Inicializamos la sucursal si no existe en el objeto\n  if (!estadisticasSucursales[sucursal]) {\n    estadisticasSucursales[sucursal] = {\n      ventas: 0,\n      facturado: 0\n    };\n  }\n\n  // Acumulamos los datos\n  estadisticasSucursales[sucursal].ventas += 1;\n  estadisticasSucursales[sucursal].facturado += precio;\n}\n\n// 2. Transformamos el objeto en un array para poder ordenarlo\nlet listaSucursales = Object.keys(estadisticasSucursales).map(nombre => {\n  return {\n    \"sucursal\": nombre,\n    \"número de ventas\": estadisticasSucursales[nombre].ventas,\n    \"total facturado\": estadisticasSucursales[nombre].facturado\n  };\n});\n\n// 3. ORDENAR de Mayor a Menor facturación\nlistaSucursales.sort((a, b) => b[\"total facturado\"] - a[\"total facturado\"]);\n\n// 4. Formatear salida final con redondeo y contador\nconst resultado = listaSucursales.map((item, index) => {\n  // Redondeamos el total a 2 decimales\n  item[\"total facturado\"] = Number(item[\"total facturado\"].toFixed(2));\n  \n  // Asignamos el contador: índice 0 + 26 = 26, índice 1 + 26 = 27, etc.\n  item[\"contador\"] = 26 + index;\n\n  return { json: item };\n});\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        768
      ],
      "id": "a94a2f52-34c7-4efc-bb99-7e8094357023",
      "name": "calcular sucursales"
    },
    {
      "parameters": {
        "jsCode": "// Objeto para agrupar los productos normales\nconst productosAgrupados = {};\n\n// Variable para almacenar el Ticket por separado\nconst nombreTicket = \"/ / TICKET ENTRADA SKATEPARK\";\nlet datosTicket = {\n  \"NOMBRE\": nombreTicket,\n  \"VARIANTE\": \"General\",\n  \"PRECIO DE PRODUCTO\": 0,\n  \"UNIDADES VENDIDAS\": 0,\n  \"TOTAL FACTURADO\": 0,\n  \"contador\": 2\n};\nlet hayVentasTicket = false;\n\n// 1. Recorrer todas las ventas\nfor (const item of $input.all()) {\n  const data = item.json;\n\n  const nombre = data[\"NOMBRE DE PRODUCTO\"] || \"Desconocido\";\n  const variante = data[\"VARIANTE\"] || \"\";\n  const precioUnitario = parseFloat(data[\"PRECIO DE PRODUCTO\"]) || 0;\n  const precioPagado = parseFloat(data[\"PRECIO PAGADO\"]) || 0;\n\n  // --- LÓGICA TICKET ---\n  if (nombre === nombreTicket) {\n    hayVentasTicket = true;\n    // Actualizamos el precio unitario (por si varía, cogemos el último o el más alto)\n    if (precioUnitario > datosTicket[\"PRECIO DE PRODUCTO\"]) {\n       datosTicket[\"PRECIO DE PRODUCTO\"] = precioUnitario;\n    }\n    datosTicket[\"UNIDADES VENDIDAS\"] += 1;\n    datosTicket[\"TOTAL FACTURADO\"] += precioPagado;\n    continue;\n  }\n\n  // --- LÓGICA PRODUCTOS ---\n  const key = `${nombre}|${variante}`;\n\n  if (!productosAgrupados[key]) {\n    productosAgrupados[key] = {\n      \"NOMBRE\": nombre,\n      \"VARIANTE\": variante,\n      \"PRECIO DE PRODUCTO\": precioUnitario,\n      \"UNIDADES VENDIDAS\": 0,\n      \"TOTAL FACTURADO\": 0\n    };\n  }\n\n  productosAgrupados[key][\"UNIDADES VENDIDAS\"] += 1;\n  productosAgrupados[key][\"TOTAL FACTURADO\"] += precioPagado;\n}\n\n// 2. Ordenar productos\nlet listaProductos = Object.values(productosAgrupados);\n\nlistaProductos.sort((a, b) => {\n  if (b[\"UNIDADES VENDIDAS\"] === a[\"UNIDADES VENDIDAS\"]) {\n    return b[\"TOTAL FACTURADO\"] - a[\"TOTAL FACTURADO\"];\n  }\n  return b[\"UNIDADES VENDIDAS\"] - a[\"UNIDADES VENDIDAS\"];\n});\n\n// 3. Crear el Top 10 y formatearlo\nconst top10 = listaProductos.slice(0, 10).map((producto, index) => {\n  producto[\"TOTAL FACTURADO\"] = Number(producto[\"TOTAL FACTURADO\"].toFixed(2));\n  producto[\"contador\"] = 2 + index; // Empieza en 2, 3, 4...\n  return producto;\n});\n\n// 4. Formatear el Ticket\nif (hayVentasTicket) {\n  datosTicket[\"TOTAL FACTURADO\"] = Number(datosTicket[\"TOTAL FACTURADO\"].toFixed(2));\n} else {\n  // Si no hubo ventas, puedes decidir si dejarlo a 0 o ponerlo null. \n  // Lo dejo con los valores a 0 por si necesitas mostrarlo igualmente.\n}\n\n// 5. Devolver la estructura anidada\nreturn {\n  json: {\n    \"ticket\": datosTicket,\n    \"top\": top10\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        912
      ],
      "id": "bff06340-422b-4440-a181-69c03499ee1d",
      "name": "calcular productos"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "Marcas_Summit",
          "mode": "list",
          "cachedResultName": "Marcas_Summit"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        528,
        1056
      ],
      "id": "805d71fc-26b8-4293-9f47-e9ccd78da002",
      "name": "obtener marcas",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b8d434fd-10a6-428c-8037-fad14e9c4ff2",
              "name": "ID PEDIDO",
              "value": "={{ $('Merge').item.json[\"ID PEDIDO\"] }}",
              "type": "number"
            },
            {
              "id": "28a797fe-23df-42cd-9768-f49b9e9ed648",
              "name": "user_id",
              "value": "={{ $('Merge').item.json.user_id }}",
              "type": "number"
            },
            {
              "id": "3906a8b7-ed33-4c7b-8d17-f3d52add380f",
              "name": "Nombre empleado",
              "value": "={{ $json.Nombre }}",
              "type": "string"
            },
            {
              "id": "087e686e-82a7-4aee-9433-475a1cb6219b",
              "name": "Apellidos empleado",
              "value": "={{ $json.Apellidos }}",
              "type": "string"
            },
            {
              "id": "d1479a34-09fd-41cd-a8a8-40f8b1b4cd8f",
              "name": "SUCURSAL DE VENTA",
              "value": "={{ $('Merge').item.json[\"SUCURSAL DE VENTA\"] }}",
              "type": "string"
            },
            {
              "id": "737708ed-e76c-414f-8b5e-44868c86b676",
              "name": "MÉTODO DE PAGO",
              "value": "={{ $('Merge').item.json[\"MÉTODO DE PAGO\"] }}",
              "type": "string"
            },
            {
              "id": "88a0319c-d427-47ea-89cf-6cb05711d727",
              "name": "COSTE POR UNIDAD",
              "value": "={{ $('Merge').item.json[\"COSTE POR UNIDAD\"] }}",
              "type": "string"
            },
            {
              "id": "0179d933-5161-4cc6-8e48-22579f6b16ee",
              "name": "PRECIO DE PRODUCTO",
              "value": "={{ $('Merge').item.json[\"PRECIO DE PRODUCTO\"] }}",
              "type": "string"
            },
            {
              "id": "fa9744ef-b316-4bc7-a60d-ebe63ac1c551",
              "name": "PRECIO PAGADO",
              "value": "={{ $('Merge').item.json[\"PRECIO PAGADO\"] }}",
              "type": "string"
            },
            {
              "id": "dc142fca-2f03-44f7-86f8-22bc768dbf31",
              "name": "DESCUENTO",
              "value": "={{ $('Merge').item.json.DESCUENTO }}",
              "type": "string"
            },
            {
              "id": "abe8ab7d-25f7-42a0-bdaa-d69fff6fb002",
              "name": "PRECIO PAGADO",
              "value": "={{ $('Merge').item.json[\"PRECIO PAGADO\"] }}",
              "type": "string"
            },
            {
              "id": "104be7e9-5368-47cf-9504-c1906bf7e029",
              "name": "DESCUENTO",
              "value": "={{ $('Merge').item.json.DESCUENTO }}",
              "type": "string"
            },
            {
              "id": "da346580-a5b7-4a88-8049-b0535d163a34",
              "name": "NOMBRE DE PRODUCTO",
              "value": "={{ $('Merge').item.json[\"NOMBRE DE PRODUCTO\"] }}",
              "type": "string"
            },
            {
              "id": "fe2f9730-7f93-4213-8d42-27846a39a0f5",
              "name": "VARIANTE",
              "value": "={{ $('Merge').item.json.VARIANTE }}",
              "type": "string"
            },
            {
              "id": "81819489-519e-47c2-90ab-06e9cc7a373d",
              "name": "name",
              "value": "={{ $('Merge').item.json.name }}",
              "type": "string"
            },
            {
              "id": "64767b45-084a-401c-8f1b-c455ac688531",
              "name": "total_price",
              "value": "={{ $('Merge').item.json.total_price }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        304,
        768
      ],
      "id": "e019d66f-62e8-4243-8f76-05626c049638",
      "name": "datos finales",
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener las VENTAS del nodo anterior llamado \"datos finales\"\n// Es importante que el nombre coincida exactamente (mayúsculas/minúsculas)\nconst itemsVentas = $('datos finales').all();\n\n// 2. Obtener las MARCAS del input actual (este nodo Code debe recibir la lista de marcas)\nconst itemsMarcas = $input.all();\n\n// Creamos una lista limpia de nombres de marcas\n// IMPORTANTE: Las ordenamos por longitud (de más larga a más corta).\n// Esto evita errores de coincidencia (ej: que detecte \"Pro\" en lugar de \"Prosurf\")\nconst listaMarcas = itemsMarcas\n    .map(item => item.json[\"Nombre_del_Proveedor\"])\n    .filter(nombre => nombre) // Eliminar vacíos\n    .sort((a, b) => b.length - a.length);\n\n// Objeto para acumular los resultados\nconst statsMarcas = {};\n\n// 3. Recorrer las ventas y buscar la marca en el nombre del producto\nfor (const item of itemsVentas) {\n    const venta = item.json;\n    // Pasamos a minúsculas para comparar sin errores\n    const nombreProducto = (venta[\"NOMBRE DE PRODUCTO\"] || \"\").toLowerCase(); \n    const precio = parseFloat(venta[\"PRECIO PAGADO\"]) || 0;\n\n    let marcaEncontrada = null;\n\n    // Buscamos qué marca está incluida en el nombre del producto\n    for (const marca of listaMarcas) {\n        if (nombreProducto.includes(marca.toLowerCase())) {\n            marcaEncontrada = marca; // Guardamos el nombre original (con mayúsculas correctas)\n            break; // Detenemos el bucle al encontrar la primera coincidencia (la más larga)\n        }\n    }\n\n    // Si encontramos la marca, sumamos los datos\n    if (marcaEncontrada) {\n        if (!statsMarcas[marcaEncontrada]) {\n            statsMarcas[marcaEncontrada] = {\n                \"Marca\": marcaEncontrada,\n                \"Unidades Vendidas\": 0,\n                \"Total Facturado\": 0\n            };\n        }\n        statsMarcas[marcaEncontrada][\"Unidades Vendidas\"] += 1;\n        statsMarcas[marcaEncontrada][\"Total Facturado\"] += precio;\n    }\n}\n\n// 4. Convertir objeto a array para ordenar\nlet ranking = Object.values(statsMarcas);\n\n// 5. Ordenar por Unidades Vendidas (Mayor a Menor)\n// Si empatan en unidades, desempatamos por facturación\nranking.sort((a, b) => {\n    if (b[\"Unidades Vendidas\"] === a[\"Unidades Vendidas\"]) {\n        return b[\"Total Facturado\"] - a[\"Total Facturado\"];\n    }\n    return b[\"Unidades Vendidas\"] - a[\"Unidades Vendidas\"];\n});\n\n// 6. Quedarse con el Top 10\nconst top10 = ranking.slice(0, 10);\n\n// 7. Formatear salida (redondear dinero y añadir contador)\nconst resultadoFinal = top10.map((item, index) => {\n    item[\"Total Facturado\"] = Number(item[\"Total Facturado\"].toFixed(2));\n    \n    // El contador empieza en 14\n    item[\"contador\"] = 14 + index;\n\n    return { json: item };\n});\n\nreturn resultadoFinal;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        1056
      ],
      "id": "59020f6f-51fa-4d36-8893-a8d75aa8bf38",
      "name": "calcular marcas"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Crear Informe Maestro').first().json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Bonos Empleados",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.contador }}",
            "BONOS INDIVIDUALES": "={{ $json.nombre }}",
            "TOTAL VENDIDO": "={{ $json[\"total facturado\"] }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "BONOS INDIVIDUALES",
              "displayName": "BONOS INDIVIDUALES",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL VENDIDO",
              "displayName": "TOTAL VENDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "BONO 90€",
              "displayName": "BONO 90€",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "BONO 120€",
              "displayName": "BONO 120€",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "BONO 150€",
              "displayName": "BONO 150€",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "BONO 200€",
              "displayName": "BONO 200€",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        704,
        608
      ],
      "id": "8272ba28-2e72-4e25-aead-18b4282933dd",
      "name": "escribir bonos empleados",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Crear Informe Maestro').first().json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Top Productos",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.contador }}",
            "TOTAL": "={{ $json[\"total facturado\"] }}",
            "UNIDADES VENDIDAS": "={{ $json[\"número de ventas\"] }}",
            "PRECIO": "={{ $json.sucursal }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO",
              "displayName": "PRECIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UNIDADES VENDIDAS",
              "displayName": "UNIDADES VENDIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL",
              "displayName": "TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TICKETS VENDIDOS",
              "displayName": "TICKETS VENDIDOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO TOTAL",
              "displayName": "PRECIO TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        704,
        768
      ],
      "id": "5d5d1144-b6a4-4517-8c17-f45bd1777cb6",
      "name": "escribir sucursales",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Crear Informe Maestro').first().json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Top Productos",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "PRECIO": "={{ $json.Marca }}",
            "UNIDADES VENDIDAS": "={{ $json[\"Unidades Vendidas\"] }}",
            "TOTAL": "={{ $json[\"Total Facturado\"] }}",
            "row_number": "={{ $json.contador }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PRECIO",
              "displayName": "PRECIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UNIDADES VENDIDAS",
              "displayName": "UNIDADES VENDIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "TOTAL",
              "displayName": "TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "TICKETS VENDIDOS",
              "displayName": "TICKETS VENDIDOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PRECIO TOTAL",
              "displayName": "PRECIO TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        880,
        1056
      ],
      "id": "43da738d-3ef2-4763-bced-508223224168",
      "name": "escribir marcas",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "top",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        704,
        912
      ],
      "id": "464123de-46d6-44b1-9d9c-fd1f38b95ac5",
      "name": "Split Out"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Crear Informe Maestro').first().json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Top Productos",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "NOMBRE PRODUCTO": "={{ $json.NOMBRE }}",
            "VARIANTE": "={{ $json.VARIANTE }}",
            "PRECIO": "={{ $json['PRECIO DE PRODUCTO'] }}",
            "UNIDADES VENDIDAS": "={{ $json['UNIDADES VENDIDAS'] }}",
            "TOTAL": "={{ $json['TOTAL FACTURADO'] }}",
            "row_number": "={{ $json.contador }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO",
              "displayName": "PRECIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UNIDADES VENDIDAS",
              "displayName": "UNIDADES VENDIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL",
              "displayName": "TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TICKETS VENDIDOS",
              "displayName": "TICKETS VENDIDOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO TOTAL",
              "displayName": "PRECIO TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        992,
        784
      ],
      "id": "98e4a5f2-53c7-4783-80ac-e88ea5d9cbfb",
      "name": "escribir productos",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Crear Informe Maestro').first().json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Top Productos",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "TICKETS VENDIDOS": "={{ $json.ticket['UNIDADES VENDIDAS'] }}",
            "PRECIO TOTAL": "={{ $json.ticket['TOTAL FACTURADO'] }}",
            "row_number": "={{ $json.ticket.contador }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO",
              "displayName": "PRECIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UNIDADES VENDIDAS",
              "displayName": "UNIDADES VENDIDAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL",
              "displayName": "TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TICKETS VENDIDOS",
              "displayName": "TICKETS VENDIDOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO TOTAL",
              "displayName": "PRECIO TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        992,
        928
      ],
      "id": "ab0a03ed-9087-492a-98a0-0b1b86b9eb32",
      "name": "escribir tickets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE OR REPLACE VIEW \"Vista_Informes_Mes_Pasado\" AS\nSELECT *\nFROM \"Documentos_Sheets\"\nWHERE tipo = 'informe'\n  /* Filtramos que la fecha sea mayor o igual al inicio del mes actual */\n  AND TO_DATE(RIGHT(nombre, 10), 'DD/MM/YYYY') >= DATE_TRUNC('month', CURRENT_DATE)\n  /* Y menor que el inicio del mes siguiente */\n  AND TO_DATE(RIGHT(nombre, 10), 'DD/MM/YYYY') < DATE_TRUNC('month', CURRENT_DATE + INTERVAL '1 month');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        432
      ],
      "id": "f5775766-f57d-4069-9332-387233255385",
      "name": "crear vista",
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "Vista_Informes_Mes_Pasado",
          "mode": "name"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1040,
        432
      ],
      "id": "cb7a8402-4d50-4c4e-845b-b22b53a2b9c6",
      "name": "obtener vista",
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "drop view \"Vista_Informes_Mes_Pasado\"",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1104,
        1056
      ],
      "id": "d1b85e56-8e05-4a95-8f95-f78a6d606292",
      "name": "eliminar vista",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "query": "query findCustomerAndCreditID($query: String!) {\n  customers(first: 1, query: $query) {\n    edges {\n      node {\n        id\n        email\n        # Buscamos también la cuenta de crédito del cliente\n        storeCreditAccounts(first: 1) {\n          edges {\n            node {\n              id\n            }\n          }\n        }\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"email:{{ $json.Correo }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        -528,
        1520
      ],
      "id": "63668f8b-ab19-4460-af4d-ba9850a9c519",
      "name": "GraphQL",
      "credentials": {
        "httpHeaderAuth": {
          "id": "THkhgrtze1uBo6Ft",
          "name": "Token Informes Shopify"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. INPUT ACTUAL (items): Son los datos que vienen de \"Get row(s)\" (Correos)\nconst datosCorreos = items;\n\n// 2. INPUT ANTERIOR: Recuperamos los datos del nodo \"Calcular Ranking Empleados1\" (Ventas)\n// NOTA: Asegúrate de que el nombre dentro de $('...') sea EXACTO al de tu nodo morado\nlet datosVentas = [];\ntry {\n  datosVentas = $('Calcular Ranking Empleados').all();\n} catch (e) {\n  return [{ json: { error: \"No encuentro el nodo 'Calcular Ranking Empleados1'. Revisa el nombre.\" } }];\n}\n\n// 3. Creamos el mapa para buscar correos (Nombre -> Correo)\nconst mapaCorreos = {};\n\ndatosCorreos.forEach(fila => {\n  const datos = fila.json;\n  \n  // En tu captura de \"Get row(s)\", la columna del nombre se llama \"Nombre\" (no \"Nombre Empleado\")\n  // Usamos .trim() porque en tu captura se ven saltos de línea (\"\\n\")\n  const nombreKey = (datos[\"Nombre\"] || \"\").toString().trim();\n  const email = (datos[\"Correo\"] || \"\").toString().trim(); // Limpiamos el \\n del correo\n  \n  if (nombreKey && email) {\n    mapaCorreos[nombreKey] = email;\n  }\n});\n\n// 4. Procesamos las VENTAS (iteramos sobre datosVentas, NO sobre items)\nconst resultados = [];\n\nfor (const item of datosVentas) {\n  const empleado = item.json;\n  \n  // Aquí sí existen estas columnas porque estamos leyendo del nodo de Ranking\n  const ventas = parseFloat(empleado[\"Total Vendido\"]);\n  const nombreVentas = (empleado[\"Nombre Empleado\"] || \"\").toString().trim();\n  \n  let bonoValor = 0;\n\n  // --- LÓGICA DEL BONO ---\n  if (ventas >= 30000) {\n    bonoValor = 200;\n  } else if (ventas >= 26000) {\n    bonoValor = 150;\n  } else if (ventas >= 22000) {\n    bonoValor = 120;\n  } else if (ventas >= 18000) {\n    bonoValor = 90;\n  }\n\n  // --- GENERACIÓN DEL OUTPUT ---\n  if (bonoValor > 0) {\n    \n    // Buscamos el correo usando el nombre limpio\n    const correoEncontrado = mapaCorreos[nombreVentas];\n\n    resultados.push({\n      json: {\n        \"Nombre Empleado\": nombreVentas,\n        \"Total Vendido\": ventas,\n        \"BONO\": `BONO ${bonoValor}€`,\n        \"MontoBono\": bonoValor,\n        // Si no encuentra el correo, pondrá null.\n        \"Correo\": correoEncontrado || \"No encontrado\"\n      }\n    });\n  }\n}\n\nreturn resultados;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        1520
      ],
      "id": "03578317-686d-4b3d-ad67-6d06e01c11c2",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "m14tPVcEZzewnVMX",
          "mode": "list",
          "cachedResultName": "empleados",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/m14tPVcEZzewnVMX"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "Nombre",
              "keyValue": "={{ $json[\"Nombre Empleado\"] }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -880,
        1520
      ],
      "id": "ccb60fd6-673b-44bd-80f9-681b61a87e3f",
      "name": "Get row(s)"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtenemos los resultados de Shopify (Input actual)\nconst shopifyInput = items;\n\n// 2. Obtenemos los datos originales del bono (Code in JavaScript)\nlet bonusInput = [];\ntry {\n  bonusInput = $('Code in JavaScript').all();\n} catch (error) {\n  return [{ json: { error: \"No se encuentran datos del nodo 'Code in JavaScript'\" } }];\n}\n\n// 3. Mapeamos los bonos por correo (limpiando espacios)\nconst mapaBonos = {};\nbonusInput.forEach(item => {\n  const data = item.json;\n  if (data.Correo) {\n    const emailLimpio = data.Correo.toString().trim().toLowerCase();\n    mapaBonos[emailLimpio] = data;\n  }\n});\n\nconst resultadosFinales = [];\n\n// 4. Procesamos la respuesta de Shopify\nfor (const item of shopifyInput) {\n  const shopifyData = item.json;\n\n  // Verificamos si Shopify encontró al cliente\n  if (shopifyData.data && \n      shopifyData.data.customers && \n      shopifyData.data.customers.edges && \n      shopifyData.data.customers.edges.length > 0) {\n    \n    const clienteNode = shopifyData.data.customers.edges[0].node;\n    const emailShopify = clienteNode.email.trim().toLowerCase();\n\n    // Cruzamos con el bono original\n    const bonoOriginal = mapaBonos[emailShopify];\n\n    if (bonoOriginal) {\n      \n      // Intentamos obtener la ID de la cuenta de crédito\n      let creditAccountId = null;\n      if (clienteNode.storeCreditAccounts && \n          clienteNode.storeCreditAccounts.edges && \n          clienteNode.storeCreditAccounts.edges.length > 0) {\n        creditAccountId = clienteNode.storeCreditAccounts.edges[0].node.id;\n      }\n\n      // IMPORTANTE: Ahora devolvemos el resultado SIEMPRE, tenga o no cuenta de crédito.\n      // Si no tiene cuenta, 'CreditAccountID' será null.\n      resultadosFinales.push({\n        json: {\n          \"CustomerID\": clienteNode.id,\n          \"CreditAccountID\": creditAccountId, // Puede ser null si el cliente es nuevo\n          \"MontoBono\": bonoOriginal.MontoBono.toString(),\n          \"EtiquetaBono\": bonoOriginal.BONO,\n          \"Email\": emailShopify,\n          \"TieneCuentaCredito\": creditAccountId ? true : false // Bandera de ayuda\n        }\n      });\n    }\n  }\n}\n\nreturn resultadosFinales;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        1520
      ],
      "id": "931e8f54-6d9c-4926-9613-8947a71c7fba",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "query": "mutation storeCreditAccountCredit($id: ID!, $creditInput: StoreCreditAccountCreditInput!) {\n  storeCreditAccountCredit(id: $id, creditInput: $creditInput) {\n    storeCreditAccountTransaction {\n      id\n      amount {\n        amount\n        currencyCode\n      }\n      balanceAfterTransaction {\n        amount\n        currencyCode\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}\n",
        "variables": "={\n  \"id\": \"{{ $json.CreditAccountID }}\",\n  \"creditInput\": {\n    \"creditAmount\": {\n      \"amount\": \"{{ $json.MontoBono }}\",\n      \"currencyCode\": \"EUR\"\n    }\n  }\n}\n"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        64,
        1520
      ],
      "id": "45cf7ed9-32f9-4b7e-9bb1-9ad908231c0f",
      "name": "GraphQL1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "THkhgrtze1uBo6Ft",
          "name": "Token Informes Shopify"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2026-01/graphql.json",
        "query": "mutation AddCustomerTag($id: ID!, $tags: [String!]!) {\n  tagsAdd(id: $id, tags: $tags) {\n    node {\n      id\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"id\": \"{{ $json.CustomerID }}\",\n  \"tags\": [\"{{ $json.EtiquetaBono }}\"]\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        -128,
        1520
      ],
      "id": "6000736b-1fd6-4b52-a75f-8f9dffb46b3e",
      "name": "GraphQL2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "THkhgrtze1uBo6Ft",
          "name": "Token Informes Shopify"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.Email }}",
        "subject": "=¡Tienes {{ $json.MontoBono }}€ de saldo disponible en tienda! 🎁",
        "message": "=<!DOCTYPE html>\n<html>\n<head>\n<style>\n  body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }\n  .email-container { max-width: 600px; margin: 0 auto; background-color: #ffffff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n  .header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #eeeeee; }\n  .header h1 { color: #333333; margin: 0; font-size: 24px; }\n  .content { padding: 30px 0; color: #555555; line-height: 1.6; }\n  .credit-box { background-color: #e6fffa; border: 1px solid #38b2ac; color: #234e52; padding: 15px; text-align: center; border-radius: 6px; margin: 20px 0; font-size: 18px; font-weight: bold; }\n  .info-text { font-size: 14px; color: #666; text-align: center; margin-top: -10px; margin-bottom: 20px; font-style: italic; }\n  .warning-box { background-color: #fffaf0; border-left: 4px solid #ed8936; padding: 15px; margin: 20px 0; font-size: 14px; color: #744210; }\n  .footer { text-align: center; font-size: 12px; color: #999999; margin-top: 30px; border-top: 1px solid #eeeeee; padding-top: 20px; }\n</style>\n</head>\n<body>\n\n<div class=\"email-container\">\n  <div class=\"header\">\n    <h1>¡Saldo añadido correctamente!</h1>\n  </div>\n\n  <div class=\"content\">\n    <p>Hola,</p>\n    \n    <p>Queremos informarte que hemos actualizado tu cuenta de cliente. Tienes un nuevo bono de crédito listo para usar.</p>\n\n    <div class=\"credit-box\">\n      Has recibido: {{ $json.MontoBono }}€\n    </div>\n\n    <div class=\"info-text\">\n      *Si ya disponías de saldo anterior en tu cuenta, este importe <strong>se ha sumado</strong> a tu total actual.\n    </div>\n\n    <p>Puedes utilizar este crédito para adquirir cualquier producto en <strong>todas nuestras tiendas</strong>.</p>\n\n    <div class=\"warning-box\">\n      <strong>⚠️ Recordatorio importante:</strong><br>\n      Si decides pagar utilizando tu crédito de tienda, el sistema <u>no permitirá aplicar otros códigos de descuento</u> o cupones promocionales en ese mismo pedido.\n    </div>\n  </div>\n\n  <div class=\"footer\">\n    <p>Saludos,<br><strong>El Equipo de Tailwind</strong></p>\n    <p>Si tienes alguna duda sobre tu saldo total, no dudes en responder a este correo.</p>\n  </div>\n</div>\n\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        -128,
        1696
      ],
      "id": "80e5c84a-d412-4849-b647-a31a87027f41",
      "name": "Send a message",
      "webhookId": "69b6f5d3-a26d-46a8-8432-61d9aa5edd87",
      "credentials": {
        "gmailOAuth2": {
          "id": "wR7U82S8bmDH4odC",
          "name": "info@tailwind.es"
        }
      }
    },
    {
      "parameters": {
        "content": "## PARA ACTUALIZAR BONOS EN SHOPIFY",
        "height": 400,
        "width": 1456
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1072,
        1456
      ],
      "id": "a35052e5-9313-45d2-bd83-1635a0476047",
      "name": "Sticky Note3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1936,
        656
      ],
      "id": "e51c40f8-a227-4f9c-b137-75968f2de83e",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id_fecha",
              "name": "NOMBRE_MES",
              "value": "={{ $today.minus({months: 1}).setLocale('es').format('MMMM').toUpperCase() }}",
              "type": "string"
            },
            {
              "id": "id_rango_inicio",
              "name": "FECHA_INICIO",
              "value": "={{ $today.startOf('month').format('yyyy-MM-dd') }}T00:00:00Z",
              "type": "string"
            },
            {
              "id": "id_rango_fin",
              "name": "FECHA_FIN",
              "value": "={{ $today.endOf('month').format('yyyy-MM-dd') }}T23:59:59Z",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1760,
        656
      ],
      "id": "b214af46-3394-4866-bbe1-53422bd52f0d",
      "name": "Configurar Fechas"
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nif (!staticData.listaTemporal) staticData.listaTemporal = [];\n\n// 1. Capturamos los datos de entrada (incluidos los encabezados/headers)\n// Usamos items[0] porque en n8n v1+ items es el array de entrada\nconst inputData = items[0].json;\nconst pedidos = inputData.body.orders;\n\n// 2. Guardamos los pedidos en la mochila\nstaticData.listaTemporal.push(...pedidos);\n\n// 3. ¡IMPORTANTE! Devolvemos los 'headers' hacia afuera.\n// Así el siguiente nodo podrá leer el link de la página siguiente.\nreturn {\n  json: {\n    status: 'accumulating',\n    headers: inputData.headers\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        848
      ],
      "id": "02bcc516-97d5-4773-a875-6c174ef083b0",
      "name": "Acumular en Memoria"
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nconst listaAcumulada = staticData.listaTemporal || [];\nconst nuevosPedidos = $('Shopify API').item.json.body.orders || [];\nconst listaCompleta = listaAcumulada.concat(nuevosPedidos);\nstaticData.listaTemporal = [];\nreturn listaCompleta.map(p => ({ json: p }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        1072
      ],
      "id": "a5e7501f-ad93-43b6-bb94-2dd14abcadc0",
      "name": "Unir Todos los Pedidos"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "next_url",
              "name": "url_proxima",
              "value": "={{ $json.headers.link.match(/<([^>]+)>;\\s*rel=\"next\"/)[1] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -608,
        832
      ],
      "id": "b24e5b37-3f22-4b3e-842f-12c4cafad8d5",
      "name": "Set Next Page"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cond_link",
              "leftValue": "={{ $('Shopify API').item.json.headers.link }}",
              "rightValue": "next",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -768,
        848
      ],
      "id": "6f1925d2-06f9-4916-8223-0d748ee25c76",
      "name": "Hay más páginas?"
    },
    {
      "parameters": {
        "url": "={{ $json.url_proxima }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1088,
        848
      ],
      "id": "518b3741-7d29-4729-be2c-b78172a14a40",
      "name": "Shopify API",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "url_shopify",
              "name": "url_proxima",
              "value": "=https://rulesshop.myshopify.com/admin/api/2025-01/orders.json?limit=250&status=any&created_at_min={{ $('Configurar Fechas').item.json.FECHA_INICIO }}&created_at_max={{ $('Configurar Fechas').item.json.FECHA_FIN }}&fields=id,name,total_price,user_id",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1264,
        848
      ],
      "id": "e5411988-7c02-483e-8420-ac2e12aa615a",
      "name": "Prep Shopify"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-11-28T09:20:31.947Z",
      "createdAt": "2025-11-28T09:20:31.947Z",
      "role": "workflow:owner",
      "workflowId": "qYqXKqcZ774d2bpa",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": {
    "node:Shopify Trigger": {},
    "node:Inicio de Mes (Día 1)": {
      "recurrenceRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-02-16T08:34:06.056Z",
  "versionId": "dabcea7c-116a-4da1-8e29-b0d29a616c2f"
}