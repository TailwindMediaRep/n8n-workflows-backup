{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Split Out": {
      "main": [
        [
          {
            "node": "Empleados Vigentes - Bizneo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Empleados Total - Bizneo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Empleados Total - Bizneo": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Empleados Vigentes - Bizneo": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No existe en Shopify": {
      "main": [
        [
          {
            "node": "Crear Clientes en Shopify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coincidencias con Shopify": {
      "main": [
        [
          {
            "node": "No existe en Shopify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Coincidencias con Shopify",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coincidencias con Shopify1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coincidencias con Shopify1": {
      "main": [
        [
          {
            "node": "Existe en Shopify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Existe en Shopify": {
      "main": [
        [
          {
            "node": "Quitar etiqueta del Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-14T08:03:27.792Z",
  "id": "UmKsPhbqKY4r9YDi9-dc0",
  "isArchived": false,
  "meta": null,
  "name": "Employed Bizneo->ShopifyAccount",
  "nodes": [
    {
      "parameters": {
        "fieldToSplitOut": "body.users",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -624,
        80
      ],
      "id": "5b8d64d2-3fe0-49fd-a840-cafdc7ccea2c",
      "name": "Split Out"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1024,
        80
      ],
      "id": "e0a1f046-055a-4f3d-a413-8368ef29447d",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "url": "=https://snowink.bizneohr.com/api/v1/users?page_size=25",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "SFMyNTY.g2gDdAAAAAJ3AmlkbQAAACRhMDZkZGIwNi03NjZjLTQ0ZDMtYTI1YS02MmZiMTUyNWMxZmZ3CmNvbXBhbnlfaWRiAO2ucG4GAF89AKebAWIAAVGA.w1Gue36eFFL5B9iPAWqon1Te_4w1rJr4zAVkhHcrfho"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          },
          "pagination": {
            "pagination": {
              "parameters": {
                "parameters": [
                  {
                    "name": "page",
                    "value": "={{ $pageCount + 1 }}"
                  }
                ]
              },
              "paginationCompleteWhen": "other",
              "completeExpression": "={{ $response.body.pagination.page_number >= $response.body.pagination.total_pages }}"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -832,
        80
      ],
      "id": "be8b1ce9-2fed-4cfb-a935-5fbefcbc062c",
      "name": "Empleados Total - Bizneo",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// Obtenemos todos los usuarios\nconst users = $input.all();\nconst today = new Date();\n\n// Procesamos la lista sin eliminar a nadie\nconst processedUsers = users.map(item => {\n  const contracts = item.json.work_contracts;\n  \n  // Por defecto asumimos que NO está activo\n  let isVigente = false;\n\n  if (contracts && Array.isArray(contracts)) {\n    // Comprobamos si tiene al menos un contrato válido\n    isVigente = contracts.some(c => {\n      // Condición 1: Indefinido (end_at null)\n      if (c.end_at === null) return true;\n      // Condición 2: Fecha futura o presente\n      return new Date(c.end_at) >= today;\n    });\n  }\n\n  // Devolvemos el usuario añadiendo la propiedad 'isVigente'\n  return {\n    json: {\n      ...item.json,\n      isVigente: isVigente // true o false\n    }\n  };\n});\n\nreturn processedUsers;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        80
      ],
      "id": "a2794c8e-cdcd-4757-90dd-d851641838d4",
      "name": "Empleados Vigentes - Bizneo"
    },
    {
      "parameters": {
        "jsCode": "// Obtenemos los resultados de la búsqueda de Shopify\nconst items = $input.all();\n\n// ⚠️ IMPORTANTE: Pon aquí el nombre EXACTO del nodo anterior (el filtro de vigentes)\n// Si no lo has renombrado, suele ser \"Code\" o \"Code1\". Míralo en tu lienzo.\nconst previousNodeName = \"Empleados Vigentes - Bizneo\"; \n\n// Traemos los datos originales de ese nodo para tener los nombres a mano\nconst originalItems = $(previousNodeName).all();\n\nconst missingEmployees = items.map((item, index) => {\n  const edges = item.json.data?.customers?.edges;\n\n  // Si 'edges' está vacío, significa que NO se encontró el cliente\n  if (!edges || edges.length === 0) {\n    \n    // RECUPERACIÓN DE DATOS:\n    // Usamos el índice para encontrar a la persona correcta en la lista original\n    let originalData;\n    \n    // Intentamos usar pairedItem (forma moderna)\n    if (item.pairedItem && item.pairedItem.length > 0) {\n        const originalIndex = item.pairedItem[0].item;\n        originalData = originalItems[originalIndex].json;\n    } else {\n        // Plan B: Usamos el índice directo (funciona si el flujo es lineal)\n        originalData = originalItems[index].json;\n    }\n\n    return {\n      json: {\n        status: \"NO EXISTE EN SHOPIFY\",\n        first_name: originalData.first_name,\n        last_name: originalData.last_name,\n        email: originalData.email\n      }\n    };\n  }\n  \n  return null; // Si se encontró (edges tiene datos), lo ignoramos aquí\n}).filter(item => item !== null); // Limpiamos los nulos\n\nreturn missingEmployees;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        304,
        0
      ],
      "id": "9e9d34eb-5b24-404c-9437-9176ba482c1c",
      "name": "No existe en Shopify"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "=query ($searchTerm: String!) {\n  customers(first: 10, query: $searchTerm) {\n    edges {\n      node {\n        id\n        email\n        tags\n        state\n      }\n    }\n  }\n}",
        "variables": "={\n  \"searchTerm\": \"email:{{ $json.email }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "4b597a8d-2500-4b02-82f7-92ba8b7ad67e",
      "name": "Coincidencias con Shopify",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation customerCreate($input: CustomerInput!) {\n  customerCreate(input: $input) {\n    customer {\n      id\n      email\n      firstName\n      lastName\n      tags\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"firstName\": \"{{ $json.first_name }}\",\n    \"lastName\": \"{{ $json.last_name }}\",\n    \"email\": \"{{ $json.email }}\",\n    \"tags\": [\"Empleado\"]\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        656,
        0
      ],
      "id": "81d406ea-fa34-44fd-a0d6-ff373a05db8b",
      "name": "Crear Clientes en Shopify",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "49060fd7-75f1-49d7-a819-efbde25f8788",
              "leftValue": "={{ $json.isVigente }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -208,
        80
      ],
      "id": "7aa7bd62-5c25-40f7-b3b3-1942b11580fe",
      "name": "If"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "=query ($searchTerm: String!) {\n  customers(first: 10, query: $searchTerm) {\n    edges {\n      node {\n        id\n        email\n        tags\n        state\n      }\n    }\n  }\n}",
        "variables": "={\n  \"searchTerm\": \"email:{{ $json.email }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        0,
        160
      ],
      "id": "f5ffdb7b-56d0-40a3-a54e-d93d02197937",
      "name": "Coincidencias con Shopify1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtenemos los resultados de la búsqueda de Shopify\nconst items = $input.all();\n\n// ⚠️ IMPORTANTE: Pon aquí el nombre EXACTO del nodo donde tenías la lista original de empleados.\n// Si estás en la rama de \"Bajas\" (False), asegúrate de que este nombre apunte al nodo correcto \n// (probablemente el nodo \"Code\" clasificador o el \"If\").\nconst previousNodeName = \"Empleados Vigentes - Bizneo\"; \n\n// Traemos los datos originales de ese nodo para tener los nombres a mano\nconst originalItems = $(previousNodeName).all();\n\nconst foundEmployees = items.map((item, index) => {\n  const edges = item.json.data?.customers?.edges;\n\n  // CAMBIO CLAVE: Verificamos si 'edges' TIENE datos (length > 0)\n  // Esto significa que el cliente YA EXISTE en Shopify\n  if (edges && edges.length > 0) {\n    \n    // Obtenemos el ID de Shopify (necesario para editar/borrar tags después)\n    const shopifyCustomer = edges[0].node;\n\n    // RECUPERACIÓN DE DATOS ORIGINALES (BIZNEO):\n    // Usamos la misma lógica robusta para encontrar el dato original\n    let originalData;\n    \n    if (item.pairedItem && item.pairedItem.length > 0) {\n        const originalIndex = item.pairedItem[0].item;\n        originalData = originalItems[originalIndex].json;\n    } else {\n        originalData = originalItems[index].json;\n    }\n\n    return {\n      json: {\n        status: \"ENCONTRADO EN SHOPIFY\",\n        shopify_id: shopifyCustomer.id,   // <--- ESTO ES LO IMPORTANTE PARA EL SIGUIENTE NODO\n        shopify_email: shopifyCustomer.email,\n        current_tags: shopifyCustomer.tags, // Útil para ver qué etiquetas tiene ahora\n        // Datos originales de Bizneo (por si los necesitas para logs)\n        bizneo_first_name: originalData.first_name,\n        bizneo_last_name: originalData.last_name\n      }\n    };\n  }\n  \n  return null; // Si NO se encontró (edges vacío), lo ignoramos aquí\n}).filter(item => item !== null); // Limpiamos los nulos y nos quedamos solo con los encontrados\n\nreturn foundEmployees;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        304,
        160
      ],
      "id": "2a1a8e87-752b-4cd3-8a5c-77c852d451e1",
      "name": "Existe en Shopify"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation removeEmployeeTag($id: ID!, $tags: [String!]!) {\n  tagsRemove(id: $id, tags: $tags) {\n    node {\n      id\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"id\": \"{{ $json.shopify_id }}\",\n  \"tags\": [\"Empleado\"]\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        656,
        160
      ],
      "id": "f4ea09c5-285f-4b49-bd67-2ad2893c6692",
      "name": "Quitar etiqueta del Cliente",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-01-14T08:03:27.797Z",
      "createdAt": "2026-01-14T08:03:27.797Z",
      "role": "workflow:owner",
      "workflowId": "UmKsPhbqKY4r9YDi9-dc0",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-14T08:03:27.000Z",
  "versionId": "a3c7e1a5-b292-4b8b-aafc-30f860ada449"
}