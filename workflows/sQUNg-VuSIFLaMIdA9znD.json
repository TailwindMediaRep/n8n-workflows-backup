{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-02-05T13:22:45.000Z",
    "createdAt": "2026-02-05T13:22:44.075Z",
    "versionId": "824e44fe-4ef3-44f3-9adc-06bbeafdb2e4",
    "workflowId": "sQUNg-VuSIFLaMIdA9znD",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "informeDiario",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          448,
          480
        ],
        "id": "3a169d65-fc08-45f0-a1c1-197ef4d4aa08",
        "name": "Webhook",
        "webhookId": "7c1e3b37-6cc8-4f4a-81e3-c5897bdf497c"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
          "query": "query getOrder($id: ID!) {\n\n  order(id: $id) {\n\n    id\n\n    name\n\n    createdAt\n\n    email\n\n    totalPriceSet {\n\n      shopMoney {\n\n        amount\n\n        currencyCode\n\n      }\n\n    }\n\n    lineItems(first: 10) {\n\n      edges {\n\n        node {\n\n          title\n\n          quantity\n\n          originalUnitPriceSet {\n\n            shopMoney {\n\n              amount\n\n              currencyCode\n\n            }\n\n          }\n\n        }\n\n      }\n\n    }\n\n    fulfillments {\n\n      id\n\n      location {\n\n        name\n\n        address {\n\n          address1\n\n          city\n\n          province\n\n          country\n\n          zip\n\n        }\n\n      }\n\n    }\n\n    transactions(first: 5) {\n\n      formattedGateway\n\n      kind\n\n      status\n\n    }\n\n    customer {\n\n      firstName\n\n      lastName\n\n      email\n\n    }\n\n  }\n\n}\n",
          "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $('Webhook').item.json.body.id }}\"\n}",
          "headerParametersUi": {
            "parameter": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          832,
          480
        ],
        "id": "7255d822-ea0d-446d-83c9-1aee124ad0e8",
        "name": "GraphQL",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "content": "ENVIAR CORREO",
          "height": 208,
          "width": 384,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          400,
          768
        ],
        "id": "070b8235-6802-470b-bd7a-884c6711458e",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "operation": "copy",
          "fileId": {
            "__rl": true,
            "value": "1QZ-GBz6D6EL4fZh3lh9PyAjwWzyjVn8nN0wy4mUjg04",
            "mode": "id"
          },
          "name": "=Informe_Diario_{{ $json.FECHA }}",
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          864,
          128
        ],
        "id": "67d0cf56-a4b3-432d-9ab3-2b819b9f63a8",
        "name": "Copy file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "N7JXWgOiVoyCTaVL",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "content": "CREAR DOCUMENTO",
          "height": 208,
          "width": 960,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          400,
          80
        ],
        "id": "2b6bbfe7-3af9-4eb7-a19d-ec2a3322de91",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {}
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.3,
        "position": [
          432,
          128
        ],
        "id": "62e5fa32-0ae7-493b-875f-e37addba632a",
        "name": "Schedule Trigger"
      },
      {
        "parameters": {
          "dataTableId": {
            "__rl": true,
            "value": "8GDVj673ag0hCrVt",
            "mode": "list",
            "cachedResultName": "Informe Mensual",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/8GDVj673ag0hCrVt"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "ID_Documento": "={{ $('Copy file').item.json.id }}",
              "fecha": "={{ $('formatear fecha').item.json.FECHA }}"
            },
            "matchingColumns": [
              "ID_Documento"
            ],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "fecha",
                "displayName": "fecha",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          1168,
          128
        ],
        "id": "e5db14bd-7dca-40a9-bee1-b422e5e5f4a0",
        "name": "Insert row"
      },
      {
        "parameters": {
          "jsCode": "// El nodo Code de n8n espera que devolvamos un array de objetos.\nconst outputItems = [];\n\n// Obtenemos el valor del contador del nodo anterior\n// items[0].json.Contador → 2 en tu ejemplo\nlet numeroFila = items[0].json.Contador;\nlet ID_documento = items[0].json.ID_Documento;\n\n// 1. Accedemos al cuerpo real del pedido de Shopify, que está anidado.\nconst orderBody = $node['Webhook'].json.body; \n\n// 2. Extraemos los artículos de línea (productos) y la moneda.\nconst lineItems = orderBody.line_items;\nconst orderCurrency = orderBody.currency;\n\n// Iteramos sobre cada producto individual\nfor (const item of lineItems) {\n\n  const originalPrice = parseFloat(item.price);\n\n  let totalDiscountAmount = 0;\n  for (const allocation of item.discount_allocations) {\n    totalDiscountAmount += parseFloat(allocation.amount);\n  }\n\n  const finalPaidPrice = originalPrice - totalDiscountAmount;\n\n  // Creamos un nuevo objeto y añadimos \"numero_fila\"\n  outputItems.push({\n    json: {\n      ID_documento: ID_documento,\n      numero_fila: numeroFila,   // ← Nuevo campo\n      product_name: item.title,\n      sku: item.sku,\n      variant_title: item.variant_title,\n      original_price: originalPrice.toFixed(2),\n      total_discount_applied: totalDiscountAmount.toFixed(2),\n      final_paid_price: finalPaidPrice.toFixed(2),\n      currency: orderCurrency\n    }\n  });\n\n  // ↑ Incrementamos para el siguiente item\n  numeroFila++;\n}\n\n// Devolvemos el array con los nuevos objetos.\nreturn outputItems;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          832,
          624
        ],
        "id": "f74317cd-37d0-4262-a761-d94cdf479b6a",
        "name": "Code in JavaScript"
      },
      {
        "parameters": {
          "numberInputs": 3
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          1072,
          464
        ],
        "id": "5007c6bb-31eb-4b15-be8a-fb06c3e7962e",
        "name": "Merge"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "31828549-6a33-4e8a-91ad-fdb9692a7e34",
                "name": "SUCURSAL DE VENTA",
                "value": "={{ $json.fulfillmentLocation }}",
                "type": "string"
              },
              {
                "id": "e89736ae-2f29-40c8-80b4-2181722ee3f5",
                "name": "METODO DE PAGO",
                "value": "={{ $json.transactionGateway }}",
                "type": "string"
              },
              {
                "id": "dc4a77f5-966d-4efc-b755-1f0fe34f6958",
                "name": "COSTO POR UNIDAD",
                "value": "={{ $json.product.unit_cost }}",
                "type": "string"
              },
              {
                "id": "76140f31-efab-4a68-b737-53f04a9a7b81",
                "name": "COSTE DE PRODUCTO",
                "value": "={{ $json.product.original_price }}",
                "type": "string"
              },
              {
                "id": "d295df2e-e935-41ef-a2b1-7923cabd1a92",
                "name": "PRECIO PAGADO",
                "value": "={{ $json.product.final_paid_price }}",
                "type": "string"
              },
              {
                "id": "adb9ae5a-50d9-4923-b706-31a9a5b86e66",
                "name": "DESCUENTO",
                "value": "={{ $json.product.total_discount_applied }}",
                "type": "string"
              },
              {
                "id": "c2b11c61-81c1-4b6d-94ec-c55b6872e5e0",
                "name": "NOMBRE DE PRODUCTO",
                "value": "={{ $json.product.product_name }}",
                "type": "string"
              },
              {
                "id": "f7cbe128-fbe4-4bfb-b5ec-d7eed2f87b84",
                "name": "VARIANTE",
                "value": "={{ $json.product.variant_title }}",
                "type": "string"
              },
              {
                "id": "1e31a3b3-a073-4113-9047-95110c3d7987",
                "name": "NUMERO_FILA",
                "value": "={{ $json.product.numero_fila }}",
                "type": "number"
              },
              {
                "id": "e4c20adf-aa16-46e1-9851-3844e08241a6",
                "name": "ID_DOCUMENTO",
                "value": "={{ $json.product.ID_documento }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1344,
          480
        ],
        "id": "b52e6336-e7f7-40dd-ad46-c520b057c406",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "jsCode": "// 1. Validaciones básicas\nif (items.length < 2) {\n    throw new Error(\"Se esperaban al menos 2 ítems de entrada.\");\n}\n\n// Inicializamos variables\nlet orderData = null;\nconst productRows = []; // Aquí guardaremos los ítems que tienen ID_documento\nconst costMap = {}; // Aquí guardaremos los costos indexados por SKU\n\n// 2. Clasificar los ítems de entrada\nfor (const item of items) {\n    const json = item.json;\n\n    // A) Es la ORDEN (tiene data.order)\n    if (json.data && json.data.order) {\n        orderData = json.data.order;\n    } \n    // B) Es información de COSTO de Shopify (tiene data.productVariant)\n    else if (json.data && json.data.productVariant) {\n        const variant = json.data.productVariant;\n        const sku = variant.sku;\n        const costAmount = variant.inventoryItem?.unitCost?.amount;\n        \n        // Guardamos el costo en un objeto usando el SKU como clave para buscarlo rápido después\n        if (sku && costAmount) {\n            costMap[sku] = costAmount;\n        }\n    }\n    // C) Es el ítem procesado (tiene ID_documento)\n    else if (json.ID_documento) {\n        productRows.push(json);\n    }\n}\n\nif (!orderData) {\n    throw new Error(\"No se encontró el ítem de la orden de Shopify.\");\n}\n\nif (productRows.length === 0) {\n    throw new Error(\"No se encontraron ítems de producto con ID_documento.\");\n}\n\n// 3. Crear objeto base de la orden\nconst baseOrderData = {\n    id: orderData.id,\n    name: orderData.name,\n    createdAt: orderData.createdAt,\n    totalPrice: orderData.totalPriceSet?.shopMoney?.amount || 'N/A',\n    currencyCode: orderData.totalPriceSet?.shopMoney?.currencyCode || 'N/A',\n    \n    // Datos del cliente\n    customer: orderData.customer,\n    \n    // Datos de envío\n    fulfillmentLocation: orderData.fulfillments?.[0]?.location?.name || 'N/A',\n    fulfillmentAddress: orderData.fulfillments?.[0]?.location?.address || 'N/A',\n    \n    // Datos de la transacción\n    transactionGateway: orderData.transactions?.[0]?.formattedGateway || 'N/A',\n    transactionKind: orderData.transactions?.[0]?.kind || 'N/A',\n    transactionStatus: orderData.transactions?.[0]?.status || 'N/A',\n};\n\n// 4. Iterar sobre los productos y fusionar (incluyendo el costo encontrado)\nconst combinedItems = [];\n\nfor (const productData of productRows) {\n    \n    // Buscamos si existe un costo guardado para este SKU\n    const sku = productData.sku;\n    const unitCost = costMap[sku] || '0.00'; // Si no encuentra match, pone 0.00 o N/A\n\n    const combinedItem = {\n        ...baseOrderData,\n        \n        product: {\n            ID_documento: productData.ID_documento,\n            numero_fila: productData.numero_fila,\n            product_name: productData.product_name,\n            sku: productData.sku,\n            variant_title: productData.variant_title,\n            original_price: productData.original_price,\n            total_discount_applied: productData.total_discount_applied,\n            final_paid_price: productData.final_paid_price,\n            currency: productData.currency,\n            // Aquí agregamos el campo solicitado\n            unit_cost: unitCost \n        }\n    };\n    \n    combinedItems.push({\n        json: combinedItem,\n    });\n}\n\nreturn combinedItems;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1200,
          480
        ],
        "id": "38bbf384-1b40-4d4d-b5cc-97d8454a7303",
        "name": "Code in JavaScript1"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "ID_Documento": "={{ $json.id }}",
              "Contador": 2,
              "Contador_Alquiler": 2
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          1008,
          128
        ],
        "id": "954c39f5-d1ab-48b0-a72f-d98b54032d3b",
        "name": "Update row(s)"
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          624,
          480
        ],
        "id": "4f754bc8-b2f2-4dd8-a946-e584b5dab050",
        "name": "Get row(s)"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $json.ID_DOCUMENTO}}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "gid=0",
            "mode": "list",
            "cachedResultName": "Hoja 1",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19bvtVxQK6uMbxP2HZKgGEGM_KWyvJM3vLp1APRSSTEY/edit#gid=0"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.NUMERO_FILA }}",
              "SUCURSAL DE VENTA": "={{ $json['SUCURSAL DE VENTA'] }}",
              "MÉTODO DE PAGO": "={{ $json['METODO DE PAGO'] }}",
              "COSTE POR UNIDAD": "={{ $json['COSTO POR UNIDAD'] }}",
              "PRECIO DE PRODUCTO": "={{ $json['COSTE DE PRODUCTO'] }}",
              "PRECIO PAGADO": "={{ $json['PRECIO PAGADO'] }}",
              "DESCUENTO": "={{ $json.DESCUENTO }}",
              "NOMBRE DE PRODUCTO": "={{ $json['NOMBRE DE PRODUCTO'] }}",
              "VARIANTE": "={{ $json.VARIANTE }}",
              "ID PEDIDO": "={{ $('Webhook').first().json.body.id }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "SUCURSAL DE VENTA",
                "displayName": "SUCURSAL DE VENTA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "COSTE POR UNIDAD",
                "displayName": "COSTE POR UNIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO DE PRODUCTO",
                "displayName": "PRECIO DE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO PAGADO",
                "displayName": "PRECIO PAGADO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "DESCUENTO",
                "displayName": "DESCUENTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE DE PRODUCTO",
                "displayName": "NOMBRE DE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "VARIANTE",
                "displayName": "VARIANTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "SURFIN SIERRA NEVADA",
                "displayName": "SURFIN SIERRA NEVADA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Tarjeta",
                "displayName": "Tarjeta",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Efectivo",
                "displayName": "Efectivo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Venta Web",
                "displayName": "Venta Web",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL",
                "displayName": "TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          1488,
          480
        ],
        "id": "3456907e-1889-4e9d-87b5-40ea7f7453de",
        "name": "Update row in sheet",
        "executeOnce": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "ID_Documento": "={{ $('Edit Fields').item.json.ID_DOCUMENTO }}",
              "Contador": "={{ $('Edit Fields').item.json.NUMERO_FILA  + 1}}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          1648,
          480
        ],
        "id": "faf01950-eda5-4601-8b6c-75240e769c87",
        "name": "Update row(s)1"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
          "query": "query getVariantCost($id: ID!) {\n  productVariant(id: $id) {\n    id\n    sku\n    title\n    inventoryItem {\n      id\n      unitCost {\n        amount\n        currencyCode\n      }\n    }\n  }\n}\n\n",
          "variables": "={\n  \"id\": \"{{ $json['ID VARIANTE'] }}\"\n}",
          "headerParametersUi": {
            "parameter": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          896,
          336
        ],
        "id": "0547d26f-e2d4-4a83-ad9a-3b3f4097a3c2",
        "name": "GraphQL1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "711be730-983a-47e6-99f2-d818a44482be",
                "name": "ID VARIANTE",
                "value": "=gid://shopify/ProductVariant/{{ $('Webhook').item.json.body.line_items[0].variant_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          784,
          336
        ],
        "id": "296715bd-4cb8-4930-a0d7-966761cc3f3b",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "87a5aeba-2adf-47d1-8d7b-b55d5016266a",
                "name": "FECHA",
                "value": "={{ $today }}",
                "type": "object"
              }
            ]
          },
          "options": {
            "ignoreConversionErrors": true
          }
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          576,
          128
        ],
        "id": "fccdf808-f4e0-4782-a70b-a6b6e00c2e42",
        "name": "obtener fecha"
      },
      {
        "parameters": {
          "jsCode": "return items.map(item => {\n  const fecha = new Date(item.json.FECHA);\n\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const anio = fecha.getFullYear();\n\n  item.json.FECHA = `${dia}/${mes}/${anio}`;\n\n  return item;\n});\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          720,
          128
        ],
        "id": "a2ae42c0-c272-4555-ae7f-445636e14ba8",
        "name": "formatear fecha"
      },
      {
        "parameters": {
          "content": "ACTUALIZAR DOCUMENTO CON CADA PEDIDO",
          "height": 448,
          "width": 1632,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          400,
          304
        ],
        "id": "851e0c70-842c-46c7-a56a-b490e4cc792d",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "sendTo": "emilianomartinezvrd@gmail.com",
          "subject": "Informe diario mamawebaso",
          "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333333;\">\n  \n  <h2 style=\"color: #2c3e50; border-bottom: 2px solid #007bff; padding-bottom: 10px;\">\n    INFORME DIARIO ({{ $now.toFormat('dd/MM/yyyy') }})\n  </h2>\n\n  <p>Hola,</p>\n  \n  <p>Aquí tienes el informe actualizado correspondiente al día de hoy.</p>\n  <p>Puedes acceder al archivo o recurso haciendo clic en el siguiente botón:</p>\n\n  <div style=\"margin: 30px 0;\">\n    <a href=\"https://docs.google.com/spreadsheets/d/{{ $json.ID_Documento }}/edit?gid=0#gid=0\" \n       style=\"background-color: #007bff; color: #ffffff; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n       VER DOCUMENTO\n    </a>\n  </div>\n\n  <p style=\"font-size: 12px; color: #888;\">\n    Este es un mensaje automático enviado por tu flujo de n8n.\n  </p>\n  \n</div>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          592,
          816
        ],
        "id": "e0a1443f-7789-45c3-88a0-4471df57e63a",
        "name": "Send a message",
        "webhookId": "395b376a-113e-4e7e-b92d-4afaa0028904",
        "credentials": {
          "gmailOAuth2": {
            "id": "wR7U82S8bmDH4odC",
            "name": "info@tailwind.es"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          432,
          816
        ],
        "id": "6762e93d-c33c-4008-9d9c-7fd70d47fbf5",
        "name": "Get row(s)1"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Correo').item.json.from.text }}",
                      "rightValue": "=reservas@rules-shop.es",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "5702ef6b-4e43-4933-9af3-abf329de5e06"
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "1384d8f9-c75c-4be1-a293-98c0d102292b",
                      "leftValue": "={{ $('Correo').item.json.from.text }}",
                      "rightValue": "reservas@surfin.es",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "fe1d90fc-f649-48e8-9f37-c58ef22f10c7",
                      "leftValue": "={{ $('Correo').item.json.from.text }}",
                      "rightValue": "reservas@snowdivision.es",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "06d5176e-59be-4584-9efb-c8a5f233789c",
                      "leftValue": "={{ $('Correo').item.json.from.value[0].address }}",
                      "rightValue": "info@sierranevadagranada.com",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          -416,
          448
        ],
        "id": "fa3ccb4f-aef5-4d7b-a691-90267f5171fe",
        "name": "Switch"
      },
      {
        "parameters": {
          "jsCode": "// -----------------------------------------------------------\n// 1. OBTENCIÓN DE DATOS (CRUCIAL: Combinamos fuentes)\n// -----------------------------------------------------------\n\n// A) Datos que vienen del flujo (Switch -> GetRow) -> Aquí está el Contador\nconst flujoDatos = $input.first().json; \nconst contadorBase = parseInt(flujoDatos.Contador_Alquiler) || 0;\n\n// B) Datos del Email -> Los forzamos a leer del nodo original \"Correo\"\n// NOTA: Si tu nodo de Gmail se llama distinto de \"Correo\", cambia el nombre aquí abajo.\nlet emailData = {};\ntry {\n    emailData = $('Correo').first().json; \n} catch(e) {\n    // Si falla (ej. probando solo este nodo), intentamos leer del input normal\n    console.log(\"Aviso: No se pudo leer el nodo 'Correo', usando input local.\");\n    emailData = flujoDatos; \n}\n\n// -----------------------------------------------------------\n// 2. EXTRACCIÓN Y NORMALIZACIÓN\n// -----------------------------------------------------------\n\nconst subject = (emailData.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = emailData.text || \"\";\n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente (Nombre y Apellidos)\nlet nombre = \"No encontrado\";\nlet apellidos = \"\";\nlet nombreCompleto = \"\";\n\n// Subject esperado: \"Rules - Compra efectuada - Pedro Villalba Martínez - canal Reservas\"\nconst partesAsunto = subject.split(\" - \");\n\nif (partesAsunto.length >= 3) {\n    nombreCompleto = partesAsunto[2].trim();\n    // Dividimos: Primera palabra es nombre, el resto apellidos\n    const nombrePartes = nombreCompleto.split(\" \");\n    if (nombrePartes.length > 0 && nombrePartes[0] !== \"\") {\n        nombre = nombrePartes[0];\n        apellidos = nombrePartes.slice(1).join(\" \");\n    }\n}\n\n// 5. Extraer Email del Cliente\n// Priorizamos la estructura limpia del JSON\nlet clienteEmail = \"No encontrado\";\n\nif (emailData.to?.value?.[0]?.address) {\n    clienteEmail = emailData.to.value[0].address;\n} else if (emailData.headers && emailData.headers['delivered-to']) {\n    // Fallback por si la estructura cambia\n    clienteEmail = emailData.headers['delivered-to'].replace(\"Delivered-To: \", \"\").trim();\n}\n\n// -----------------------------------------------------------\n// 6. Extraer Datos del Pedido y Método de Pago (CORREGIDO)\n// -----------------------------------------------------------\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/i);\nconst precioTotal = totalMatch ? totalMatch[1].trim() : \"0.00\";\n\nconst orderMatch = bodyText.match(/Identificador:\\s*([A-Z0-9]+)/i);\nconst idPedido = orderMatch ? orderMatch[1].trim() : \"No encontrado\";\n\nconst canalMatch = bodyText.match(/Canal:\\s*([^\\n\\r]+)/i);\nconst canalVenta = canalMatch ? canalMatch[1].trim() : \"Desconocido\";\n\n// CORRECCIÓN: Lógica ampliada para detectar \"Card checkout\"\nlet metodoPago = \"No encontrado\";\n\nif (/Card checkout/i.test(bodyText)) {\n    metodoPago = \"Card checkout\";\n} else if (/Bank card/i.test(bodyText)) {\n    metodoPago = \"Bank card\";\n} else if (/Tarjeta/i.test(bodyText)) {\n    metodoPago = \"Tarjeta\";\n} else if (/PayPal/i.test(bodyText)) {\n    metodoPago = \"PayPal\";\n}\n\n// -----------------------------------------------------------\n// 7. Extraer y Agrupar Productos\n// -----------------------------------------------------------\nconst productosMap = {};\n// Regex: NOMBRE (MAYUS) + espacios + CANTIDAD + espacios + PRECIO + €\nconst productRegex = /([A-ZÁÉÍÓÚÑ0-9\\s\\-]{3,})\\s+(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    // Filtros para evitar leer encabezados como productos\n    if (nombreProd === \"DETALLES DEL PEDIDO\" || \n        nombreProd === \"PAGOS ASOCIADOS AL PEDIDO\" || \n        nombreProd.length > 60) continue;\n\n    // Normalización\n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n\n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad, \n            precio_unitario: precioUnitario \n        };\n    }\n}\n\n// -----------------------------------------------------------\n// 8. GENERAR SALIDA\n// -----------------------------------------------------------\nconst productosArray = Object.values(productosMap);\n\n// Si no hay productos, fila de seguridad\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"Producto no detectado\", cantidad: 1, precio_unitario: precioTotal });\n}\n\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n    const esPrimeraFila = index === 0;\n\n    return {\n        json: {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": esPrimeraFila ? marca : \"\",\n            \"cliente_nombre\": esPrimeraFila ? nombre : \"\",\n            \"cliente_apellidos\": esPrimeraFila ? apellidos : \"\",\n            \"cliente_email\": esPrimeraFila ? clienteEmail : \"\",\n            \"id_pedido\": esPrimeraFila ? idPedido : \"\",\n            \"canal\": esPrimeraFila ? canalVenta : \"\",\n            \"metodo_pago\": esPrimeraFila ? metodoPago : \"\", // Aquí saldrá ahora \"Card checkout\"\n            \"total_compra\": esPrimeraFila ? precioTotal : \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": esPrimeraFila ? resumenTexto : \"\"\n        }\n    };\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -224,
          272
        ],
        "id": "132c4e3b-b445-4f4b-bdff-7374f9e5ff18",
        "name": "rules-shop"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca\nconst marca = subject.includes(\"Surfin\") ? \"Surfin\" : (subject.includes(\"Snow Division\") ? \"Snow Division\" : \"Rules\");\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No indicado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3 && partesAsunto[2].trim() !== \"\") {\n    nombreCompleto = partesAsunto[2].trim();\n}\n\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"No indicado\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\n\nconst clienteEmail = (correoOriginal.to?.value?.[0]?.address || correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\n\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /PRODUCTO\\n\\n(\\d+)\\s+([\\d,.]+)€\\n\\nLocalizador:\\s*([a-z0-9]+)\\nConcepto:\\s*([^\\n]+)/gi;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y normalizamos espacios\n    let nombreProd = match[4].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim().toUpperCase();\n    const cantidad = parseInt(match[1]);\n    const precioUnitario = match[2].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Fallback si el anterior no captura nada\nif (Object.keys(productosMap).length === 0) {\n    const fallbackRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\n    let fallbackMatch;\n    while ((fallbackMatch = fallbackRegex.exec(bodyText)) !== null) {\n        // LIMPIEZA: También en el fallback\n        let nProd = fallbackMatch[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n        if (nProd.includes(\"2X1\")) nProd = \"EQUIPO ESQUÍ 2X1\";\n        const cant = parseInt(fallbackMatch[2]);\n        const prec = fallbackMatch[3].replace(',', '.').replace(/\\n/g, '').trim();\n        if (productosMap[nProd]) productosMap[nProd].cantidad += cant;\n        else productosMap[nProd] = { nombre: nProd, cantidad: cant, precio_unitario: prec };\n    }\n}\n\n// 9. CREAR SALIDA DIFERENCIADA\nconst productosArray = Object.values(productosMap);\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"0.00\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"id_pedido\": idPedido,\n            \"cliente_email\": clienteEmail,\n            \"canal\": canalVenta,\n            \"metodo_pago\": metodoPago,\n            \"total_compra\": precioTotal,\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\", \n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"canal\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -224,
          416
        ],
        "id": "d58a6580-401b-4d55-bc2f-a2bcb34c3ee5",
        "name": "surfin"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0; \n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3) {\n    nombreCompleto = partesAsunto[2].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.to.value[0].address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Eliminamos saltos de línea y colapsamos espacios múltiples en el nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Generar salida plana para Google Sheets\nconst productosArray = Object.values(productosMap);\n// LIMPIEZA: Resumen sin saltos de línea para que no rompa la celda\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": metodoPago,\n            \"total_compra\": precioTotal,\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -224,
          544
        ],
        "id": "9031743d-79e1-4b7d-a852-e3aa8b68164a",
        "name": "snowdivision"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "MARCA": "={{ $json.marca }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}",
              "row_number": "={{ $json.numero_fila }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -48,
          544
        ],
        "id": "7367a66d-8df9-476b-8c0b-5479607fb339",
        "name": "Escribir SnowDivision",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "MARCA": "={{ $json.marca }}",
              "row_number": "={{ $json.numero_fila }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -48,
          416
        ],
        "id": "e4cb0885-b4e6-46e5-abc8-ced7e117233d",
        "name": "Escribir Surfin",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": 398140035,
            "mode": "list",
            "cachedResultName": "Alquiler",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1V2qK7u_JPZQKXU3RS2LqFDM4J9AV8yMHAnwnK8V1IDo/edit#gid=398140035"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.numero_fila }}",
              "MARCA": "={{ $json.marca }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -48,
          272
        ],
        "id": "9262d50b-9185-4607-81c6-ad91edd89465",
        "name": "Escribir Rules",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador": "={{ $('Get row(s)2').first().json.Contador }}",
              "Contador_Alquiler": "={{ $json.row_number + 1}}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          112,
          272
        ],
        "id": "520dc12b-583c-40bd-80d8-b54401ade2f1",
        "name": "actualizar contador rules"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').first().json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          112,
          416
        ],
        "id": "6b0db584-2a39-46bb-902d-9131fa4ce1e0",
        "name": "actualizar contador surfin"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').first().json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {
            "dryRun": false
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          112,
          544
        ],
        "id": "56f1f664-3f3e-480a-84a8-f9067fb0d648",
        "name": "actualizar contador snowdivision"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original del nodo \"Correo\"\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior ($input)\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca (Sierra Nevada Granada)\nlet marca = \"Sierra Nevada Granada\";\n\n// 4. Extraer Datos del Cliente del Subject\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 2) {\n    nombreCompleto = partesAsunto[1].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Identificador del Pedido (Número: SO...)\nconst orderMatch = bodyText.match(/N[úu]mero:\\s*(SO\\d+)/i);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal de Venta\nconst canalVenta = partesAsunto[2] ? partesAsunto[2].replace(\"canal \", \"\").replace(/\\n/g, ' ').trim() : \"Reservas\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\n\n/** * Regex para el formato Sierra Nevada: Limpia saltos de línea dentro del nombre\n */\nconst productRegex = /Descripci[óo]n\\s+Cant\\.\\s+([\\w\\sÁÉÍÓÚÑ\\-]+?)\\s+(\\d+[\\d,.]*)/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y espacios múltiples del nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    nombreProd = nombreProd.split('  ')[0].trim(); // Evita capturar cabeceras si se filtran\n    \n    const cantidad = parseInt(match[2].split(',')[0]);\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad: cantidad, \n            precio_unitario: \"Ver email\" \n        };\n    }\n}\n\n// 8. Búsqueda de emergencia para Forfaits (limpia también)\nif (Object.keys(productosMap).length === 0) {\n    const forfaitMatch = bodyText.match(/Forfait\\s+D[íi]as\\s+Consecutivos/i);\n    if (forfaitMatch) {\n        productosMap[\"FORFAIT DÍAS CONSECUTIVOS\"] = { nombre: \"FORFAIT DÍAS CONSECUTIVOS\", cantidad: 1, precio_unitario: \"Ver email\" };\n    }\n}\n\n// 9. Generar salida para Google Sheets\nconst productosArray = Object.values(productosMap);\n// Resumen unificado en una sola línea\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"Ver email\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": \"Tarjeta\",\n            \"total_compra\": \"Ver justificante\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -224,
          688
        ],
        "id": "639143ee-f6eb-4832-af8e-48d41053a656",
        "name": "sierranevadagranada"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.numero_fila }}",
              "MARCA": "={{ $json.marca }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -48,
          688
        ],
        "id": "bdcbbe12-2485-403b-bbd0-1b060ee75634",
        "name": "Escribir sierranevadagranada",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').first().json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          112,
          688
        ],
        "id": "f91d9064-be06-467e-a244-f6f1999fc426",
        "name": "actualizar contador sierranevadagranada"
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -576,
          480
        ],
        "id": "162dccd0-13f7-427e-8032-e9547d607c67",
        "name": "Get row(s)2"
      },
      {
        "parameters": {
          "pollTimes": {
            "item": [
              {
                "mode": "everyMinute"
              }
            ]
          },
          "simple": false,
          "filters": {
            "q": "from: (reservas@rules-shop.es OR reservas@surfin.es OR reservas@snowdivision.es OR info@sierranevadagranada.com)"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.gmailTrigger",
        "typeVersion": 1.3,
        "position": [
          -736,
          480
        ],
        "id": "424c4c3d-50d2-4125-9517-d6184f95d5d8",
        "name": "Correo",
        "credentials": {
          "gmailOAuth2": {
            "id": "fha7KwAzrDSA7OXO",
            "name": "ventas@sierranevadagranada.com"
          }
        }
      },
      {
        "parameters": {
          "content": "INFORME DIARIO DE ALQUILERES\n",
          "height": 624,
          "width": 1120,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -784,
          240
        ],
        "id": "62875833-b388-4db3-8958-e726c4d976d9",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "Pedidos-Documentos",
            "mode": "list",
            "cachedResultName": "Pedidos-Documentos"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "id_pedido": "={{ $('Update row in sheet').item.json[\"ID PEDIDO\"] }}",
              "id_documento": "={{ $('Get row(s)').first().json.ID_Documento }}",
              "fecha": "={{ $now.format('dd/LL/yyyy') }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "id_pedido",
                "displayName": "id_pedido",
                "required": true,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true
              },
              {
                "id": "id_documento",
                "displayName": "id_documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "fecha",
                "displayName": "fecha",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "dateTime",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          1808,
          480
        ],
        "id": "7dab9750-96c6-4a7d-97c9-100169c69795",
        "name": "Insert rows in a table",
        "credentials": {
          "postgres": {
            "id": "UPETCYNZNCReuZu8",
            "name": "Postgres Supabase"
          }
        }
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Get row(s)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Copy file": {
        "main": [
          [
            {
              "node": "Update row(s)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Schedule Trigger": {
        "main": [
          [
            {
              "node": "obtener fecha",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 2
            }
          ]
        ]
      },
      "Merge": {
        "main": [
          [
            {
              "node": "Code in JavaScript1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Update row in sheet",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript1": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update row(s)": {
        "main": [
          [
            {
              "node": "Insert row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)": {
        "main": [
          [
            {
              "node": "GraphQL",
              "type": "main",
              "index": 0
            },
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            },
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update row in sheet": {
        "main": [
          [
            {
              "node": "Update row(s)1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL1": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "GraphQL1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "obtener fecha": {
        "main": [
          [
            {
              "node": "formatear fecha",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "formatear fecha": {
        "main": [
          [
            {
              "node": "Copy file",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)1": {
        "main": [
          [
            {
              "node": "Send a message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "rules-shop",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "surfin",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "snowdivision",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "sierranevadagranada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "rules-shop": {
        "main": [
          [
            {
              "node": "Escribir Rules",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "surfin": {
        "main": [
          [
            {
              "node": "Escribir Surfin",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "snowdivision": {
        "main": [
          [
            {
              "node": "Escribir SnowDivision",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir SnowDivision": {
        "main": [
          [
            {
              "node": "actualizar contador snowdivision",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir Surfin": {
        "main": [
          [
            {
              "node": "actualizar contador surfin",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir Rules": {
        "main": [
          [
            {
              "node": "actualizar contador rules",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "sierranevadagranada": {
        "main": [
          [
            {
              "node": "Escribir sierranevadagranada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir sierranevadagranada": {
        "main": [
          [
            {
              "node": "actualizar contador sierranevadagranada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)2": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Correo": {
        "main": [
          [
            {
              "node": "Get row(s)2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update row(s)1": {
        "main": [
          [
            {
              "node": "Insert rows in a table",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Tailwind Media",
    "name": "Version 824e44fe",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "824e44fe-4ef3-44f3-9adc-06bbeafdb2e4",
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Copy file": {
      "main": [
        [
          {
            "node": "Update row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "obtener fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row(s)": {
      "main": [
        [
          {
            "node": "Insert row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "GraphQL",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Update row(s)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "GraphQL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener fecha": {
      "main": [
        [
          {
            "node": "formatear fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formatear fecha": {
      "main": [
        [
          {
            "node": "Copy file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)1": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "rules-shop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "surfin",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "snowdivision",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "sierranevadagranada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "rules-shop": {
      "main": [
        [
          {
            "node": "Escribir Rules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "surfin": {
      "main": [
        [
          {
            "node": "Escribir Surfin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "snowdivision": {
      "main": [
        [
          {
            "node": "Escribir SnowDivision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir SnowDivision": {
      "main": [
        [
          {
            "node": "actualizar contador snowdivision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir Surfin": {
      "main": [
        [
          {
            "node": "actualizar contador surfin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir Rules": {
      "main": [
        [
          {
            "node": "actualizar contador rules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sierranevadagranada": {
      "main": [
        [
          {
            "node": "Escribir sierranevadagranada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir sierranevadagranada": {
      "main": [
        [
          {
            "node": "actualizar contador sierranevadagranada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)2": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Correo": {
      "main": [
        [
          {
            "node": "Get row(s)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row(s)1": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-15T07:50:18.774Z",
  "id": "sQUNg-VuSIFLaMIdA9znD",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Informe_Diario_Definitivo",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "informeDiario",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        448,
        480
      ],
      "id": "3a169d65-fc08-45f0-a1c1-197ef4d4aa08",
      "name": "Webhook",
      "webhookId": "7c1e3b37-6cc8-4f4a-81e3-c5897bdf497c"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
        "query": "query getOrder($id: ID!) {\n\n  order(id: $id) {\n\n    id\n\n    name\n\n    createdAt\n\n    email\n\n    totalPriceSet {\n\n      shopMoney {\n\n        amount\n\n        currencyCode\n\n      }\n\n    }\n\n    lineItems(first: 10) {\n\n      edges {\n\n        node {\n\n          title\n\n          quantity\n\n          originalUnitPriceSet {\n\n            shopMoney {\n\n              amount\n\n              currencyCode\n\n            }\n\n          }\n\n        }\n\n      }\n\n    }\n\n    fulfillments {\n\n      id\n\n      location {\n\n        name\n\n        address {\n\n          address1\n\n          city\n\n          province\n\n          country\n\n          zip\n\n        }\n\n      }\n\n    }\n\n    transactions(first: 5) {\n\n      formattedGateway\n\n      kind\n\n      status\n\n    }\n\n    customer {\n\n      firstName\n\n      lastName\n\n      email\n\n    }\n\n  }\n\n}\n",
        "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $('Webhook').item.json.body.id }}\"\n}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        832,
        480
      ],
      "id": "7255d822-ea0d-446d-83c9-1aee124ad0e8",
      "name": "GraphQL",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "content": "ENVIAR CORREO",
        "height": 208,
        "width": 384,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        400,
        768
      ],
      "id": "070b8235-6802-470b-bd7a-884c6711458e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "copy",
        "fileId": {
          "__rl": true,
          "value": "1QZ-GBz6D6EL4fZh3lh9PyAjwWzyjVn8nN0wy4mUjg04",
          "mode": "id"
        },
        "name": "=Informe_Diario_{{ $json.FECHA }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        864,
        128
      ],
      "id": "67d0cf56-a4b3-432d-9ab3-2b819b9f63a8",
      "name": "Copy file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "N7JXWgOiVoyCTaVL",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "content": "CREAR DOCUMENTO",
        "height": 208,
        "width": 960,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        400,
        80
      ],
      "id": "2b6bbfe7-3af9-4eb7-a19d-ec2a3322de91",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        432,
        128
      ],
      "id": "62e5fa32-0ae7-493b-875f-e37addba632a",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "8GDVj673ag0hCrVt",
          "mode": "list",
          "cachedResultName": "Informe Mensual",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/8GDVj673ag0hCrVt"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Documento": "={{ $('Copy file').item.json.id }}",
            "fecha": "={{ $('formatear fecha').item.json.FECHA }}"
          },
          "matchingColumns": [
            "ID_Documento"
          ],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1168,
        128
      ],
      "id": "e5db14bd-7dca-40a9-bee1-b422e5e5f4a0",
      "name": "Insert row"
    },
    {
      "parameters": {
        "jsCode": "// El nodo Code de n8n espera que devolvamos un array de objetos.\nconst outputItems = [];\n\n// Obtenemos el valor del contador del nodo anterior\n// items[0].json.Contador → 2 en tu ejemplo\nlet numeroFila = items[0].json.Contador;\nlet ID_documento = items[0].json.ID_Documento;\n\n// 1. Accedemos al cuerpo real del pedido de Shopify, que está anidado.\nconst orderBody = $node['Webhook'].json.body; \n\n// 2. Extraemos los artículos de línea (productos) y la moneda.\nconst lineItems = orderBody.line_items;\nconst orderCurrency = orderBody.currency;\n\n// Iteramos sobre cada producto individual\nfor (const item of lineItems) {\n\n  const originalPrice = parseFloat(item.price);\n\n  let totalDiscountAmount = 0;\n  for (const allocation of item.discount_allocations) {\n    totalDiscountAmount += parseFloat(allocation.amount);\n  }\n\n  const finalPaidPrice = originalPrice - totalDiscountAmount;\n\n  // Creamos un nuevo objeto y añadimos \"numero_fila\"\n  outputItems.push({\n    json: {\n      ID_documento: ID_documento,\n      numero_fila: numeroFila,   // ← Nuevo campo\n      product_name: item.title,\n      sku: item.sku,\n      variant_title: item.variant_title,\n      original_price: originalPrice.toFixed(2),\n      total_discount_applied: totalDiscountAmount.toFixed(2),\n      final_paid_price: finalPaidPrice.toFixed(2),\n      currency: orderCurrency\n    }\n  });\n\n  // ↑ Incrementamos para el siguiente item\n  numeroFila++;\n}\n\n// Devolvemos el array con los nuevos objetos.\nreturn outputItems;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        624
      ],
      "id": "f74317cd-37d0-4262-a761-d94cdf479b6a",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1072,
        464
      ],
      "id": "5007c6bb-31eb-4b15-be8a-fb06c3e7962e",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "31828549-6a33-4e8a-91ad-fdb9692a7e34",
              "name": "SUCURSAL DE VENTA",
              "value": "={{ $json.fulfillmentLocation }}",
              "type": "string"
            },
            {
              "id": "e89736ae-2f29-40c8-80b4-2181722ee3f5",
              "name": "METODO DE PAGO",
              "value": "={{ $json.transactionGateway }}",
              "type": "string"
            },
            {
              "id": "dc4a77f5-966d-4efc-b755-1f0fe34f6958",
              "name": "COSTO POR UNIDAD",
              "value": "={{ $json.product.unit_cost }}",
              "type": "string"
            },
            {
              "id": "76140f31-efab-4a68-b737-53f04a9a7b81",
              "name": "COSTE DE PRODUCTO",
              "value": "={{ $json.product.original_price }}",
              "type": "string"
            },
            {
              "id": "d295df2e-e935-41ef-a2b1-7923cabd1a92",
              "name": "PRECIO PAGADO",
              "value": "={{ $json.product.final_paid_price }}",
              "type": "string"
            },
            {
              "id": "adb9ae5a-50d9-4923-b706-31a9a5b86e66",
              "name": "DESCUENTO",
              "value": "={{ $json.product.total_discount_applied }}",
              "type": "string"
            },
            {
              "id": "c2b11c61-81c1-4b6d-94ec-c55b6872e5e0",
              "name": "NOMBRE DE PRODUCTO",
              "value": "={{ $json.product.product_name }}",
              "type": "string"
            },
            {
              "id": "f7cbe128-fbe4-4bfb-b5ec-d7eed2f87b84",
              "name": "VARIANTE",
              "value": "={{ $json.product.variant_title }}",
              "type": "string"
            },
            {
              "id": "1e31a3b3-a073-4113-9047-95110c3d7987",
              "name": "NUMERO_FILA",
              "value": "={{ $json.product.numero_fila }}",
              "type": "number"
            },
            {
              "id": "e4c20adf-aa16-46e1-9851-3844e08241a6",
              "name": "ID_DOCUMENTO",
              "value": "={{ $json.product.ID_documento }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1344,
        480
      ],
      "id": "b52e6336-e7f7-40dd-ad46-c520b057c406",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// 1. Validaciones básicas\nif (items.length < 2) {\n    throw new Error(\"Se esperaban al menos 2 ítems de entrada.\");\n}\n\n// Inicializamos variables\nlet orderData = null;\nconst productRows = []; // Aquí guardaremos los ítems que tienen ID_documento\nconst costMap = {}; // Aquí guardaremos los costos indexados por SKU\n\n// 2. Clasificar los ítems de entrada\nfor (const item of items) {\n    const json = item.json;\n\n    // A) Es la ORDEN (tiene data.order)\n    if (json.data && json.data.order) {\n        orderData = json.data.order;\n    } \n    // B) Es información de COSTO de Shopify (tiene data.productVariant)\n    else if (json.data && json.data.productVariant) {\n        const variant = json.data.productVariant;\n        const sku = variant.sku;\n        const costAmount = variant.inventoryItem?.unitCost?.amount;\n        \n        // Guardamos el costo en un objeto usando el SKU como clave para buscarlo rápido después\n        if (sku && costAmount) {\n            costMap[sku] = costAmount;\n        }\n    }\n    // C) Es el ítem procesado (tiene ID_documento)\n    else if (json.ID_documento) {\n        productRows.push(json);\n    }\n}\n\nif (!orderData) {\n    throw new Error(\"No se encontró el ítem de la orden de Shopify.\");\n}\n\nif (productRows.length === 0) {\n    throw new Error(\"No se encontraron ítems de producto con ID_documento.\");\n}\n\n// 3. Crear objeto base de la orden\nconst baseOrderData = {\n    id: orderData.id,\n    name: orderData.name,\n    createdAt: orderData.createdAt,\n    totalPrice: orderData.totalPriceSet?.shopMoney?.amount || 'N/A',\n    currencyCode: orderData.totalPriceSet?.shopMoney?.currencyCode || 'N/A',\n    \n    // Datos del cliente\n    customer: orderData.customer,\n    \n    // Datos de envío\n    fulfillmentLocation: orderData.fulfillments?.[0]?.location?.name || 'N/A',\n    fulfillmentAddress: orderData.fulfillments?.[0]?.location?.address || 'N/A',\n    \n    // Datos de la transacción\n    transactionGateway: orderData.transactions?.[0]?.formattedGateway || 'N/A',\n    transactionKind: orderData.transactions?.[0]?.kind || 'N/A',\n    transactionStatus: orderData.transactions?.[0]?.status || 'N/A',\n};\n\n// 4. Iterar sobre los productos y fusionar (incluyendo el costo encontrado)\nconst combinedItems = [];\n\nfor (const productData of productRows) {\n    \n    // Buscamos si existe un costo guardado para este SKU\n    const sku = productData.sku;\n    const unitCost = costMap[sku] || '0.00'; // Si no encuentra match, pone 0.00 o N/A\n\n    const combinedItem = {\n        ...baseOrderData,\n        \n        product: {\n            ID_documento: productData.ID_documento,\n            numero_fila: productData.numero_fila,\n            product_name: productData.product_name,\n            sku: productData.sku,\n            variant_title: productData.variant_title,\n            original_price: productData.original_price,\n            total_discount_applied: productData.total_discount_applied,\n            final_paid_price: productData.final_paid_price,\n            currency: productData.currency,\n            // Aquí agregamos el campo solicitado\n            unit_cost: unitCost \n        }\n    };\n    \n    combinedItems.push({\n        json: combinedItem,\n    });\n}\n\nreturn combinedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        480
      ],
      "id": "38bbf384-1b40-4d4d-b5cc-97d8454a7303",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Documento": "={{ $json.id }}",
            "Contador": 2,
            "Contador_Alquiler": 2
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1008,
        128
      ],
      "id": "954c39f5-d1ab-48b0-a72f-d98b54032d3b",
      "name": "Update row(s)"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        624,
        480
      ],
      "id": "4f754bc8-b2f2-4dd8-a946-e584b5dab050",
      "name": "Get row(s)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $json.ID_DOCUMENTO}}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19bvtVxQK6uMbxP2HZKgGEGM_KWyvJM3vLp1APRSSTEY/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.NUMERO_FILA }}",
            "SUCURSAL DE VENTA": "={{ $json['SUCURSAL DE VENTA'] }}",
            "MÉTODO DE PAGO": "={{ $json['METODO DE PAGO'] }}",
            "COSTE POR UNIDAD": "={{ $json['COSTO POR UNIDAD'] }}",
            "PRECIO DE PRODUCTO": "={{ $json['COSTE DE PRODUCTO'] }}",
            "PRECIO PAGADO": "={{ $json['PRECIO PAGADO'] }}",
            "DESCUENTO": "={{ $json.DESCUENTO }}",
            "NOMBRE DE PRODUCTO": "={{ $json['NOMBRE DE PRODUCTO'] }}",
            "VARIANTE": "={{ $json.VARIANTE }}",
            "ID PEDIDO": "={{ $('Webhook').first().json.body.id }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "SUCURSAL DE VENTA",
              "displayName": "SUCURSAL DE VENTA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "COSTE POR UNIDAD",
              "displayName": "COSTE POR UNIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO DE PRODUCTO",
              "displayName": "PRECIO DE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO PAGADO",
              "displayName": "PRECIO PAGADO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "DESCUENTO",
              "displayName": "DESCUENTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE DE PRODUCTO",
              "displayName": "NOMBRE DE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "SURFIN SIERRA NEVADA",
              "displayName": "SURFIN SIERRA NEVADA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tarjeta",
              "displayName": "Tarjeta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Efectivo",
              "displayName": "Efectivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Venta Web",
              "displayName": "Venta Web",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL",
              "displayName": "TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1488,
        480
      ],
      "id": "3456907e-1889-4e9d-87b5-40ea7f7453de",
      "name": "Update row in sheet",
      "executeOnce": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Documento": "={{ $('Edit Fields').item.json.ID_DOCUMENTO }}",
            "Contador": "={{ $('Edit Fields').item.json.NUMERO_FILA  + 1}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1648,
        480
      ],
      "id": "faf01950-eda5-4601-8b6c-75240e769c87",
      "name": "Update row(s)1"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
        "query": "query getVariantCost($id: ID!) {\n  productVariant(id: $id) {\n    id\n    sku\n    title\n    inventoryItem {\n      id\n      unitCost {\n        amount\n        currencyCode\n      }\n    }\n  }\n}\n\n",
        "variables": "={\n  \"id\": \"{{ $json['ID VARIANTE'] }}\"\n}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        896,
        336
      ],
      "id": "0547d26f-e2d4-4a83-ad9a-3b3f4097a3c2",
      "name": "GraphQL1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "711be730-983a-47e6-99f2-d818a44482be",
              "name": "ID VARIANTE",
              "value": "=gid://shopify/ProductVariant/{{ $('Webhook').item.json.body.line_items[0].variant_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        784,
        336
      ],
      "id": "296715bd-4cb8-4930-a0d7-966761cc3f3b",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "87a5aeba-2adf-47d1-8d7b-b55d5016266a",
              "name": "FECHA",
              "value": "={{ $today }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        576,
        128
      ],
      "id": "fccdf808-f4e0-4782-a70b-a6b6e00c2e42",
      "name": "obtener fecha"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const fecha = new Date(item.json.FECHA);\n\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const anio = fecha.getFullYear();\n\n  item.json.FECHA = `${dia}/${mes}/${anio}`;\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        128
      ],
      "id": "a2ae42c0-c272-4555-ae7f-445636e14ba8",
      "name": "formatear fecha"
    },
    {
      "parameters": {
        "content": "ACTUALIZAR DOCUMENTO CON CADA PEDIDO",
        "height": 448,
        "width": 1632,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        400,
        304
      ],
      "id": "851e0c70-842c-46c7-a56a-b490e4cc792d",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "sendTo": "emilianomartinezvrd@gmail.com",
        "subject": "Informe diario mamawebaso",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333333;\">\n  \n  <h2 style=\"color: #2c3e50; border-bottom: 2px solid #007bff; padding-bottom: 10px;\">\n    INFORME DIARIO ({{ $now.toFormat('dd/MM/yyyy') }})\n  </h2>\n\n  <p>Hola,</p>\n  \n  <p>Aquí tienes el informe actualizado correspondiente al día de hoy.</p>\n  <p>Puedes acceder al archivo o recurso haciendo clic en el siguiente botón:</p>\n\n  <div style=\"margin: 30px 0;\">\n    <a href=\"https://docs.google.com/spreadsheets/d/{{ $json.ID_Documento }}/edit?gid=0#gid=0\" \n       style=\"background-color: #007bff; color: #ffffff; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n       VER DOCUMENTO\n    </a>\n  </div>\n\n  <p style=\"font-size: 12px; color: #888;\">\n    Este es un mensaje automático enviado por tu flujo de n8n.\n  </p>\n  \n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        592,
        816
      ],
      "id": "e0a1443f-7789-45c3-88a0-4471df57e63a",
      "name": "Send a message",
      "webhookId": "395b376a-113e-4e7e-b92d-4afaa0028904",
      "credentials": {
        "gmailOAuth2": {
          "id": "wR7U82S8bmDH4odC",
          "name": "info@tailwind.es"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        432,
        816
      ],
      "id": "6762e93d-c33c-4008-9d9c-7fd70d47fbf5",
      "name": "Get row(s)1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Correo').item.json.from.text }}",
                    "rightValue": "=reservas@rules-shop.es",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5702ef6b-4e43-4933-9af3-abf329de5e06"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "1384d8f9-c75c-4be1-a293-98c0d102292b",
                    "leftValue": "={{ $('Correo').item.json.from.text }}",
                    "rightValue": "reservas@surfin.es",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "fe1d90fc-f649-48e8-9f37-c58ef22f10c7",
                    "leftValue": "={{ $('Correo').item.json.from.text }}",
                    "rightValue": "reservas@snowdivision.es",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "06d5176e-59be-4584-9efb-c8a5f233789c",
                    "leftValue": "={{ $('Correo').item.json.from.value[0].address }}",
                    "rightValue": "info@sierranevadagranada.com",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -416,
        448
      ],
      "id": "fa3ccb4f-aef5-4d7b-a691-90267f5171fe",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsCode": "// -----------------------------------------------------------\n// 1. OBTENCIÓN DE DATOS (CRUCIAL: Combinamos fuentes)\n// -----------------------------------------------------------\n\n// A) Datos que vienen del flujo (Switch -> GetRow) -> Aquí está el Contador\nconst flujoDatos = $input.first().json; \nconst contadorBase = parseInt(flujoDatos.Contador_Alquiler) || 0;\n\n// B) Datos del Email -> Los forzamos a leer del nodo original \"Correo\"\n// NOTA: Si tu nodo de Gmail se llama distinto de \"Correo\", cambia el nombre aquí abajo.\nlet emailData = {};\ntry {\n    emailData = $('Correo').first().json; \n} catch(e) {\n    // Si falla (ej. probando solo este nodo), intentamos leer del input normal\n    console.log(\"Aviso: No se pudo leer el nodo 'Correo', usando input local.\");\n    emailData = flujoDatos; \n}\n\n// -----------------------------------------------------------\n// 2. EXTRACCIÓN Y NORMALIZACIÓN\n// -----------------------------------------------------------\n\nconst subject = (emailData.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = emailData.text || \"\";\n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente (Nombre y Apellidos)\nlet nombre = \"No encontrado\";\nlet apellidos = \"\";\nlet nombreCompleto = \"\";\n\n// Subject esperado: \"Rules - Compra efectuada - Pedro Villalba Martínez - canal Reservas\"\nconst partesAsunto = subject.split(\" - \");\n\nif (partesAsunto.length >= 3) {\n    nombreCompleto = partesAsunto[2].trim();\n    // Dividimos: Primera palabra es nombre, el resto apellidos\n    const nombrePartes = nombreCompleto.split(\" \");\n    if (nombrePartes.length > 0 && nombrePartes[0] !== \"\") {\n        nombre = nombrePartes[0];\n        apellidos = nombrePartes.slice(1).join(\" \");\n    }\n}\n\n// 5. Extraer Email del Cliente\n// Priorizamos la estructura limpia del JSON\nlet clienteEmail = \"No encontrado\";\n\nif (emailData.to?.value?.[0]?.address) {\n    clienteEmail = emailData.to.value[0].address;\n} else if (emailData.headers && emailData.headers['delivered-to']) {\n    // Fallback por si la estructura cambia\n    clienteEmail = emailData.headers['delivered-to'].replace(\"Delivered-To: \", \"\").trim();\n}\n\n// -----------------------------------------------------------\n// 6. Extraer Datos del Pedido y Método de Pago (CORREGIDO)\n// -----------------------------------------------------------\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/i);\nconst precioTotal = totalMatch ? totalMatch[1].trim() : \"0.00\";\n\nconst orderMatch = bodyText.match(/Identificador:\\s*([A-Z0-9]+)/i);\nconst idPedido = orderMatch ? orderMatch[1].trim() : \"No encontrado\";\n\nconst canalMatch = bodyText.match(/Canal:\\s*([^\\n\\r]+)/i);\nconst canalVenta = canalMatch ? canalMatch[1].trim() : \"Desconocido\";\n\n// CORRECCIÓN: Lógica ampliada para detectar \"Card checkout\"\nlet metodoPago = \"No encontrado\";\n\nif (/Card checkout/i.test(bodyText)) {\n    metodoPago = \"Card checkout\";\n} else if (/Bank card/i.test(bodyText)) {\n    metodoPago = \"Bank card\";\n} else if (/Tarjeta/i.test(bodyText)) {\n    metodoPago = \"Tarjeta\";\n} else if (/PayPal/i.test(bodyText)) {\n    metodoPago = \"PayPal\";\n}\n\n// -----------------------------------------------------------\n// 7. Extraer y Agrupar Productos\n// -----------------------------------------------------------\nconst productosMap = {};\n// Regex: NOMBRE (MAYUS) + espacios + CANTIDAD + espacios + PRECIO + €\nconst productRegex = /([A-ZÁÉÍÓÚÑ0-9\\s\\-]{3,})\\s+(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    // Filtros para evitar leer encabezados como productos\n    if (nombreProd === \"DETALLES DEL PEDIDO\" || \n        nombreProd === \"PAGOS ASOCIADOS AL PEDIDO\" || \n        nombreProd.length > 60) continue;\n\n    // Normalización\n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n\n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad, \n            precio_unitario: precioUnitario \n        };\n    }\n}\n\n// -----------------------------------------------------------\n// 8. GENERAR SALIDA\n// -----------------------------------------------------------\nconst productosArray = Object.values(productosMap);\n\n// Si no hay productos, fila de seguridad\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"Producto no detectado\", cantidad: 1, precio_unitario: precioTotal });\n}\n\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n    const esPrimeraFila = index === 0;\n\n    return {\n        json: {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": esPrimeraFila ? marca : \"\",\n            \"cliente_nombre\": esPrimeraFila ? nombre : \"\",\n            \"cliente_apellidos\": esPrimeraFila ? apellidos : \"\",\n            \"cliente_email\": esPrimeraFila ? clienteEmail : \"\",\n            \"id_pedido\": esPrimeraFila ? idPedido : \"\",\n            \"canal\": esPrimeraFila ? canalVenta : \"\",\n            \"metodo_pago\": esPrimeraFila ? metodoPago : \"\", // Aquí saldrá ahora \"Card checkout\"\n            \"total_compra\": esPrimeraFila ? precioTotal : \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": esPrimeraFila ? resumenTexto : \"\"\n        }\n    };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        272
      ],
      "id": "132c4e3b-b445-4f4b-bdff-7374f9e5ff18",
      "name": "rules-shop"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca\nconst marca = subject.includes(\"Surfin\") ? \"Surfin\" : (subject.includes(\"Snow Division\") ? \"Snow Division\" : \"Rules\");\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No indicado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3 && partesAsunto[2].trim() !== \"\") {\n    nombreCompleto = partesAsunto[2].trim();\n}\n\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"No indicado\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\n\nconst clienteEmail = (correoOriginal.to?.value?.[0]?.address || correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\n\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /PRODUCTO\\n\\n(\\d+)\\s+([\\d,.]+)€\\n\\nLocalizador:\\s*([a-z0-9]+)\\nConcepto:\\s*([^\\n]+)/gi;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y normalizamos espacios\n    let nombreProd = match[4].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim().toUpperCase();\n    const cantidad = parseInt(match[1]);\n    const precioUnitario = match[2].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Fallback si el anterior no captura nada\nif (Object.keys(productosMap).length === 0) {\n    const fallbackRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\n    let fallbackMatch;\n    while ((fallbackMatch = fallbackRegex.exec(bodyText)) !== null) {\n        // LIMPIEZA: También en el fallback\n        let nProd = fallbackMatch[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n        if (nProd.includes(\"2X1\")) nProd = \"EQUIPO ESQUÍ 2X1\";\n        const cant = parseInt(fallbackMatch[2]);\n        const prec = fallbackMatch[3].replace(',', '.').replace(/\\n/g, '').trim();\n        if (productosMap[nProd]) productosMap[nProd].cantidad += cant;\n        else productosMap[nProd] = { nombre: nProd, cantidad: cant, precio_unitario: prec };\n    }\n}\n\n// 9. CREAR SALIDA DIFERENCIADA\nconst productosArray = Object.values(productosMap);\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"0.00\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"id_pedido\": idPedido,\n            \"cliente_email\": clienteEmail,\n            \"canal\": canalVenta,\n            \"metodo_pago\": metodoPago,\n            \"total_compra\": precioTotal,\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\", \n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"canal\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        416
      ],
      "id": "d58a6580-401b-4d55-bc2f-a2bcb34c3ee5",
      "name": "surfin"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0; \n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3) {\n    nombreCompleto = partesAsunto[2].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.to.value[0].address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Eliminamos saltos de línea y colapsamos espacios múltiples en el nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Generar salida plana para Google Sheets\nconst productosArray = Object.values(productosMap);\n// LIMPIEZA: Resumen sin saltos de línea para que no rompa la celda\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": metodoPago,\n            \"total_compra\": precioTotal,\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        544
      ],
      "id": "9031743d-79e1-4b7d-a852-e3aa8b68164a",
      "name": "snowdivision"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "MARCA": "={{ $json.marca }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}",
            "row_number": "={{ $json.numero_fila }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        544
      ],
      "id": "7367a66d-8df9-476b-8c0b-5479607fb339",
      "name": "Escribir SnowDivision",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "MARCA": "={{ $json.marca }}",
            "row_number": "={{ $json.numero_fila }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        416
      ],
      "id": "e4cb0885-b4e6-46e5-abc8-ced7e117233d",
      "name": "Escribir Surfin",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 398140035,
          "mode": "list",
          "cachedResultName": "Alquiler",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1V2qK7u_JPZQKXU3RS2LqFDM4J9AV8yMHAnwnK8V1IDo/edit#gid=398140035"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.numero_fila }}",
            "MARCA": "={{ $json.marca }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        272
      ],
      "id": "9262d50b-9185-4607-81c6-ad91edd89465",
      "name": "Escribir Rules",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador": "={{ $('Get row(s)2').first().json.Contador }}",
            "Contador_Alquiler": "={{ $json.row_number + 1}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        112,
        272
      ],
      "id": "520dc12b-583c-40bd-80d8-b54401ade2f1",
      "name": "actualizar contador rules"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador_Alquiler": "={{ $json.row_number + 1}}",
            "Contador": "={{ $('Get row(s)2').first().json.Contador }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        112,
        416
      ],
      "id": "6b0db584-2a39-46bb-902d-9131fa4ce1e0",
      "name": "actualizar contador surfin"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador_Alquiler": "={{ $json.row_number + 1}}",
            "Contador": "={{ $('Get row(s)2').first().json.Contador }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "dryRun": false
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        112,
        544
      ],
      "id": "56f1f664-3f3e-480a-84a8-f9067fb0d648",
      "name": "actualizar contador snowdivision"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original del nodo \"Correo\"\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior ($input)\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca (Sierra Nevada Granada)\nlet marca = \"Sierra Nevada Granada\";\n\n// 4. Extraer Datos del Cliente del Subject\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 2) {\n    nombreCompleto = partesAsunto[1].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Identificador del Pedido (Número: SO...)\nconst orderMatch = bodyText.match(/N[úu]mero:\\s*(SO\\d+)/i);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal de Venta\nconst canalVenta = partesAsunto[2] ? partesAsunto[2].replace(\"canal \", \"\").replace(/\\n/g, ' ').trim() : \"Reservas\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\n\n/** * Regex para el formato Sierra Nevada: Limpia saltos de línea dentro del nombre\n */\nconst productRegex = /Descripci[óo]n\\s+Cant\\.\\s+([\\w\\sÁÉÍÓÚÑ\\-]+?)\\s+(\\d+[\\d,.]*)/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y espacios múltiples del nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    nombreProd = nombreProd.split('  ')[0].trim(); // Evita capturar cabeceras si se filtran\n    \n    const cantidad = parseInt(match[2].split(',')[0]);\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad: cantidad, \n            precio_unitario: \"Ver email\" \n        };\n    }\n}\n\n// 8. Búsqueda de emergencia para Forfaits (limpia también)\nif (Object.keys(productosMap).length === 0) {\n    const forfaitMatch = bodyText.match(/Forfait\\s+D[íi]as\\s+Consecutivos/i);\n    if (forfaitMatch) {\n        productosMap[\"FORFAIT DÍAS CONSECUTIVOS\"] = { nombre: \"FORFAIT DÍAS CONSECUTIVOS\", cantidad: 1, precio_unitario: \"Ver email\" };\n    }\n}\n\n// 9. Generar salida para Google Sheets\nconst productosArray = Object.values(productosMap);\n// Resumen unificado en una sola línea\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"Ver email\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": \"Tarjeta\",\n            \"total_compra\": \"Ver justificante\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        688
      ],
      "id": "639143ee-f6eb-4832-af8e-48d41053a656",
      "name": "sierranevadagranada"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').first().json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.numero_fila }}",
            "MARCA": "={{ $json.marca }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        688
      ],
      "id": "bdcbbe12-2485-403b-bbd0-1b060ee75634",
      "name": "Escribir sierranevadagranada",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador_Alquiler": "={{ $json.row_number + 1}}",
            "Contador": "={{ $('Get row(s)2').first().json.Contador }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        112,
        688
      ],
      "id": "f91d9064-be06-467e-a244-f6f1999fc426",
      "name": "actualizar contador sierranevadagranada"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -576,
        480
      ],
      "id": "162dccd0-13f7-427e-8032-e9547d607c67",
      "name": "Get row(s)2"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {
          "q": "from: (reservas@rules-shop.es OR reservas@surfin.es OR reservas@snowdivision.es OR info@sierranevadagranada.com)"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -736,
        480
      ],
      "id": "424c4c3d-50d2-4125-9517-d6184f95d5d8",
      "name": "Correo",
      "credentials": {
        "gmailOAuth2": {
          "id": "fha7KwAzrDSA7OXO",
          "name": "ventas@sierranevadagranada.com"
        }
      }
    },
    {
      "parameters": {
        "content": "INFORME DIARIO DE ALQUILERES\n",
        "height": 624,
        "width": 1120,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -784,
        240
      ],
      "id": "62875833-b388-4db3-8958-e726c4d976d9",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "Pedidos-Documentos",
          "mode": "list",
          "cachedResultName": "Pedidos-Documentos"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_pedido": "={{ $('Update row in sheet').item.json[\"ID PEDIDO\"] }}",
            "id_documento": "={{ $('Get row(s)').first().json.ID_Documento }}",
            "fecha": "={{ $now.format('dd/LL/yyyy') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_pedido",
              "displayName": "id_pedido",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "id_documento",
              "displayName": "id_documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1808,
        480
      ],
      "id": "7dab9750-96c6-4a7d-97c9-100169c69795",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "connection": "upgrade",
            "host": "n8n.tailwind.es",
            "x-forwarded-for": "34.34.152.237",
            "x-forwarded-proto": "https",
            "content-length": "7314",
            "user-agent": "Shopify-Captain-Hook",
            "accept": "*/*",
            "accept-encoding": "gzip;q=1.0,deflate;q=0.6,identity;q=0.3",
            "content-type": "application/json",
            "x-shopify-api-version": "2025-10",
            "x-shopify-event-id": "c8e373fe-500a-4acd-a927-53a216ba2b8b",
            "x-shopify-hmac-sha256": "Vl8fymojE5xMeVzzM0zenMEkCqbmEfchXWSc86phdng=",
            "x-shopify-order-id": "7525433508187",
            "x-shopify-shop-domain": "surfin-store-spain.myshopify.com",
            "x-shopify-test": "false",
            "x-shopify-topic": "orders/create",
            "x-shopify-triggered-at": "2026-02-05T13:04:10.248258121Z",
            "x-shopify-webhook-id": "a23f91e1-6d90-5e99-a9ba-ec6dff98fc98"
          },
          "params": {},
          "query": {},
          "body": {
            "id": 7525433508187,
            "admin_graphql_api_id": "gid://shopify/Order/7525433508187",
            "app_id": 129785,
            "browser_ip": "2.136.43.78",
            "buyer_accepts_marketing": false,
            "cancel_reason": null,
            "cancelled_at": null,
            "cart_token": null,
            "checkout_id": 48321509982555,
            "checkout_token": "d80723fc-fc21-46d0-8d21-5a56c4ef5808",
            "client_details": {
              "accept_language": null,
              "browser_height": null,
              "browser_ip": "2.136.43.78",
              "browser_width": null,
              "session_hash": null,
              "user_agent": "Shopify POS/10.15.2/Android/15/Redmi/25040RP0AE/production"
            },
            "closed_at": "2026-02-05T14:04:11+01:00",
            "company": null,
            "confirmation_number": "4WGELFNVE",
            "confirmed": true,
            "contact_email": "juanmasu19082005@gmail.com",
            "created_at": "2026-02-05T14:04:09+01:00",
            "currency": "EUR",
            "current_shipping_price_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "current_subtotal_price": "85.00",
            "current_subtotal_price_set": {
              "shop_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              }
            },
            "current_total_additional_fees_set": null,
            "current_total_discounts": "0.00",
            "current_total_discounts_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "current_total_duties_set": null,
            "current_total_price": "85.00",
            "current_total_price_set": {
              "shop_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              }
            },
            "current_total_tax": "0.00",
            "current_total_tax_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "customer_locale": "es",
            "device_id": 20,
            "discount_codes": [],
            "duties_included": false,
            "email": "juanmasu19082005@gmail.com",
            "estimated_taxes": false,
            "financial_status": "paid",
            "fulfillment_status": "fulfilled",
            "landing_site": null,
            "landing_site_ref": null,
            "location_id": 108915917147,
            "merchant_business_entity_id": "MTg3OTg3NjUwOTA3",
            "merchant_of_record_app_id": null,
            "name": "#71868",
            "note": null,
            "note_attributes": [],
            "number": 70868,
            "order_number": 71868,
            "order_status_url": "https://nuance-store.com/87987650907/orders/280e9f3249a986d79e6b2c4f57ba5d39/authenticate?key=afd215cb5337d28482402d1cbd449376",
            "original_total_additional_fees_set": null,
            "original_total_duties_set": null,
            "payment_gateway_names": [
              "Tarjeta"
            ],
            "phone": null,
            "po_number": null,
            "presentment_currency": "EUR",
            "processed_at": "2026-02-05T14:04:08+01:00",
            "reference": null,
            "referring_site": null,
            "source_identifier": "108915917147-20-1151",
            "source_name": "pos",
            "source_url": null,
            "subtotal_price": "85.00",
            "subtotal_price_set": {
              "shop_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              }
            },
            "tags": "",
            "tax_exempt": false,
            "tax_lines": [],
            "taxes_included": true,
            "test": false,
            "token": "280e9f3249a986d79e6b2c4f57ba5d39",
            "total_cash_rounding_payment_adjustment_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "total_cash_rounding_refund_adjustment_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "total_discounts": "0.00",
            "total_discounts_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "total_line_items_price": "85.00",
            "total_line_items_price_set": {
              "shop_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              }
            },
            "total_outstanding": "0.00",
            "total_price": "85.00",
            "total_price_set": {
              "shop_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "85.00",
                "currency_code": "EUR"
              }
            },
            "total_shipping_price_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "total_tax": "0.00",
            "total_tax_set": {
              "shop_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              },
              "presentment_money": {
                "amount": "0.00",
                "currency_code": "EUR"
              }
            },
            "total_tip_received": "0.00",
            "total_weight": 0,
            "updated_at": "2026-02-05T14:04:11+01:00",
            "user_id": 126641570139,
            "billing_address": null,
            "customer": {
              "id": 10159357362523,
              "created_at": "2026-02-05T14:03:30+01:00",
              "updated_at": "2026-02-05T14:04:09+01:00",
              "first_name": "Juan Manuel",
              "last_name": "Suarez",
              "state": "disabled",
              "note": "",
              "verified_email": true,
              "multipass_identifier": null,
              "tax_exempt": false,
              "email": "juanmasu19082005@gmail.com",
              "phone": null,
              "currency": "EUR",
              "tax_exemptions": [],
              "admin_graphql_api_id": "gid://shopify/Customer/10159357362523"
            },
            "discount_applications": [],
            "fulfillments": [
              {
                "id": 6710982410587,
                "admin_graphql_api_id": "gid://shopify/Fulfillment/6710982410587",
                "created_at": "2026-02-05T14:04:10+01:00",
                "location_id": 108915917147,
                "name": "#71868.1",
                "order_id": 7525433508187,
                "origin_address": {},
                "receipt": {},
                "service": "manual",
                "shipment_status": null,
                "status": "success",
                "tracking_company": null,
                "tracking_number": null,
                "tracking_numbers": [],
                "tracking_url": null,
                "tracking_urls": [],
                "updated_at": "2026-02-05T14:04:10+01:00",
                "line_items": [
                  {
                    "id": 18423245930843,
                    "admin_graphql_api_id": "gid://shopify/LineItem/18423245930843",
                    "attributed_staffs": [],
                    "current_quantity": 1,
                    "fulfillable_quantity": 0,
                    "fulfillment_service": "manual",
                    "fulfillment_status": "fulfilled",
                    "gift_card": false,
                    "grams": 0,
                    "name": "The North Face Yumiori 1/4 Zip Forro Polar - TNF Black/Asphalt Grey/Monument Grey / L",
                    "price": "85.00",
                    "price_set": {
                      "shop_money": {
                        "amount": "85.00",
                        "currency_code": "EUR"
                      },
                      "presentment_money": {
                        "amount": "85.00",
                        "currency_code": "EUR"
                      }
                    },
                    "product_exists": true,
                    "product_id": 10254930542939,
                    "properties": [],
                    "quantity": 1,
                    "requires_shipping": true,
                    "sku": "51905154056539",
                    "taxable": true,
                    "title": "The North Face Yumiori 1/4 Zip Forro Polar",
                    "total_discount": "0.00",
                    "total_discount_set": {
                      "shop_money": {
                        "amount": "0.00",
                        "currency_code": "EUR"
                      },
                      "presentment_money": {
                        "amount": "0.00",
                        "currency_code": "EUR"
                      }
                    },
                    "variant_id": 51905154056539,
                    "variant_inventory_management": "shopify",
                    "variant_title": "TNF Black/Asphalt Grey/Monument Grey / L",
                    "vendor": "The North Face",
                    "tax_lines": [],
                    "duties": [],
                    "discount_allocations": []
                  }
                ]
              }
            ],
            "line_items": [
              {
                "id": 18423245930843,
                "admin_graphql_api_id": "gid://shopify/LineItem/18423245930843",
                "attributed_staffs": [],
                "current_quantity": 1,
                "fulfillable_quantity": 0,
                "fulfillment_service": "manual",
                "fulfillment_status": "fulfilled",
                "gift_card": false,
                "grams": 0,
                "name": "The North Face Yumiori 1/4 Zip Forro Polar - TNF Black/Asphalt Grey/Monument Grey / L",
                "price": "85.00",
                "price_set": {
                  "shop_money": {
                    "amount": "85.00",
                    "currency_code": "EUR"
                  },
                  "presentment_money": {
                    "amount": "85.00",
                    "currency_code": "EUR"
                  }
                },
                "product_exists": true,
                "product_id": 10254930542939,
                "properties": [],
                "quantity": 1,
                "requires_shipping": true,
                "sales_line_item_group_id": null,
                "sku": "51905154056539",
                "taxable": true,
                "title": "The North Face Yumiori 1/4 Zip Forro Polar",
                "total_discount": "0.00",
                "total_discount_set": {
                  "shop_money": {
                    "amount": "0.00",
                    "currency_code": "EUR"
                  },
                  "presentment_money": {
                    "amount": "0.00",
                    "currency_code": "EUR"
                  }
                },
                "variant_id": 51905154056539,
                "variant_inventory_management": "shopify",
                "variant_title": "TNF Black/Asphalt Grey/Monument Grey / L",
                "vendor": "The North Face",
                "tax_lines": [],
                "duties": [],
                "discount_allocations": []
              }
            ],
            "payment_terms": null,
            "refunds": [],
            "shipping_address": null,
            "shipping_lines": [],
            "returns": [],
            "line_item_groups": []
          },
          "webhookUrl": "https://n8n.tailwind.es/webhook/informeDiario",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-01-15T07:50:18.781Z",
      "createdAt": "2026-01-15T07:50:18.781Z",
      "role": "workflow:owner",
      "workflowId": "sQUNg-VuSIFLaMIdA9znD",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 3,
  "updatedAt": "2026-02-05T13:22:44.071Z",
  "versionId": "824e44fe-4ef3-44f3-9adc-06bbeafdb2e4"
}