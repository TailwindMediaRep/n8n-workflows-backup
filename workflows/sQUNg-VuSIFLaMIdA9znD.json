{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-01-28T13:23:15.000Z",
    "createdAt": "2026-01-28T13:23:13.251Z",
    "versionId": "aece013d-6ff6-4a9f-814f-e7bb6bf3944a",
    "workflowId": "sQUNg-VuSIFLaMIdA9znD",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "informeDiario",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          240,
          480
        ],
        "id": "3a169d65-fc08-45f0-a1c1-197ef4d4aa08",
        "name": "Webhook",
        "webhookId": "7c1e3b37-6cc8-4f4a-81e3-c5897bdf497c"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
          "query": "query getOrder($id: ID!) {\n\n  order(id: $id) {\n\n    id\n\n    name\n\n    createdAt\n\n    email\n\n    totalPriceSet {\n\n      shopMoney {\n\n        amount\n\n        currencyCode\n\n      }\n\n    }\n\n    lineItems(first: 10) {\n\n      edges {\n\n        node {\n\n          title\n\n          quantity\n\n          originalUnitPriceSet {\n\n            shopMoney {\n\n              amount\n\n              currencyCode\n\n            }\n\n          }\n\n        }\n\n      }\n\n    }\n\n    fulfillments {\n\n      id\n\n      location {\n\n        name\n\n        address {\n\n          address1\n\n          city\n\n          province\n\n          country\n\n          zip\n\n        }\n\n      }\n\n    }\n\n    transactions(first: 5) {\n\n      formattedGateway\n\n      kind\n\n      status\n\n    }\n\n    customer {\n\n      firstName\n\n      lastName\n\n      email\n\n    }\n\n  }\n\n}\n",
          "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $('Webhook').item.json.body.id }}\"\n}",
          "headerParametersUi": {
            "parameter": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          624,
          480
        ],
        "id": "7255d822-ea0d-446d-83c9-1aee124ad0e8",
        "name": "GraphQL",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "content": "ENVIAR CORREO",
          "height": 208,
          "width": 384,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          192,
          768
        ],
        "id": "070b8235-6802-470b-bd7a-884c6711458e",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "operation": "copy",
          "fileId": {
            "__rl": true,
            "value": "1QZ-GBz6D6EL4fZh3lh9PyAjwWzyjVn8nN0wy4mUjg04",
            "mode": "id"
          },
          "name": "=Informe_Diario_{{ $json.FECHA }}",
          "options": {}
        },
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          656,
          128
        ],
        "id": "67d0cf56-a4b3-432d-9ab3-2b819b9f63a8",
        "name": "Copy file",
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "N7JXWgOiVoyCTaVL",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "content": "CREAR DOCUMENTO",
          "height": 208,
          "width": 960,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          192,
          80
        ],
        "id": "2b6bbfe7-3af9-4eb7-a19d-ec2a3322de91",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {}
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.3,
        "position": [
          224,
          128
        ],
        "id": "62e5fa32-0ae7-493b-875f-e37addba632a",
        "name": "Schedule Trigger"
      },
      {
        "parameters": {
          "dataTableId": {
            "__rl": true,
            "value": "8GDVj673ag0hCrVt",
            "mode": "list",
            "cachedResultName": "Informe Mensual",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/8GDVj673ag0hCrVt"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "ID_Documento": "={{ $('Copy file').item.json.id }}",
              "fecha": "={{ $('formatear fecha').item.json.FECHA }}"
            },
            "matchingColumns": [
              "ID_Documento"
            ],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "fecha",
                "displayName": "fecha",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          960,
          128
        ],
        "id": "e5db14bd-7dca-40a9-bee1-b422e5e5f4a0",
        "name": "Insert row"
      },
      {
        "parameters": {
          "jsCode": "// El nodo Code de n8n espera que devolvamos un array de objetos.\nconst outputItems = [];\n\n// Obtenemos el valor del contador del nodo anterior\n// items[0].json.Contador → 2 en tu ejemplo\nlet numeroFila = items[0].json.Contador;\nlet ID_documento = items[0].json.ID_Documento;\n\n// 1. Accedemos al cuerpo real del pedido de Shopify, que está anidado.\nconst orderBody = $node['Webhook'].json.body; \n\n// 2. Extraemos los artículos de línea (productos) y la moneda.\nconst lineItems = orderBody.line_items;\nconst orderCurrency = orderBody.currency;\n\n// Iteramos sobre cada producto individual\nfor (const item of lineItems) {\n\n  const originalPrice = parseFloat(item.price);\n\n  let totalDiscountAmount = 0;\n  for (const allocation of item.discount_allocations) {\n    totalDiscountAmount += parseFloat(allocation.amount);\n  }\n\n  const finalPaidPrice = originalPrice - totalDiscountAmount;\n\n  // Creamos un nuevo objeto y añadimos \"numero_fila\"\n  outputItems.push({\n    json: {\n      ID_documento: ID_documento,\n      numero_fila: numeroFila,   // ← Nuevo campo\n      product_name: item.title,\n      sku: item.sku,\n      variant_title: item.variant_title,\n      original_price: originalPrice.toFixed(2),\n      total_discount_applied: totalDiscountAmount.toFixed(2),\n      final_paid_price: finalPaidPrice.toFixed(2),\n      currency: orderCurrency\n    }\n  });\n\n  // ↑ Incrementamos para el siguiente item\n  numeroFila++;\n}\n\n// Devolvemos el array con los nuevos objetos.\nreturn outputItems;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          624,
          624
        ],
        "id": "f74317cd-37d0-4262-a761-d94cdf479b6a",
        "name": "Code in JavaScript"
      },
      {
        "parameters": {
          "numberInputs": 3
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          864,
          464
        ],
        "id": "5007c6bb-31eb-4b15-be8a-fb06c3e7962e",
        "name": "Merge"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "31828549-6a33-4e8a-91ad-fdb9692a7e34",
                "name": "SUCURSAL DE VENTA",
                "value": "={{ $json.fulfillmentLocation }}",
                "type": "string"
              },
              {
                "id": "e89736ae-2f29-40c8-80b4-2181722ee3f5",
                "name": "METODO DE PAGO",
                "value": "={{ $json.transactionGateway }}",
                "type": "string"
              },
              {
                "id": "dc4a77f5-966d-4efc-b755-1f0fe34f6958",
                "name": "COSTO POR UNIDAD",
                "value": "={{ $json.product.unit_cost }}",
                "type": "string"
              },
              {
                "id": "76140f31-efab-4a68-b737-53f04a9a7b81",
                "name": "COSTE DE PRODUCTO",
                "value": "={{ $json.product.original_price }}",
                "type": "string"
              },
              {
                "id": "d295df2e-e935-41ef-a2b1-7923cabd1a92",
                "name": "PRECIO PAGADO",
                "value": "={{ $json.product.final_paid_price }}",
                "type": "string"
              },
              {
                "id": "adb9ae5a-50d9-4923-b706-31a9a5b86e66",
                "name": "DESCUENTO",
                "value": "={{ $json.product.total_discount_applied }}",
                "type": "string"
              },
              {
                "id": "c2b11c61-81c1-4b6d-94ec-c55b6872e5e0",
                "name": "NOMBRE DE PRODUCTO",
                "value": "={{ $json.product.product_name }}",
                "type": "string"
              },
              {
                "id": "f7cbe128-fbe4-4bfb-b5ec-d7eed2f87b84",
                "name": "VARIANTE",
                "value": "={{ $json.product.variant_title }}",
                "type": "string"
              },
              {
                "id": "1e31a3b3-a073-4113-9047-95110c3d7987",
                "name": "NUMERO_FILA",
                "value": "={{ $json.product.numero_fila }}",
                "type": "number"
              },
              {
                "id": "e4c20adf-aa16-46e1-9851-3844e08241a6",
                "name": "ID_DOCUMENTO",
                "value": "={{ $json.product.ID_documento }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1136,
          480
        ],
        "id": "b52e6336-e7f7-40dd-ad46-c520b057c406",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "jsCode": "// 1. Validaciones básicas\nif (items.length < 2) {\n    throw new Error(\"Se esperaban al menos 2 ítems de entrada.\");\n}\n\n// Inicializamos variables\nlet orderData = null;\nconst productRows = []; // Aquí guardaremos los ítems que tienen ID_documento\nconst costMap = {}; // Aquí guardaremos los costos indexados por SKU\n\n// 2. Clasificar los ítems de entrada\nfor (const item of items) {\n    const json = item.json;\n\n    // A) Es la ORDEN (tiene data.order)\n    if (json.data && json.data.order) {\n        orderData = json.data.order;\n    } \n    // B) Es información de COSTO de Shopify (tiene data.productVariant)\n    else if (json.data && json.data.productVariant) {\n        const variant = json.data.productVariant;\n        const sku = variant.sku;\n        const costAmount = variant.inventoryItem?.unitCost?.amount;\n        \n        // Guardamos el costo en un objeto usando el SKU como clave para buscarlo rápido después\n        if (sku && costAmount) {\n            costMap[sku] = costAmount;\n        }\n    }\n    // C) Es el ítem procesado (tiene ID_documento)\n    else if (json.ID_documento) {\n        productRows.push(json);\n    }\n}\n\nif (!orderData) {\n    throw new Error(\"No se encontró el ítem de la orden de Shopify.\");\n}\n\nif (productRows.length === 0) {\n    throw new Error(\"No se encontraron ítems de producto con ID_documento.\");\n}\n\n// 3. Crear objeto base de la orden\nconst baseOrderData = {\n    id: orderData.id,\n    name: orderData.name,\n    createdAt: orderData.createdAt,\n    totalPrice: orderData.totalPriceSet?.shopMoney?.amount || 'N/A',\n    currencyCode: orderData.totalPriceSet?.shopMoney?.currencyCode || 'N/A',\n    \n    // Datos del cliente\n    customer: orderData.customer,\n    \n    // Datos de envío\n    fulfillmentLocation: orderData.fulfillments?.[0]?.location?.name || 'N/A',\n    fulfillmentAddress: orderData.fulfillments?.[0]?.location?.address || 'N/A',\n    \n    // Datos de la transacción\n    transactionGateway: orderData.transactions?.[0]?.formattedGateway || 'N/A',\n    transactionKind: orderData.transactions?.[0]?.kind || 'N/A',\n    transactionStatus: orderData.transactions?.[0]?.status || 'N/A',\n};\n\n// 4. Iterar sobre los productos y fusionar (incluyendo el costo encontrado)\nconst combinedItems = [];\n\nfor (const productData of productRows) {\n    \n    // Buscamos si existe un costo guardado para este SKU\n    const sku = productData.sku;\n    const unitCost = costMap[sku] || '0.00'; // Si no encuentra match, pone 0.00 o N/A\n\n    const combinedItem = {\n        ...baseOrderData,\n        \n        product: {\n            ID_documento: productData.ID_documento,\n            numero_fila: productData.numero_fila,\n            product_name: productData.product_name,\n            sku: productData.sku,\n            variant_title: productData.variant_title,\n            original_price: productData.original_price,\n            total_discount_applied: productData.total_discount_applied,\n            final_paid_price: productData.final_paid_price,\n            currency: productData.currency,\n            // Aquí agregamos el campo solicitado\n            unit_cost: unitCost \n        }\n    };\n    \n    combinedItems.push({\n        json: combinedItem,\n    });\n}\n\nreturn combinedItems;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          992,
          480
        ],
        "id": "38bbf384-1b40-4d4d-b5cc-97d8454a7303",
        "name": "Code in JavaScript1"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "ID_Documento": "={{ $json.id }}",
              "Contador": 2,
              "Contador_Alquiler": 2
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          800,
          128
        ],
        "id": "954c39f5-d1ab-48b0-a72f-d98b54032d3b",
        "name": "Update row(s)"
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          416,
          480
        ],
        "id": "4f754bc8-b2f2-4dd8-a946-e584b5dab050",
        "name": "Get row(s)"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $json.ID_DOCUMENTO}}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "gid=0",
            "mode": "list",
            "cachedResultName": "Hoja 1",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19bvtVxQK6uMbxP2HZKgGEGM_KWyvJM3vLp1APRSSTEY/edit#gid=0"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.NUMERO_FILA }}",
              "SUCURSAL DE VENTA": "={{ $json['SUCURSAL DE VENTA'] }}",
              "MÉTODO DE PAGO": "={{ $json['METODO DE PAGO'] }}",
              "COSTE POR UNIDAD": "={{ $json['COSTO POR UNIDAD'] }}",
              "PRECIO DE PRODUCTO": "={{ $json['COSTE DE PRODUCTO'] }}",
              "PRECIO PAGADO": "={{ $json['PRECIO PAGADO'] }}",
              "DESCUENTO": "={{ $json.DESCUENTO }}",
              "NOMBRE DE PRODUCTO": "={{ $json['NOMBRE DE PRODUCTO'] }}",
              "VARIANTE": "={{ $json.VARIANTE }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "SUCURSAL DE VENTA",
                "displayName": "SUCURSAL DE VENTA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "COSTE POR UNIDAD",
                "displayName": "COSTE POR UNIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO DE PRODUCTO",
                "displayName": "PRECIO DE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO PAGADO",
                "displayName": "PRECIO PAGADO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "DESCUENTO",
                "displayName": "DESCUENTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE DE PRODUCTO",
                "displayName": "NOMBRE DE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "VARIANTE",
                "displayName": "VARIANTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "SURFIN SIERRA NEVADA",
                "displayName": "SURFIN SIERRA NEVADA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Tarjeta",
                "displayName": "Tarjeta",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Efectivo",
                "displayName": "Efectivo",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Venta Web",
                "displayName": "Venta Web",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL",
                "displayName": "TOTAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          1280,
          480
        ],
        "id": "3456907e-1889-4e9d-87b5-40ea7f7453de",
        "name": "Update row in sheet",
        "executeOnce": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "ID_Documento": "={{ $('Edit Fields').item.json.ID_DOCUMENTO }}",
              "Contador": "={{ $('Edit Fields').item.json.NUMERO_FILA  + 1}}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          1440,
          480
        ],
        "id": "faf01950-eda5-4601-8b6c-75240e769c87",
        "name": "Update row(s)1"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
          "query": "query getVariantCost($id: ID!) {\n  productVariant(id: $id) {\n    id\n    sku\n    title\n    inventoryItem {\n      id\n      unitCost {\n        amount\n        currencyCode\n      }\n    }\n  }\n}\n\n",
          "variables": "={\n  \"id\": \"{{ $json['ID VARIANTE'] }}\"\n}",
          "headerParametersUi": {
            "parameter": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          688,
          336
        ],
        "id": "0547d26f-e2d4-4a83-ad9a-3b3f4097a3c2",
        "name": "GraphQL1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "711be730-983a-47e6-99f2-d818a44482be",
                "name": "ID VARIANTE",
                "value": "=gid://shopify/ProductVariant/{{ $('Webhook').item.json.body.line_items[0].variant_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          576,
          336
        ],
        "id": "296715bd-4cb8-4930-a0d7-966761cc3f3b",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "87a5aeba-2adf-47d1-8d7b-b55d5016266a",
                "name": "FECHA",
                "value": "={{ $today }}",
                "type": "object"
              }
            ]
          },
          "options": {
            "ignoreConversionErrors": true
          }
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          368,
          128
        ],
        "id": "fccdf808-f4e0-4782-a70b-a6b6e00c2e42",
        "name": "obtener fecha"
      },
      {
        "parameters": {
          "jsCode": "return items.map(item => {\n  const fecha = new Date(item.json.FECHA);\n\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const anio = fecha.getFullYear();\n\n  item.json.FECHA = `${dia}/${mes}/${anio}`;\n\n  return item;\n});\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          512,
          128
        ],
        "id": "a2ae42c0-c272-4555-ae7f-445636e14ba8",
        "name": "formatear fecha"
      },
      {
        "parameters": {
          "content": "ACTUALIZAR DOCUMENTO CON CADA PEDIDO",
          "height": 448,
          "width": 1456,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          192,
          304
        ],
        "id": "851e0c70-842c-46c7-a56a-b490e4cc792d",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "sendTo": "emilianomartinezvrd@gmail.com",
          "subject": "Informe diario mamawebaso",
          "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333333;\">\n  \n  <h2 style=\"color: #2c3e50; border-bottom: 2px solid #007bff; padding-bottom: 10px;\">\n    INFORME DIARIO ({{ $now.toFormat('dd/MM/yyyy') }})\n  </h2>\n\n  <p>Hola,</p>\n  \n  <p>Aquí tienes el informe actualizado correspondiente al día de hoy.</p>\n  <p>Puedes acceder al archivo o recurso haciendo clic en el siguiente botón:</p>\n\n  <div style=\"margin: 30px 0;\">\n    <a href=\"https://docs.google.com/spreadsheets/d/{{ $json.ID_Documento }}/edit?gid=0#gid=0\" \n       style=\"background-color: #007bff; color: #ffffff; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n       VER DOCUMENTO\n    </a>\n  </div>\n\n  <p style=\"font-size: 12px; color: #888;\">\n    Este es un mensaje automático enviado por tu flujo de n8n.\n  </p>\n  \n</div>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          384,
          816
        ],
        "id": "e0a1443f-7789-45c3-88a0-4471df57e63a",
        "name": "Send a message",
        "webhookId": "395b376a-113e-4e7e-b92d-4afaa0028904",
        "credentials": {
          "gmailOAuth2": {
            "id": "wR7U82S8bmDH4odC",
            "name": "info@tailwind.es"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          224,
          816
        ],
        "id": "6762e93d-c33c-4008-9d9c-7fd70d47fbf5",
        "name": "Get row(s)1"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Correo').item.json.from.text }}",
                      "rightValue": "=reservas@rules-shop.es",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "5702ef6b-4e43-4933-9af3-abf329de5e06"
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "1384d8f9-c75c-4be1-a293-98c0d102292b",
                      "leftValue": "={{ $('Correo').item.json.from.text }}",
                      "rightValue": "reservas@surfin.es",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "fe1d90fc-f649-48e8-9f37-c58ef22f10c7",
                      "leftValue": "={{ $('Correo').item.json.from.text }}",
                      "rightValue": "reservas@snowdivision.es",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "06d5176e-59be-4584-9efb-c8a5f233789c",
                      "leftValue": "={{ $('Correo').item.json.from.value[0].address }}",
                      "rightValue": "info@sierranevadagranada.com",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          -656,
          448
        ],
        "id": "fa3ccb4f-aef5-4d7b-a691-90267f5171fe",
        "name": "Switch"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $input.first().json; // O $('Nombre_Nodo_Gmail').item.json\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base (si viene de un nodo anterior de base de datos)\nconst contadorBase = parseInt(correoOriginal.Contador_Alquiler) || 0;\n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\n// En tu ejemplo el nombre está vacío en el subject: \"Rules - Compra efectuada -  - canal Cajas\"\nif (partesAsunto.length >= 3 && partesAsunto[2].trim() !== \"\") {\n    nombreCompleto = partesAsunto[2].trim();\n}\n\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = nombrePartes[0] || \"No encontrado\";\nconst apellidos = nombrePartes.slice(1).join(\" \") || \"\";\n\n// CORRECCIÓN LÍNEA 24: Acceso seguro al email del cliente\n// Buscamos en 'to', o en el header 'delivered-to' que sí existe en tu JSON\nconst clienteEmail = (correoOriginal.to?.value?.[0]?.address \n                     || correoOriginal.headers?.[\"delivered-to\"]?.replace(\"Delivered-To: \", \"\") \n                     || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/i);\nconst precioTotal = totalMatch ? totalMatch[1].trim() : \"0.00\";\n\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/i);\nconst idPedido = orderMatch ? orderMatch[1].trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/i);\nconst canalVenta = canalMatch ? canalMatch[1].trim() : \"Desconocido\";\n\n// Buscamos \"Card checkout\" en el bloque de pagos\nconst pagoMatch = bodyText.match(/Card checkout/i);\nconst metodoPago = pagoMatch ? \"Tarjeta (Card checkout)\" : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\n// Este regex busca el nombre (mayúsculas), la cantidad y el precio con el símbolo €\nconst productRegex = /([A-ZÁÉÍÓÚÑ0-9\\s\\-]{3,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    // Normalización de productos específicos\n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n    \n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad, \n            precio_unitario: precioUnitario \n        };\n    }\n}\n\n// 8. Generar salida plana para n8n\nconst productosArray = Object.values(productosMap);\n\n// Si no se detectaron productos con el regex, creamos uno genérico para no perder la fila\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"Producto no detectado\", cantidad: 1, precio_unitario: precioTotal });\n}\n\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    // La primera fila lleva todos los datos, las siguientes (si hay más productos) solo los del producto\n    if (index === 0) {\n        return {\n            json: {\n                \"numero_fila\": numeroFilaActual,\n                \"marca\": marca,\n                \"cliente_nombre\": nombre,\n                \"cliente_apellidos\": apellidos,\n                \"cliente_email\": clienteEmail,\n                \"id_pedido\": idPedido,\n                \"canal\": canalVenta,\n                \"metodo_pago\": metodoPago,\n                \"total_compra\": precioTotal,\n                \"nombre_producto\": prod.nombre,\n                \"cantidad\": prod.cantidad,\n                \"precio_unitario\": prod.precio_unitario,\n                \"productos_resumen\": resumenTexto\n            }\n        };\n    } else {\n        return {\n            json: {\n                \"numero_fila\": numeroFilaActual,\n                \"marca\": \"\",\n                \"cliente_nombre\": \"\",\n                \"cliente_apellidos\": \"\",\n                \"cliente_email\": \"\",\n                \"id_pedido\": \"\",\n                \"canal\": \"\",\n                \"metodo_pago\": \"\",\n                \"total_compra\": \"\",\n                \"nombre_producto\": prod.nombre,\n                \"cantidad\": prod.cantidad,\n                \"precio_unitario\": prod.precio_unitario,\n                \"productos_resumen\": \"\"\n            }\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -464,
          256
        ],
        "id": "132c4e3b-b445-4f4b-bdff-7374f9e5ff18",
        "name": "rules-shop"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca\nconst marca = subject.includes(\"Surfin\") ? \"Surfin\" : (subject.includes(\"Snow Division\") ? \"Snow Division\" : \"Rules\");\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No indicado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3 && partesAsunto[2].trim() !== \"\") {\n    nombreCompleto = partesAsunto[2].trim();\n}\n\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"No indicado\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\n\nconst clienteEmail = (correoOriginal.to?.value?.[0]?.address || correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\n\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /PRODUCTO\\n\\n(\\d+)\\s+([\\d,.]+)€\\n\\nLocalizador:\\s*([a-z0-9]+)\\nConcepto:\\s*([^\\n]+)/gi;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y normalizamos espacios\n    let nombreProd = match[4].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim().toUpperCase();\n    const cantidad = parseInt(match[1]);\n    const precioUnitario = match[2].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Fallback si el anterior no captura nada\nif (Object.keys(productosMap).length === 0) {\n    const fallbackRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\n    let fallbackMatch;\n    while ((fallbackMatch = fallbackRegex.exec(bodyText)) !== null) {\n        // LIMPIEZA: También en el fallback\n        let nProd = fallbackMatch[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n        if (nProd.includes(\"2X1\")) nProd = \"EQUIPO ESQUÍ 2X1\";\n        const cant = parseInt(fallbackMatch[2]);\n        const prec = fallbackMatch[3].replace(',', '.').replace(/\\n/g, '').trim();\n        if (productosMap[nProd]) productosMap[nProd].cantidad += cant;\n        else productosMap[nProd] = { nombre: nProd, cantidad: cant, precio_unitario: prec };\n    }\n}\n\n// 9. CREAR SALIDA DIFERENCIADA\nconst productosArray = Object.values(productosMap);\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"0.00\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"MARCA\": marca,\n            \"NOMBRE CLIENTE\": nombre,\n            \"APELLIDOS\": apellidos,\n            \"ID PEDIDO\": idPedido,\n            \"EMAIL\": clienteEmail,\n            \"CANAL\": canalVenta,\n            \"MÉTODO DE PAGO\": metodoPago,\n            \"TOTAL COMPRA (+IVA)\": precioTotal,\n            \"NOMBRE PRODUCTO\": prod.nombre,\n            \"CANTIDAD\": prod.cantidad,\n            \"PRECIO UNITARIO\": prod.precio_unitario,\n            \"RESUMEN\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"MARCA\": \"\", \n            \"NOMBRE CLIENTE\": \"\",\n            \"APELLIDOS\": \"\",\n            \"ID PEDIDO\": \"\",\n            \"EMAIL\": \"\",\n            \"CANAL\": \"\",\n            \"MÉTODO DE PAGO\": \"\",\n            \"TOTAL COMPRA (+IVA)\": \"\",\n            \"NOMBRE PRODUCTO\": prod.nombre,\n            \"CANTIDAD\": prod.cantidad,\n            \"PRECIO UNITARIO\": prod.precio_unitario,\n            \"RESUMEN\": \"\"\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -464,
          400
        ],
        "id": "d58a6580-401b-4d55-bc2f-a2bcb34c3ee5",
        "name": "surfin"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0; \n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3) {\n    nombreCompleto = partesAsunto[2].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.to.value[0].address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Eliminamos saltos de línea y colapsamos espacios múltiples en el nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Generar salida plana para Google Sheets\nconst productosArray = Object.values(productosMap);\n// LIMPIEZA: Resumen sin saltos de línea para que no rompa la celda\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": metodoPago,\n            \"total_compra\": precioTotal,\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -464,
          544
        ],
        "id": "9031743d-79e1-4b7d-a852-e3aa8b68164a",
        "name": "snowdivision"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "MARCA": "={{ $json.marca }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}",
              "row_number": "={{ $json.numero_fila }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -288,
          544
        ],
        "id": "7367a66d-8df9-476b-8c0b-5479607fb339",
        "name": "Escribir SnowDivision",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "MARCA": "={{ $json.marca }}",
              "row_number": "={{ $json.numero_fila }}",
              "NOMBRE CLIENTE": "={{ $json.nombre_cliente }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -288,
          400
        ],
        "id": "e4cb0885-b4e6-46e5-abc8-ced7e117233d",
        "name": "Escribir Surfin",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.numero_fila }}",
              "MARCA": "={{ $json.marca }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -288,
          256
        ],
        "id": "9262d50b-9185-4607-81c6-ad91edd89465",
        "name": "Escribir Rules",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -128,
          256
        ],
        "id": "520dc12b-583c-40bd-80d8-b54401ade2f1",
        "name": "actualizar contador rules"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -128,
          400
        ],
        "id": "6b0db584-2a39-46bb-902d-9131fa4ce1e0",
        "name": "actualizar contador surfin"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {
            "dryRun": false
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -128,
          544
        ],
        "id": "56f1f664-3f3e-480a-84a8-f9067fb0d648",
        "name": "actualizar contador snowdivision"
      },
      {
        "parameters": {
          "jsCode": "// 1. Accedemos a los datos del email original del nodo \"Correo\"\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior ($input)\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca (Sierra Nevada Granada)\nlet marca = \"Sierra Nevada Granada\";\n\n// 4. Extraer Datos del Cliente del Subject\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 2) {\n    nombreCompleto = partesAsunto[1].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Identificador del Pedido (Número: SO...)\nconst orderMatch = bodyText.match(/N[úu]mero:\\s*(SO\\d+)/i);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal de Venta\nconst canalVenta = partesAsunto[2] ? partesAsunto[2].replace(\"canal \", \"\").replace(/\\n/g, ' ').trim() : \"Reservas\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\n\n/** * Regex para el formato Sierra Nevada: Limpia saltos de línea dentro del nombre\n */\nconst productRegex = /Descripci[óo]n\\s+Cant\\.\\s+([\\w\\sÁÉÍÓÚÑ\\-]+?)\\s+(\\d+[\\d,.]*)/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y espacios múltiples del nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    nombreProd = nombreProd.split('  ')[0].trim(); // Evita capturar cabeceras si se filtran\n    \n    const cantidad = parseInt(match[2].split(',')[0]);\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad: cantidad, \n            precio_unitario: \"Ver email\" \n        };\n    }\n}\n\n// 8. Búsqueda de emergencia para Forfaits (limpia también)\nif (Object.keys(productosMap).length === 0) {\n    const forfaitMatch = bodyText.match(/Forfait\\s+D[íi]as\\s+Consecutivos/i);\n    if (forfaitMatch) {\n        productosMap[\"FORFAIT DÍAS CONSECUTIVOS\"] = { nombre: \"FORFAIT DÍAS CONSECUTIVOS\", cantidad: 1, precio_unitario: \"Ver email\" };\n    }\n}\n\n// 9. Generar salida para Google Sheets\nconst productosArray = Object.values(productosMap);\n// Resumen unificado en una sola línea\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"Ver email\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": \"Tarjeta\",\n            \"total_compra\": \"Ver justificante\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -464,
          688
        ],
        "id": "639143ee-f6eb-4832-af8e-48d41053a656",
        "name": "sierranevadagranada"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Alquiler",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.numero_fila }}",
              "MARCA": "={{ $json.marca }}",
              "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
              "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
              "EMAIL": "={{ $json.cliente_email }}",
              "ID PEDIDO": "={{ $json.id_pedido }}",
              "CANAL": "={{ $json.canal }}",
              "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
              "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
              "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
              "CANTIDAD": "={{ $json.cantidad }}",
              "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
              "RESUMEN": "={{ $json.productos_resumen }}"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "MARCA",
                "displayName": "MARCA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE CLIENTE",
                "displayName": "NOMBRE CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "APELLIDOS CLIENTE",
                "displayName": "APELLIDOS CLIENTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "EMAIL",
                "displayName": "EMAIL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANAL",
                "displayName": "CANAL",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "TOTAL COMPRA (+IVA)",
                "displayName": "TOTAL COMPRA (+IVA)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE PRODUCTO",
                "displayName": "NOMBRE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "CANTIDAD",
                "displayName": "CANTIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO UNITARIO",
                "displayName": "PRECIO UNITARIO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "RESUMEN",
                "displayName": "RESUMEN",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -288,
          688
        ],
        "id": "bdcbbe12-2485-403b-bbd0-1b060ee75634",
        "name": "Escribir sierranevadagranada",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Contador_Alquiler": "={{ $json.row_number + 1}}",
              "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "ID_Documento",
                "displayName": "ID_Documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador",
                "displayName": "Contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "Contador_Alquiler",
                "displayName": "Contador_Alquiler",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -128,
          688
        ],
        "id": "f91d9064-be06-467e-a244-f6f1999fc426",
        "name": "actualizar contador sierranevadagranada"
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "ghO8HECzTZgPqOqM",
            "mode": "list",
            "cachedResultName": "InformeDiario",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -816,
          480
        ],
        "id": "162dccd0-13f7-427e-8032-e9547d607c67",
        "name": "Get row(s)2"
      },
      {
        "parameters": {
          "pollTimes": {
            "item": [
              {
                "mode": "everyMinute"
              }
            ]
          },
          "simple": false,
          "filters": {
            "q": "from: (reservas@rules-shop.es OR reservas@surfin.es OR reservas@snowdivision.es OR info@sierranevadagranada.com)"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.gmailTrigger",
        "typeVersion": 1.3,
        "position": [
          -976,
          480
        ],
        "id": "424c4c3d-50d2-4125-9517-d6184f95d5d8",
        "name": "Correo",
        "credentials": {
          "gmailOAuth2": {
            "id": "fha7KwAzrDSA7OXO",
            "name": "ventas@sierranevadagranada.com"
          }
        }
      },
      {
        "parameters": {
          "content": "INFORME DIARIO DE ALQUILERES\n",
          "height": 896,
          "width": 1104,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1008,
          80
        ],
        "id": "62875833-b388-4db3-8958-e726c4d976d9",
        "name": "Sticky Note3"
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Get row(s)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Copy file": {
        "main": [
          [
            {
              "node": "Update row(s)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Schedule Trigger": {
        "main": [
          [
            {
              "node": "obtener fecha",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 2
            }
          ]
        ]
      },
      "Merge": {
        "main": [
          [
            {
              "node": "Code in JavaScript1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Update row in sheet",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript1": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update row(s)": {
        "main": [
          [
            {
              "node": "Insert row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)": {
        "main": [
          [
            {
              "node": "GraphQL",
              "type": "main",
              "index": 0
            },
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            },
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update row in sheet": {
        "main": [
          [
            {
              "node": "Update row(s)1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL1": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "GraphQL1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "obtener fecha": {
        "main": [
          [
            {
              "node": "formatear fecha",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "formatear fecha": {
        "main": [
          [
            {
              "node": "Copy file",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)1": {
        "main": [
          [
            {
              "node": "Send a message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "rules-shop",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "surfin",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "snowdivision",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "sierranevadagranada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "rules-shop": {
        "main": [
          [
            {
              "node": "Escribir Rules",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "surfin": {
        "main": [
          [
            {
              "node": "Escribir Surfin",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "snowdivision": {
        "main": [
          [
            {
              "node": "Escribir SnowDivision",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir SnowDivision": {
        "main": [
          [
            {
              "node": "actualizar contador snowdivision",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir Surfin": {
        "main": [
          [
            {
              "node": "actualizar contador surfin",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir Rules": {
        "main": [
          [
            {
              "node": "actualizar contador rules",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "sierranevadagranada": {
        "main": [
          [
            {
              "node": "Escribir sierranevadagranada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Escribir sierranevadagranada": {
        "main": [
          [
            {
              "node": "actualizar contador sierranevadagranada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)2": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Correo": {
        "main": [
          [
            {
              "node": "Get row(s)2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Info Tailwind",
    "name": "Version aece013d",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "aece013d-6ff6-4a9f-814f-e7bb6bf3944a",
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Copy file": {
      "main": [
        [
          {
            "node": "Update row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "obtener fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row(s)": {
      "main": [
        [
          {
            "node": "Insert row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "GraphQL",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Update row(s)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "GraphQL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener fecha": {
      "main": [
        [
          {
            "node": "formatear fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formatear fecha": {
      "main": [
        [
          {
            "node": "Copy file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)1": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "rules-shop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "surfin",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "snowdivision",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "sierranevadagranada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "rules-shop": {
      "main": [
        [
          {
            "node": "Escribir Rules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "surfin": {
      "main": [
        [
          {
            "node": "Escribir Surfin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "snowdivision": {
      "main": [
        [
          {
            "node": "Escribir SnowDivision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir SnowDivision": {
      "main": [
        [
          {
            "node": "actualizar contador snowdivision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir Surfin": {
      "main": [
        [
          {
            "node": "actualizar contador surfin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir Rules": {
      "main": [
        [
          {
            "node": "actualizar contador rules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sierranevadagranada": {
      "main": [
        [
          {
            "node": "Escribir sierranevadagranada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escribir sierranevadagranada": {
      "main": [
        [
          {
            "node": "actualizar contador sierranevadagranada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)2": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Correo": {
      "main": [
        [
          {
            "node": "Get row(s)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-15T07:50:18.774Z",
  "id": "sQUNg-VuSIFLaMIdA9znD",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Informe_Diario_Definitivo",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "informeDiario",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        240,
        480
      ],
      "id": "3a169d65-fc08-45f0-a1c1-197ef4d4aa08",
      "name": "Webhook",
      "webhookId": "7c1e3b37-6cc8-4f4a-81e3-c5897bdf497c"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
        "query": "query getOrder($id: ID!) {\n\n  order(id: $id) {\n\n    id\n\n    name\n\n    createdAt\n\n    email\n\n    totalPriceSet {\n\n      shopMoney {\n\n        amount\n\n        currencyCode\n\n      }\n\n    }\n\n    lineItems(first: 10) {\n\n      edges {\n\n        node {\n\n          title\n\n          quantity\n\n          originalUnitPriceSet {\n\n            shopMoney {\n\n              amount\n\n              currencyCode\n\n            }\n\n          }\n\n        }\n\n      }\n\n    }\n\n    fulfillments {\n\n      id\n\n      location {\n\n        name\n\n        address {\n\n          address1\n\n          city\n\n          province\n\n          country\n\n          zip\n\n        }\n\n      }\n\n    }\n\n    transactions(first: 5) {\n\n      formattedGateway\n\n      kind\n\n      status\n\n    }\n\n    customer {\n\n      firstName\n\n      lastName\n\n      email\n\n    }\n\n  }\n\n}\n",
        "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $('Webhook').item.json.body.id }}\"\n}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        624,
        480
      ],
      "id": "7255d822-ea0d-446d-83c9-1aee124ad0e8",
      "name": "GraphQL",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "content": "ENVIAR CORREO",
        "height": 208,
        "width": 384,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        192,
        768
      ],
      "id": "070b8235-6802-470b-bd7a-884c6711458e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "copy",
        "fileId": {
          "__rl": true,
          "value": "1QZ-GBz6D6EL4fZh3lh9PyAjwWzyjVn8nN0wy4mUjg04",
          "mode": "id"
        },
        "name": "=Informe_Diario_{{ $json.FECHA }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        656,
        128
      ],
      "id": "67d0cf56-a4b3-432d-9ab3-2b819b9f63a8",
      "name": "Copy file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "N7JXWgOiVoyCTaVL",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "content": "CREAR DOCUMENTO",
        "height": 208,
        "width": 960,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        192,
        80
      ],
      "id": "2b6bbfe7-3af9-4eb7-a19d-ec2a3322de91",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        224,
        128
      ],
      "id": "62e5fa32-0ae7-493b-875f-e37addba632a",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "8GDVj673ag0hCrVt",
          "mode": "list",
          "cachedResultName": "Informe Mensual",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/8GDVj673ag0hCrVt"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Documento": "={{ $('Copy file').item.json.id }}",
            "fecha": "={{ $('formatear fecha').item.json.FECHA }}"
          },
          "matchingColumns": [
            "ID_Documento"
          ],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        960,
        128
      ],
      "id": "e5db14bd-7dca-40a9-bee1-b422e5e5f4a0",
      "name": "Insert row"
    },
    {
      "parameters": {
        "jsCode": "// El nodo Code de n8n espera que devolvamos un array de objetos.\nconst outputItems = [];\n\n// Obtenemos el valor del contador del nodo anterior\n// items[0].json.Contador → 2 en tu ejemplo\nlet numeroFila = items[0].json.Contador;\nlet ID_documento = items[0].json.ID_Documento;\n\n// 1. Accedemos al cuerpo real del pedido de Shopify, que está anidado.\nconst orderBody = $node['Webhook'].json.body; \n\n// 2. Extraemos los artículos de línea (productos) y la moneda.\nconst lineItems = orderBody.line_items;\nconst orderCurrency = orderBody.currency;\n\n// Iteramos sobre cada producto individual\nfor (const item of lineItems) {\n\n  const originalPrice = parseFloat(item.price);\n\n  let totalDiscountAmount = 0;\n  for (const allocation of item.discount_allocations) {\n    totalDiscountAmount += parseFloat(allocation.amount);\n  }\n\n  const finalPaidPrice = originalPrice - totalDiscountAmount;\n\n  // Creamos un nuevo objeto y añadimos \"numero_fila\"\n  outputItems.push({\n    json: {\n      ID_documento: ID_documento,\n      numero_fila: numeroFila,   // ← Nuevo campo\n      product_name: item.title,\n      sku: item.sku,\n      variant_title: item.variant_title,\n      original_price: originalPrice.toFixed(2),\n      total_discount_applied: totalDiscountAmount.toFixed(2),\n      final_paid_price: finalPaidPrice.toFixed(2),\n      currency: orderCurrency\n    }\n  });\n\n  // ↑ Incrementamos para el siguiente item\n  numeroFila++;\n}\n\n// Devolvemos el array con los nuevos objetos.\nreturn outputItems;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        624
      ],
      "id": "f74317cd-37d0-4262-a761-d94cdf479b6a",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        864,
        464
      ],
      "id": "5007c6bb-31eb-4b15-be8a-fb06c3e7962e",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "31828549-6a33-4e8a-91ad-fdb9692a7e34",
              "name": "SUCURSAL DE VENTA",
              "value": "={{ $json.fulfillmentLocation }}",
              "type": "string"
            },
            {
              "id": "e89736ae-2f29-40c8-80b4-2181722ee3f5",
              "name": "METODO DE PAGO",
              "value": "={{ $json.transactionGateway }}",
              "type": "string"
            },
            {
              "id": "dc4a77f5-966d-4efc-b755-1f0fe34f6958",
              "name": "COSTO POR UNIDAD",
              "value": "={{ $json.product.unit_cost }}",
              "type": "string"
            },
            {
              "id": "76140f31-efab-4a68-b737-53f04a9a7b81",
              "name": "COSTE DE PRODUCTO",
              "value": "={{ $json.product.original_price }}",
              "type": "string"
            },
            {
              "id": "d295df2e-e935-41ef-a2b1-7923cabd1a92",
              "name": "PRECIO PAGADO",
              "value": "={{ $json.product.final_paid_price }}",
              "type": "string"
            },
            {
              "id": "adb9ae5a-50d9-4923-b706-31a9a5b86e66",
              "name": "DESCUENTO",
              "value": "={{ $json.product.total_discount_applied }}",
              "type": "string"
            },
            {
              "id": "c2b11c61-81c1-4b6d-94ec-c55b6872e5e0",
              "name": "NOMBRE DE PRODUCTO",
              "value": "={{ $json.product.product_name }}",
              "type": "string"
            },
            {
              "id": "f7cbe128-fbe4-4bfb-b5ec-d7eed2f87b84",
              "name": "VARIANTE",
              "value": "={{ $json.product.variant_title }}",
              "type": "string"
            },
            {
              "id": "1e31a3b3-a073-4113-9047-95110c3d7987",
              "name": "NUMERO_FILA",
              "value": "={{ $json.product.numero_fila }}",
              "type": "number"
            },
            {
              "id": "e4c20adf-aa16-46e1-9851-3844e08241a6",
              "name": "ID_DOCUMENTO",
              "value": "={{ $json.product.ID_documento }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1136,
        480
      ],
      "id": "b52e6336-e7f7-40dd-ad46-c520b057c406",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// 1. Validaciones básicas\nif (items.length < 2) {\n    throw new Error(\"Se esperaban al menos 2 ítems de entrada.\");\n}\n\n// Inicializamos variables\nlet orderData = null;\nconst productRows = []; // Aquí guardaremos los ítems que tienen ID_documento\nconst costMap = {}; // Aquí guardaremos los costos indexados por SKU\n\n// 2. Clasificar los ítems de entrada\nfor (const item of items) {\n    const json = item.json;\n\n    // A) Es la ORDEN (tiene data.order)\n    if (json.data && json.data.order) {\n        orderData = json.data.order;\n    } \n    // B) Es información de COSTO de Shopify (tiene data.productVariant)\n    else if (json.data && json.data.productVariant) {\n        const variant = json.data.productVariant;\n        const sku = variant.sku;\n        const costAmount = variant.inventoryItem?.unitCost?.amount;\n        \n        // Guardamos el costo en un objeto usando el SKU como clave para buscarlo rápido después\n        if (sku && costAmount) {\n            costMap[sku] = costAmount;\n        }\n    }\n    // C) Es el ítem procesado (tiene ID_documento)\n    else if (json.ID_documento) {\n        productRows.push(json);\n    }\n}\n\nif (!orderData) {\n    throw new Error(\"No se encontró el ítem de la orden de Shopify.\");\n}\n\nif (productRows.length === 0) {\n    throw new Error(\"No se encontraron ítems de producto con ID_documento.\");\n}\n\n// 3. Crear objeto base de la orden\nconst baseOrderData = {\n    id: orderData.id,\n    name: orderData.name,\n    createdAt: orderData.createdAt,\n    totalPrice: orderData.totalPriceSet?.shopMoney?.amount || 'N/A',\n    currencyCode: orderData.totalPriceSet?.shopMoney?.currencyCode || 'N/A',\n    \n    // Datos del cliente\n    customer: orderData.customer,\n    \n    // Datos de envío\n    fulfillmentLocation: orderData.fulfillments?.[0]?.location?.name || 'N/A',\n    fulfillmentAddress: orderData.fulfillments?.[0]?.location?.address || 'N/A',\n    \n    // Datos de la transacción\n    transactionGateway: orderData.transactions?.[0]?.formattedGateway || 'N/A',\n    transactionKind: orderData.transactions?.[0]?.kind || 'N/A',\n    transactionStatus: orderData.transactions?.[0]?.status || 'N/A',\n};\n\n// 4. Iterar sobre los productos y fusionar (incluyendo el costo encontrado)\nconst combinedItems = [];\n\nfor (const productData of productRows) {\n    \n    // Buscamos si existe un costo guardado para este SKU\n    const sku = productData.sku;\n    const unitCost = costMap[sku] || '0.00'; // Si no encuentra match, pone 0.00 o N/A\n\n    const combinedItem = {\n        ...baseOrderData,\n        \n        product: {\n            ID_documento: productData.ID_documento,\n            numero_fila: productData.numero_fila,\n            product_name: productData.product_name,\n            sku: productData.sku,\n            variant_title: productData.variant_title,\n            original_price: productData.original_price,\n            total_discount_applied: productData.total_discount_applied,\n            final_paid_price: productData.final_paid_price,\n            currency: productData.currency,\n            // Aquí agregamos el campo solicitado\n            unit_cost: unitCost \n        }\n    };\n    \n    combinedItems.push({\n        json: combinedItem,\n    });\n}\n\nreturn combinedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        480
      ],
      "id": "38bbf384-1b40-4d4d-b5cc-97d8454a7303",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Documento": "={{ $json.id }}",
            "Contador": 2,
            "Contador_Alquiler": 2
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        800,
        128
      ],
      "id": "954c39f5-d1ab-48b0-a72f-d98b54032d3b",
      "name": "Update row(s)"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        416,
        480
      ],
      "id": "4f754bc8-b2f2-4dd8-a946-e584b5dab050",
      "name": "Get row(s)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $json.ID_DOCUMENTO}}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19bvtVxQK6uMbxP2HZKgGEGM_KWyvJM3vLp1APRSSTEY/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.NUMERO_FILA }}",
            "SUCURSAL DE VENTA": "={{ $json['SUCURSAL DE VENTA'] }}",
            "MÉTODO DE PAGO": "={{ $json['METODO DE PAGO'] }}",
            "COSTE POR UNIDAD": "={{ $json['COSTO POR UNIDAD'] }}",
            "PRECIO DE PRODUCTO": "={{ $json['COSTE DE PRODUCTO'] }}",
            "PRECIO PAGADO": "={{ $json['PRECIO PAGADO'] }}",
            "DESCUENTO": "={{ $json.DESCUENTO }}",
            "NOMBRE DE PRODUCTO": "={{ $json['NOMBRE DE PRODUCTO'] }}",
            "VARIANTE": "={{ $json.VARIANTE }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "SUCURSAL DE VENTA",
              "displayName": "SUCURSAL DE VENTA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "COSTE POR UNIDAD",
              "displayName": "COSTE POR UNIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO DE PRODUCTO",
              "displayName": "PRECIO DE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO PAGADO",
              "displayName": "PRECIO PAGADO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "DESCUENTO",
              "displayName": "DESCUENTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE DE PRODUCTO",
              "displayName": "NOMBRE DE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "SURFIN SIERRA NEVADA",
              "displayName": "SURFIN SIERRA NEVADA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tarjeta",
              "displayName": "Tarjeta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Efectivo",
              "displayName": "Efectivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Venta Web",
              "displayName": "Venta Web",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL",
              "displayName": "TOTAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1280,
        480
      ],
      "id": "3456907e-1889-4e9d-87b5-40ea7f7453de",
      "name": "Update row in sheet",
      "executeOnce": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Documento": "={{ $('Edit Fields').item.json.ID_DOCUMENTO }}",
            "Contador": "={{ $('Edit Fields').item.json.NUMERO_FILA  + 1}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1440,
        480
      ],
      "id": "faf01950-eda5-4601-8b6c-75240e769c87",
      "name": "Update row(s)1"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
        "query": "query getVariantCost($id: ID!) {\n  productVariant(id: $id) {\n    id\n    sku\n    title\n    inventoryItem {\n      id\n      unitCost {\n        amount\n        currencyCode\n      }\n    }\n  }\n}\n\n",
        "variables": "={\n  \"id\": \"{{ $json['ID VARIANTE'] }}\"\n}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        688,
        336
      ],
      "id": "0547d26f-e2d4-4a83-ad9a-3b3f4097a3c2",
      "name": "GraphQL1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "711be730-983a-47e6-99f2-d818a44482be",
              "name": "ID VARIANTE",
              "value": "=gid://shopify/ProductVariant/{{ $('Webhook').item.json.body.line_items[0].variant_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        576,
        336
      ],
      "id": "296715bd-4cb8-4930-a0d7-966761cc3f3b",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "87a5aeba-2adf-47d1-8d7b-b55d5016266a",
              "name": "FECHA",
              "value": "={{ $today }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        368,
        128
      ],
      "id": "fccdf808-f4e0-4782-a70b-a6b6e00c2e42",
      "name": "obtener fecha"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  const fecha = new Date(item.json.FECHA);\n\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const anio = fecha.getFullYear();\n\n  item.json.FECHA = `${dia}/${mes}/${anio}`;\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        128
      ],
      "id": "a2ae42c0-c272-4555-ae7f-445636e14ba8",
      "name": "formatear fecha"
    },
    {
      "parameters": {
        "content": "ACTUALIZAR DOCUMENTO CON CADA PEDIDO",
        "height": 448,
        "width": 1456,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        192,
        304
      ],
      "id": "851e0c70-842c-46c7-a56a-b490e4cc792d",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "sendTo": "emilianomartinezvrd@gmail.com",
        "subject": "Informe diario mamawebaso",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333333;\">\n  \n  <h2 style=\"color: #2c3e50; border-bottom: 2px solid #007bff; padding-bottom: 10px;\">\n    INFORME DIARIO ({{ $now.toFormat('dd/MM/yyyy') }})\n  </h2>\n\n  <p>Hola,</p>\n  \n  <p>Aquí tienes el informe actualizado correspondiente al día de hoy.</p>\n  <p>Puedes acceder al archivo o recurso haciendo clic en el siguiente botón:</p>\n\n  <div style=\"margin: 30px 0;\">\n    <a href=\"https://docs.google.com/spreadsheets/d/{{ $json.ID_Documento }}/edit?gid=0#gid=0\" \n       style=\"background-color: #007bff; color: #ffffff; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n       VER DOCUMENTO\n    </a>\n  </div>\n\n  <p style=\"font-size: 12px; color: #888;\">\n    Este es un mensaje automático enviado por tu flujo de n8n.\n  </p>\n  \n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        384,
        816
      ],
      "id": "e0a1443f-7789-45c3-88a0-4471df57e63a",
      "name": "Send a message",
      "webhookId": "395b376a-113e-4e7e-b92d-4afaa0028904",
      "credentials": {
        "gmailOAuth2": {
          "id": "wR7U82S8bmDH4odC",
          "name": "info@tailwind.es"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        224,
        816
      ],
      "id": "6762e93d-c33c-4008-9d9c-7fd70d47fbf5",
      "name": "Get row(s)1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Correo').item.json.from.text }}",
                    "rightValue": "=reservas@rules-shop.es",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5702ef6b-4e43-4933-9af3-abf329de5e06"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "1384d8f9-c75c-4be1-a293-98c0d102292b",
                    "leftValue": "={{ $('Correo').item.json.from.text }}",
                    "rightValue": "reservas@surfin.es",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "fe1d90fc-f649-48e8-9f37-c58ef22f10c7",
                    "leftValue": "={{ $('Correo').item.json.from.text }}",
                    "rightValue": "reservas@snowdivision.es",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "06d5176e-59be-4584-9efb-c8a5f233789c",
                    "leftValue": "={{ $('Correo').item.json.from.value[0].address }}",
                    "rightValue": "info@sierranevadagranada.com",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -656,
        448
      ],
      "id": "fa3ccb4f-aef5-4d7b-a691-90267f5171fe",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $input.first().json; // O $('Nombre_Nodo_Gmail').item.json\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base (si viene de un nodo anterior de base de datos)\nconst contadorBase = parseInt(correoOriginal.Contador_Alquiler) || 0;\n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\n// En tu ejemplo el nombre está vacío en el subject: \"Rules - Compra efectuada -  - canal Cajas\"\nif (partesAsunto.length >= 3 && partesAsunto[2].trim() !== \"\") {\n    nombreCompleto = partesAsunto[2].trim();\n}\n\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = nombrePartes[0] || \"No encontrado\";\nconst apellidos = nombrePartes.slice(1).join(\" \") || \"\";\n\n// CORRECCIÓN LÍNEA 24: Acceso seguro al email del cliente\n// Buscamos en 'to', o en el header 'delivered-to' que sí existe en tu JSON\nconst clienteEmail = (correoOriginal.to?.value?.[0]?.address \n                     || correoOriginal.headers?.[\"delivered-to\"]?.replace(\"Delivered-To: \", \"\") \n                     || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/i);\nconst precioTotal = totalMatch ? totalMatch[1].trim() : \"0.00\";\n\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/i);\nconst idPedido = orderMatch ? orderMatch[1].trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/i);\nconst canalVenta = canalMatch ? canalMatch[1].trim() : \"Desconocido\";\n\n// Buscamos \"Card checkout\" en el bloque de pagos\nconst pagoMatch = bodyText.match(/Card checkout/i);\nconst metodoPago = pagoMatch ? \"Tarjeta (Card checkout)\" : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\n// Este regex busca el nombre (mayúsculas), la cantidad y el precio con el símbolo €\nconst productRegex = /([A-ZÁÉÍÓÚÑ0-9\\s\\-]{3,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    // Normalización de productos específicos\n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n    \n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad, \n            precio_unitario: precioUnitario \n        };\n    }\n}\n\n// 8. Generar salida plana para n8n\nconst productosArray = Object.values(productosMap);\n\n// Si no se detectaron productos con el regex, creamos uno genérico para no perder la fila\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"Producto no detectado\", cantidad: 1, precio_unitario: precioTotal });\n}\n\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    // La primera fila lleva todos los datos, las siguientes (si hay más productos) solo los del producto\n    if (index === 0) {\n        return {\n            json: {\n                \"numero_fila\": numeroFilaActual,\n                \"marca\": marca,\n                \"cliente_nombre\": nombre,\n                \"cliente_apellidos\": apellidos,\n                \"cliente_email\": clienteEmail,\n                \"id_pedido\": idPedido,\n                \"canal\": canalVenta,\n                \"metodo_pago\": metodoPago,\n                \"total_compra\": precioTotal,\n                \"nombre_producto\": prod.nombre,\n                \"cantidad\": prod.cantidad,\n                \"precio_unitario\": prod.precio_unitario,\n                \"productos_resumen\": resumenTexto\n            }\n        };\n    } else {\n        return {\n            json: {\n                \"numero_fila\": numeroFilaActual,\n                \"marca\": \"\",\n                \"cliente_nombre\": \"\",\n                \"cliente_apellidos\": \"\",\n                \"cliente_email\": \"\",\n                \"id_pedido\": \"\",\n                \"canal\": \"\",\n                \"metodo_pago\": \"\",\n                \"total_compra\": \"\",\n                \"nombre_producto\": prod.nombre,\n                \"cantidad\": prod.cantidad,\n                \"precio_unitario\": prod.precio_unitario,\n                \"productos_resumen\": \"\"\n            }\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        256
      ],
      "id": "132c4e3b-b445-4f4b-bdff-7374f9e5ff18",
      "name": "rules-shop"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca\nconst marca = subject.includes(\"Surfin\") ? \"Surfin\" : (subject.includes(\"Snow Division\") ? \"Snow Division\" : \"Rules\");\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No indicado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3 && partesAsunto[2].trim() !== \"\") {\n    nombreCompleto = partesAsunto[2].trim();\n}\n\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"No indicado\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\n\nconst clienteEmail = (correoOriginal.to?.value?.[0]?.address || correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\n\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /PRODUCTO\\n\\n(\\d+)\\s+([\\d,.]+)€\\n\\nLocalizador:\\s*([a-z0-9]+)\\nConcepto:\\s*([^\\n]+)/gi;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y normalizamos espacios\n    let nombreProd = match[4].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim().toUpperCase();\n    const cantidad = parseInt(match[1]);\n    const precioUnitario = match[2].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Fallback si el anterior no captura nada\nif (Object.keys(productosMap).length === 0) {\n    const fallbackRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\n    let fallbackMatch;\n    while ((fallbackMatch = fallbackRegex.exec(bodyText)) !== null) {\n        // LIMPIEZA: También en el fallback\n        let nProd = fallbackMatch[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n        if (nProd.includes(\"2X1\")) nProd = \"EQUIPO ESQUÍ 2X1\";\n        const cant = parseInt(fallbackMatch[2]);\n        const prec = fallbackMatch[3].replace(',', '.').replace(/\\n/g, '').trim();\n        if (productosMap[nProd]) productosMap[nProd].cantidad += cant;\n        else productosMap[nProd] = { nombre: nProd, cantidad: cant, precio_unitario: prec };\n    }\n}\n\n// 9. CREAR SALIDA DIFERENCIADA\nconst productosArray = Object.values(productosMap);\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"0.00\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"MARCA\": marca,\n            \"NOMBRE CLIENTE\": nombre,\n            \"APELLIDOS\": apellidos,\n            \"ID PEDIDO\": idPedido,\n            \"EMAIL\": clienteEmail,\n            \"CANAL\": canalVenta,\n            \"MÉTODO DE PAGO\": metodoPago,\n            \"TOTAL COMPRA (+IVA)\": precioTotal,\n            \"NOMBRE PRODUCTO\": prod.nombre,\n            \"CANTIDAD\": prod.cantidad,\n            \"PRECIO UNITARIO\": prod.precio_unitario,\n            \"RESUMEN\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"MARCA\": \"\", \n            \"NOMBRE CLIENTE\": \"\",\n            \"APELLIDOS\": \"\",\n            \"ID PEDIDO\": \"\",\n            \"EMAIL\": \"\",\n            \"CANAL\": \"\",\n            \"MÉTODO DE PAGO\": \"\",\n            \"TOTAL COMPRA (+IVA)\": \"\",\n            \"NOMBRE PRODUCTO\": prod.nombre,\n            \"CANTIDAD\": prod.cantidad,\n            \"PRECIO UNITARIO\": prod.precio_unitario,\n            \"RESUMEN\": \"\"\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        400
      ],
      "id": "d58a6580-401b-4d55-bc2f-a2bcb34c3ee5",
      "name": "surfin"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0; \n\n// 3. Identificar Marca\nlet marca = \"Rules\";\nif (subject.toLowerCase().includes(\"surfin\")) marca = \"Surfin\";\nif (subject.toLowerCase().includes(\"snow division\")) marca = \"Snow Division\";\n\n// 4. Extraer Datos del Cliente\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 3) {\n    nombreCompleto = partesAsunto[2].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.to.value[0].address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Totales e Identificador\nconst totalMatch = bodyText.match(/TOTAL:\\s*([\\d,.]+)/);\nconst precioTotal = totalMatch ? totalMatch[1].replace(/\\n/g, '').trim() : \"0.00\";\nconst orderMatch = bodyText.match(/Identificador:\\s*\\n*([A-Z0-9]+)/);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal y Método de Pago\nconst canalMatch = bodyText.match(/Canal:\\s*\\n*([^\\n]+)/);\nconst canalVenta = canalMatch ? canalMatch[1].replace(/\\n/g, ' ').trim() : \"Desconocido\";\nconst pagoMatch = bodyText.match(/Acción requerida\\s+[\\d,.]+€\\s+[\\d/]+\\s+([^\\n\\t]+)\\s+Efectuado/i);\nconst metodoPago = pagoMatch ? pagoMatch[1].replace(/\\n/g, ' ').trim() : \"No encontrado\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\nconst productRegex = /([A-Z0-9\\sÁÉÍÓÚÑ\\-]{5,})\\n\\n(\\d+)\\s+([\\d,.]+)€/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Eliminamos saltos de línea y colapsamos espacios múltiples en el nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    \n    if (nombreProd.includes(\"2X1\")) nombreProd = \"EQUIPO ESQUÍ 2X1\";\n    const cantidad = parseInt(match[2]);\n    const precioUnitario = match[3].replace(',', '.').replace(/\\n/g, '').trim();\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { nombre: nombreProd, cantidad, precio_unitario: precioUnitario };\n    }\n}\n\n// 8. Generar salida plana para Google Sheets\nconst productosArray = Object.values(productosMap);\n// LIMPIEZA: Resumen sin saltos de línea para que no rompa la celda\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": metodoPago,\n            \"total_compra\": precioTotal,\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        544
      ],
      "id": "9031743d-79e1-4b7d-a852-e3aa8b68164a",
      "name": "snowdivision"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "MARCA": "={{ $json.marca }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}",
            "row_number": "={{ $json.numero_fila }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -288,
        544
      ],
      "id": "7367a66d-8df9-476b-8c0b-5479607fb339",
      "name": "Escribir SnowDivision",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "MARCA": "={{ $json.marca }}",
            "row_number": "={{ $json.numero_fila }}",
            "NOMBRE CLIENTE": "={{ $json.nombre_cliente }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -288,
        400
      ],
      "id": "e4cb0885-b4e6-46e5-abc8-ced7e117233d",
      "name": "Escribir Surfin",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.numero_fila }}",
            "MARCA": "={{ $json.marca }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -288,
        256
      ],
      "id": "9262d50b-9185-4607-81c6-ad91edd89465",
      "name": "Escribir Rules",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador": "={{ $('Get row(s)2').item.json.Contador }}",
            "Contador_Alquiler": "={{ $json.row_number + 1}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -128,
        256
      ],
      "id": "520dc12b-583c-40bd-80d8-b54401ade2f1",
      "name": "actualizar contador rules"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador_Alquiler": "={{ $json.row_number + 1}}",
            "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -128,
        400
      ],
      "id": "6b0db584-2a39-46bb-902d-9131fa4ce1e0",
      "name": "actualizar contador surfin"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador_Alquiler": "={{ $json.row_number + 1}}",
            "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "dryRun": false
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -128,
        544
      ],
      "id": "56f1f664-3f3e-480a-84a8-f9067fb0d648",
      "name": "actualizar contador snowdivision"
    },
    {
      "parameters": {
        "jsCode": "// 1. Accedemos a los datos del email original del nodo \"Correo\"\nconst correoOriginal = $('Correo').item.json;\nconst subject = (correoOriginal.subject || \"\").replace(/\\n/g, ' ').trim();\nconst bodyText = correoOriginal.text || \"\";\n\n// 2. Accedemos al contador base del nodo anterior ($input)\nconst datosPrevios = $input.first().json;\nconst contadorBase = parseInt(datosPrevios.Contador_Alquiler) || 0;\n\n// 3. Extraer Marca (Sierra Nevada Granada)\nlet marca = \"Sierra Nevada Granada\";\n\n// 4. Extraer Datos del Cliente del Subject\nlet nombreCompleto = \"No encontrado\";\nconst partesAsunto = subject.split(\" - \");\nif (partesAsunto.length >= 2) {\n    nombreCompleto = partesAsunto[1].trim();\n}\nconst nombrePartes = nombreCompleto.split(\" \");\nconst nombre = (nombrePartes[0] || \"\").replace(/\\n/g, '').trim();\nconst apellidos = nombrePartes.slice(1).join(\" \").replace(/\\n/g, '').trim();\nconst clienteEmail = (correoOriginal.from?.value?.[0]?.address || \"No encontrado\").replace(/\\n/g, '').trim();\n\n// 5. Identificador del Pedido (Número: SO...)\nconst orderMatch = bodyText.match(/N[úu]mero:\\s*(SO\\d+)/i);\nconst idPedido = orderMatch ? orderMatch[1].replace(/\\n/g, '').trim() : \"No encontrado\";\n\n// 6. Canal de Venta\nconst canalVenta = partesAsunto[2] ? partesAsunto[2].replace(\"canal \", \"\").replace(/\\n/g, ' ').trim() : \"Reservas\";\n\n// 7. Extraer y AGRUPAR Productos\nconst productosMap = {};\n\n/** * Regex para el formato Sierra Nevada: Limpia saltos de línea dentro del nombre\n */\nconst productRegex = /Descripci[óo]n\\s+Cant\\.\\s+([\\w\\sÁÉÍÓÚÑ\\-]+?)\\s+(\\d+[\\d,.]*)/g;\nlet match;\n\nwhile ((match = productRegex.exec(bodyText)) !== null) {\n    // LIMPIEZA: Quitamos saltos de línea y espacios múltiples del nombre del producto\n    let nombreProd = match[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n    nombreProd = nombreProd.split('  ')[0].trim(); // Evita capturar cabeceras si se filtran\n    \n    const cantidad = parseInt(match[2].split(',')[0]);\n\n    if (productosMap[nombreProd]) {\n        productosMap[nombreProd].cantidad += cantidad;\n    } else {\n        productosMap[nombreProd] = { \n            nombre: nombreProd, \n            cantidad: cantidad, \n            precio_unitario: \"Ver email\" \n        };\n    }\n}\n\n// 8. Búsqueda de emergencia para Forfaits (limpia también)\nif (Object.keys(productosMap).length === 0) {\n    const forfaitMatch = bodyText.match(/Forfait\\s+D[íi]as\\s+Consecutivos/i);\n    if (forfaitMatch) {\n        productosMap[\"FORFAIT DÍAS CONSECUTIVOS\"] = { nombre: \"FORFAIT DÍAS CONSECUTIVOS\", cantidad: 1, precio_unitario: \"Ver email\" };\n    }\n}\n\n// 9. Generar salida para Google Sheets\nconst productosArray = Object.values(productosMap);\n// Resumen unificado en una sola línea\nconst resumenTexto = productosArray.map(p => `${p.nombre} x${p.cantidad}`).join(', ').replace(/\\n/g, ' ');\n\nif (productosArray.length === 0) {\n    productosArray.push({ nombre: \"PRODUCTO NO DETECTADO\", cantidad: 1, precio_unitario: \"Ver email\" });\n}\n\nreturn productosArray.map((prod, index) => {\n    const numeroFilaActual = contadorBase + index;\n\n    if (index === 0) {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": marca,\n            \"cliente_nombre\": nombre,\n            \"cliente_apellidos\": apellidos,\n            \"cliente_email\": clienteEmail,\n            \"id_pedido\": idPedido,\n            \"canal\": canalVenta,\n            \"metodo_pago\": \"Tarjeta\",\n            \"total_compra\": \"Ver justificante\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": resumenTexto\n        };\n    } else {\n        return {\n            \"numero_fila\": numeroFilaActual,\n            \"marca\": \"\",\n            \"cliente_nombre\": \"\",\n            \"cliente_apellidos\": \"\",\n            \"cliente_email\": \"\",\n            \"id_pedido\": \"\",\n            \"canal\": \"\",\n            \"metodo_pago\": \"\",\n            \"total_compra\": \"\",\n            \"nombre_producto\": prod.nombre,\n            \"cantidad\": prod.cantidad,\n            \"precio_unitario\": prod.precio_unitario,\n            \"productos_resumen\": \"\"\n        };\n    }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        688
      ],
      "id": "639143ee-f6eb-4832-af8e-48d41053a656",
      "name": "sierranevadagranada"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Get row(s)2').item.json.ID_Documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Alquiler",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.numero_fila }}",
            "MARCA": "={{ $json.marca }}",
            "NOMBRE CLIENTE": "={{ $json.cliente_nombre }}",
            "APELLIDOS CLIENTE": "={{ $json.cliente_apellidos }}",
            "EMAIL": "={{ $json.cliente_email }}",
            "ID PEDIDO": "={{ $json.id_pedido }}",
            "CANAL": "={{ $json.canal }}",
            "MÉTODO DE PAGO": "={{ $json.metodo_pago }}",
            "TOTAL COMPRA (+IVA)": "={{ $json.total_compra }}",
            "NOMBRE PRODUCTO": "={{ $json.nombre_producto }}",
            "CANTIDAD": "={{ $json.cantidad }}",
            "PRECIO UNITARIO": "={{ $json.precio_unitario }}",
            "RESUMEN": "={{ $json.productos_resumen }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "MARCA",
              "displayName": "MARCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE CLIENTE",
              "displayName": "NOMBRE CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "APELLIDOS CLIENTE",
              "displayName": "APELLIDOS CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "EMAIL",
              "displayName": "EMAIL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANAL",
              "displayName": "CANAL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TOTAL COMPRA (+IVA)",
              "displayName": "TOTAL COMPRA (+IVA)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE PRODUCTO",
              "displayName": "NOMBRE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANTIDAD",
              "displayName": "CANTIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO UNITARIO",
              "displayName": "PRECIO UNITARIO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "RESUMEN",
              "displayName": "RESUMEN",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -288,
        688
      ],
      "id": "bdcbbe12-2485-403b-bbd0-1b060ee75634",
      "name": "Escribir sierranevadagranada",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Contador_Alquiler": "={{ $json.row_number + 1}}",
            "Contador": "={{ $('Get row(s)2').item.json.Contador }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID_Documento",
              "displayName": "ID_Documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador",
              "displayName": "Contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Contador_Alquiler",
              "displayName": "Contador_Alquiler",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -128,
        688
      ],
      "id": "f91d9064-be06-467e-a244-f6f1999fc426",
      "name": "actualizar contador sierranevadagranada"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ghO8HECzTZgPqOqM",
          "mode": "list",
          "cachedResultName": "InformeDiario",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/ghO8HECzTZgPqOqM"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -816,
        480
      ],
      "id": "162dccd0-13f7-427e-8032-e9547d607c67",
      "name": "Get row(s)2"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {
          "q": "from: (reservas@rules-shop.es OR reservas@surfin.es OR reservas@snowdivision.es OR info@sierranevadagranada.com)"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -976,
        480
      ],
      "id": "424c4c3d-50d2-4125-9517-d6184f95d5d8",
      "name": "Correo",
      "credentials": {
        "gmailOAuth2": {
          "id": "fha7KwAzrDSA7OXO",
          "name": "ventas@sierranevadagranada.com"
        }
      }
    },
    {
      "parameters": {
        "content": "INFORME DIARIO DE ALQUILERES\n",
        "height": 896,
        "width": 1104,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1008,
        80
      ],
      "id": "62875833-b388-4db3-8958-e726c4d976d9",
      "name": "Sticky Note3"
    }
  ],
  "pinData": {
    "Correo": [
      {
        "json": {
          "id": "19c046ccecbf06ea",
          "threadId": "19c046ccecbf06ea",
          "labelIds": [
            "UNREAD",
            "IMPORTANT",
            "CATEGORY_PERSONAL",
            "INBOX"
          ],
          "sizeEstimate": 24559,
          "headers": {
            "delivered-to": "Delivered-To: ventas@sierranevadagranada.com",
            "received": "Received: from wn0sdwk0000RF ([20.23.138.213])\r\n        by smtp.gmail.com with ESMTPSA id 4fb4d7f45d1cf-658b469e6b2sm1384744a12.26.2026.01.28.03.46.01\r\n        for <ventas@sierranevadagranada.com>\r\n        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);\r\n        Wed, 28 Jan 2026 03:46:02 -0800 (PST)",
            "x-forwarded-encrypted": "X-Forwarded-Encrypted: i=1; AJvYcCVGe77/feqkkFqgjyFFe70jxo0AfPjFjIrYOxv9BmD7pGEYaIKKWVsZ/63YJH3m2wdTJAYBeZk=@sierranevadagranada.com",
            "x-received": "X-Received: by 2002:a05:6402:5106:b0:64b:4315:d39 with SMTP id 4fb4d7f45d1cf-658a60cadccmr2991811a12.27.1769600764721;\r\n        Wed, 28 Jan 2026 03:46:04 -0800 (PST)",
            "arc-seal": "ARC-Seal: i=1; a=rsa-sha256; t=1769600765; cv=none;\r\n        d=google.com; s=arc-20240605;\r\n        b=k2o0DxjbUOWwZyaFJMUswYv4dsg6XOPGs/1ZF3mAYydVGxK1VtdWDREfsYHPBhPrMI\r\n         9iJItOJNuTDGrsOwpc4gvl+OuEmQ8pJuDZosbb210d6YVP5MucFJM6bCYec2TrHn3aVv\r\n         tfxTXwYLr3u6tq3yDgapF0C1P2lKEVjAK27gWN7vWHgF6dFtVYPib2lz+IwQH8vXZfdq\r\n         lW3ZX7/iWdYMx/ck/YLZMWYbT5dRA7XLDiAUM529nBDrw/Dt+9Qox346oLtbgg347P7z\r\n         UpfeDD20rVEMS+Q2uRfhu3mRi4geg5mGWgUi+Zt9PALKsHZw6/ajULr2Kb6xPPVaiH2Z\r\n         jzsw==",
            "arc-message-signature": "ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20240605;\r\n        h=content-transfer-encoding:subject:from:mime-version:date:message-id\r\n         :dkim-signature;\r\n        bh=ppyvuahg7zh35LWzZpCX0tvA8BMr45jRklK69UhsUQ4=;\r\n        fh=MqI2XPIK20qwIlqyPPLRS5Ye9VZVmtbYbjslelDBO6Q=;\r\n        b=V37Omh6O9T4Bouf/r1Rm16jWAebMe59wAXkxnqkr7EJCzg2jcn8zVFxFM1T52zorQd\r\n         rt/yTUFuJT/rQwNtdONfMEx+nJpiNilhlOlPCCffVGqWVcO2HOqQen8OJCiwQAF0rR4p\r\n         FriqFSE6NCvU8shGFsi5y6YC8KbziErG/0L3c+KMPtpYG4eGoKMQfhGStpPniO3NYkev\r\n         kW2RHLmoV8o5Lq3+CzNKHUnb2dUX5d1ZnWpWXgaDoCeFo5GwOdHGSjy8t+k7ZuAhu4Ga\r\n         bFIDqbHDtCsI8hQhUmwA2AlB5M9e3ftg0J96gm2F9WEvfjW3wBVL3dcJsnJ3C7OClDxG\r\n         uLyg==;\r\n        dara=google.com",
            "arc-authentication-results": "ARC-Authentication-Results: i=1; mx.google.com;\r\n       dkim=pass header.i=@rules-shop-es.20230601.gappssmtp.com header.s=20230601 header.b=\"R/Jad1X1\";\r\n       spf=pass (google.com: domain of reservas@rules-shop.es designates 209.85.220.65 as permitted sender) smtp.mailfrom=reservas@rules-shop.es;\r\n       dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=rules-shop.es;\r\n       dara=neutral header.i=@sierranevadagranada.com",
            "return-path": "Return-Path: <reservas@rules-shop.es>",
            "received-spf": "Received-SPF: pass (google.com: domain of reservas@rules-shop.es designates 209.85.220.65 as permitted sender) client-ip=209.85.220.65;",
            "authentication-results": "Authentication-Results: mx.google.com;\r\n       dkim=pass header.i=@rules-shop-es.20230601.gappssmtp.com header.s=20230601 header.b=\"R/Jad1X1\";\r\n       spf=pass (google.com: domain of reservas@rules-shop.es designates 209.85.220.65 as permitted sender) smtp.mailfrom=reservas@rules-shop.es;\r\n       dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=rules-shop.es;\r\n       dara=neutral header.i=@sierranevadagranada.com",
            "dkim-signature": "DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n        d=rules-shop-es.20230601.gappssmtp.com; s=20230601; t=1769600765; x=1770205565; darn=sierranevadagranada.com;\r\n        h=content-transfer-encoding:subject:from:mime-version:date:message-id\r\n         :from:to:cc:subject:date:message-id:reply-to;\r\n        bh=ppyvuahg7zh35LWzZpCX0tvA8BMr45jRklK69UhsUQ4=;\r\n        b=R/Jad1X1Wmo7XffeFaAPHa0mioPevcqGNAAoZHOyAFnWRyhtY5sNiDXBUwNP+KgSlw\r\n         XHMyL16Y/DLkwRtA3IfpYByf0h4SuZRph3xs8P6vHyqPocztlv04Hxmad8F5LyJKVeD/\r\n         62YOcF59mlIZ4jGv0QWVpxh1/bNxb/QYpXjONHeiyYzameSX/Ry5fuX2A5qFW2++bdCv\r\n         bqS6aRYODaAkM2VIYHP+Qge6tqv7styanSVa8V0Szb3EUCrQLLNKje7odChNAZsHFFHY\r\n         Wle7Y+0NkDa5ggezy0izwZMZIa5UzYQ94brkq5QLKYYWtvafQp/sJc4pug9qzEJUJuFE\r\n         sBBg==",
            "x-google-dkim-signature": "X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n        d=1e100.net; s=20230601; t=1769600765; x=1770205565;\r\n        h=content-transfer-encoding:subject:from:mime-version:date:message-id\r\n         :x-gm-gg:x-gm-message-state:from:to:cc:subject:date:message-id\r\n         :reply-to;\r\n        bh=ppyvuahg7zh35LWzZpCX0tvA8BMr45jRklK69UhsUQ4=;\r\n        b=NzhXSCw8ybu9YbumwdXc2K73IfgIlGc/zYbHBbKPrAL/g39TpzvkUChhPwBigReoOb\r\n         +lf5hSNMPlbAtvFHAz/8a3RI7YjeUnkHlLwv2sI0vR5bMaeSePYi6P0lSDi5JKt/e7OO\r\n         YKqJB9q1m2F7RtuKTHMwtbUqc+Bn5UDg3rIQqc5B25eWVk7H97TGG7Uop9jo5XDc26R1\r\n         YSN9JbHyq6afzTSg6teawe4F5dGjnzs4baDsWoD3wO7Y5WWrKxzsYlhNS1fMvH2GffL3\r\n         BiS36gChEAJVVp3eYLHB6K8NgBD6HeCF8oedvSO0o5RAUMsdS4SCw7QGlmFxpQZvZgw8\r\n         emGA==",
            "x-gm-message-state": "X-Gm-Message-State: AOJu0YymHnoJbtWgPyqecUlX2M67wsLDyKSleMLmm0zejHwzyCbHq+VY\r\n\tIDF0pwxse5lOuSpw8Z+82u2R/tkH3fkVzA2o2PGkeMsvdgSb5C7EWpXK5fBLwSgT/xprsyA5u6a\r\n\tQOkK7/WhPyg==",
            "x-gm-gg": "X-Gm-Gg: AZuq6aKnQGsClzc25qaLK0sO0100N2rAPbBYZXkKCvgRVYj8SIsrxxolrjPMt1gr022\r\n\tqFrfJ9y6jymVHkAyxVQSjv9BGG/kNDP3VISKPZ+uLxLPMpXfhfIywj6XGd7bvGaHDVFtbNv54HF\r\n\tBGFAxH0bt12ps8XMkWQ1In6HautnyJ+x0vYCEJhz8MezbsxpzJsebZ9XUmsxMgKbbuY1dFRvuOu\r\n\tzNWqSnfgOa3gSpFe2ADK++xZQ0daH+jPnJOwK4qmxrexJrg6m/UqZDf0KA3BmHwpVN4GQwbGe1j\r\n\t2jYNjF27XwE3zVbc6vY9cMgCBZ+8YSuI11DAr8iyPTJ7TW8ToNnQmW8tPTLxytHO0C4DV53kO7F\r\n\tiJF26zrsET8peT6tmpNJVFQDN9YHH0FBrUSUomaINHZ/3GB4QEhgECkb9ttJxNfjoJLX9vkGWCx\r\n\t+Gyk4olrNmlwSKEsPpUODvMekZNBx6bdlsGdOUNeZL30fUhyoGRw==",
            "message-id": "Message-ID: <6979f6fa.050a0220.3ba71f.af7c@mx.google.com>",
            "date": "Date: Wed, 28 Jan 2026 03:46:02 -0800 (PST)",
            "x-google-original-date": "X-Google-Original-Date: 28 Jan 2026 12:46:02 +0100",
            "mime-version": "MIME-Version: 1.0",
            "from": "From: \"reservas@rules-shop.es\" <reservas@rules-shop.es>",
            "subject": "Subject: Rules - Compra efectuada -  - canal Cajas",
            "content-type": "Content-Type: text/html; charset=utf-8",
            "content-transfer-encoding": "Content-Transfer-Encoding: base64"
          },
          "html": "<html><body style=\"font: normal 11pt Calibri, sans-serif, Arial, Verdana, 'Trebuchet MS';color: #333;background-color: #fff;margin: 20px;\"\"><style>p { display: block; margin-before: 1em; margin-after: 1em; margin-start: 0px; margin-end: 0px;}</style><!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Email - Rules Shop</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: 'Trebuchet MS', 'Lucida Grande', 'Verdana', sans-serif; background-color: #f9f9f9; color: #111;\">\n    <!-- Cabecera -->\n    <table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background-color: #111; padding: 20px 0; font-family: 'Trebuchet MS', 'Lucida Grande', 'Verdana', sans-serif;\">\n        <tr>\n            <td align=\"center\">\n                <img src=\"https://rules-shop.es/File/logoRules.png?id=3888145A-1121-483D-9E19-4F94927C2496\" alt=\"Rules Shop\" style=\"max-height: 60px;\">\n            </td>\n        </tr>\n    </table>\n\n    <!-- Contenido -->\n    <table width=\"100%\" cellspacing=\"0\" cellpadding=\"20\" style=\"background-color: #f9f9f9; font-family: 'Trebuchet MS', 'Lucida Grande', 'Verdana', sans-serif;\">\n        <tr>\n            <td align=\"center\">\n                <div style=\"max-width: 600px; width: 100%; margin: 0 auto; background-color: #fff; padding: 20px; color: #111; text-align: left; font-size: 16px; line-height: 1.6; border-radius: 5px;\">\n                    <style type=\"text/css\">\n\n/*printing and email cols*/\n.pr-container {\n    padding-left: 15px;\n    padding-right: 15px;  \n}\n.pr-row {\n    margin-left: -15px;\n    margin-right: -15px;\n}  \n.pr-row::after {\n  content: \"\";\n  clear: both;\n  display: block;\n}\n[class*=\"pr-col-\"] {\n  float: left;\n  padding-left: 15px;\n  padding-right: 15px;\n  box-sizing: border-box;\n}\n/* For mobile phones: */\n[class*=\"pr-col-\"] {\n   width: 100%;\n}\n  \n@media print, (min-width: 768px) {\n    /* For desktop: */\n    .pr-col-1 {width: 8.33%;}\n    .pr-col-2 {width: 16.66%;}\n    .pr-col-3 {width: 25%;}\n    .pr-col-4 {width: 33.33%;}\n    .pr-col-5 {width: 41.66%;}\n    .pr-col-6 {width: 50%;}\n    .pr-col-7 {width: 58.33%;}\n    .pr-col-8 {width: 66.66%;}\n    .pr-col-9 {width: 75%;}\n    .pr-col-10 {width: 83.33%;}\n    .pr-col-11 {width: 91.66%;}\n    .pr-col-12 {width: 100%;}\n}\n/*end printing and email cols*/\n\n  .cart-extract-d-none {\n     display: none;\n  }\n  @media print, (min-width: 768px) {\n   .cart-extract-d-none {\n     display: block;\n     width: 100%;\n   } \n   body {\n     /*font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\", \"Noto Color Emoji\";\n     font-size: 16px;\n     font-weight: 400;*/\n  }\n}\n  \nh1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {\n    margin-top: 0;\n    margin-bottom: 0.5rem;\n    font-weight: 500;\n    line-height: 1.2;\n}\nh1 {\n    font-size: 2rem;\n    margin-bottom: 1rem;\n}\nh5 {\n  font-size: 1.25rem;\n}\n  \n.cart-extract-section {\n  margin-bottom: 1em;\n  border: solid 1px #dbdbdb;\n}\n.cart-extract-section-head {\n  background-color: #e9ebed;\n  overflow: hidden;\n  padding: 0.25em 0.5em;\n  font-weight: bold;\n}\n.cart-extract-section-body {\n  padding: 0.5em;\n}\n  \n.cart-extract-payment {\n  border: 1px solid #dbdbdb;\n  padding: 10px;\n  background-color: #e9ebed;\n  margin-bottom: 1em;\n}\n  .cart-extract-warning {\n  \tcolor: #856404;\n    margin-bottom: 1em;\n    padding: 10px;\n    background-color: #fff3cd;\n    border: 1px solid #ffeeba;\n  }\n  \n.cart-line {\n    margin-bottom: 1em;\n    border: solid 1px #dbdbdb;\n}\n.cart-line-header {\n    background-color: #e9ebed;\n    overflow: hidden;\n    line-height: 33px;\n}\n.cart-line-header h4 {\n    padding-bottom: 0;\n    margin: 10px 0;\n    font-weight: bold;\n    font-size: 17px;\n    line-height: 20px;\n}\n.cart-line-actions {\n    padding: 0 10px;\n}\n.cart-line-actions > div {\n    margin: 0 10px;\n    float: left;\n}\n.cart-line-price-panel {\n    float: right !important;\n    padding: 4px 0;\n    font-size: 18px;\n    font-weight: bold;\n    color: #2c3e50;\n}\n.cart-line-quantity-panel input {\n    height: 30px;\n    width: 30px;\n    margin: 4px 0;\n    text-align: center;\n    display: inline;\n}\n  .cart-line-product-img img {\n    width: 100%;\n  }\n  @media print {\n     .cart-line-header h4 {\n        font-size: 14px;\n       \tvertical-align: middle;\n    }\n  }\n.cart-line-product-img {\n    padding: 0;\n}\n.cart-line-details-panel {\n    padding-top: 0.5em;\n    padding-bottom: 0.5em;\n}\n  .cart-extract-totals {\n     width: 6em;\n     display: inline-block;\n  }\n  .cart-line-old-price {\n    font-weight: normal;\n    text-decoration: line-through;\n}\n</style>\n       \n<p>Hola ,</p>\n<p>Tu compra ha sido efectuada.</p>\n<h5>Detalles de la compra:</h5>\n\n<table cellspacing=\"0\" width=\"100%\" cellpadding=\"5\">\n\t<tr>\n\t\t<td width=\"25%\" style=\"vertical-align:top;border:0\">    \n\t\t\t<table cellspacing=\"5\" class=\"cart-extract-section\" style=\"border:solid 1px #dbdbdb\">\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"cart-extract-section-head\" style=\"border:0;background-color:#e9ebed;\">\n\t\t\t\t\t\tDetalles del Pedido\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"cart-extract-section-body\" style=\"border:0\">\n\t\t\t\t\t\tIdentificador:<br /><b>PVRCA00013779</b><br />\n                        <!---->\n\t\t\t\t\t\tCanal:<br /><b>Cajas</b><br />\n                        <!---->\n\t\t\t\t\t\tFecha de efecto:<br /><b>28/1/2026 12:44</b><br />\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t</table>\n\t\t</td>\n\t\t<td width=\"25%\" style=\"vertical-align:top;border:0\">    \n\t\t\t\n\t\t\t\t<div class=\"cart-extract-d-none\">&nbsp;</div>\n\t\t\t\n\t\t</td>\n\t\t<td width=\"25%\" style=\"vertical-align:top;border:0\">    \n\t\t\t\n\t\t\t\t\n\t\t\t\t\t<div class=\"cart-extract-d-none\">&nbsp;</div>\n\t\t\t\t\n\t\t\t\n\t\t</td>\n\t\t<td width=\"25%\" style=\"vertical-align:top;border:0\">    \n\t\t\t<table cellspacing=\"5\" class=\"cart-extract-section\" style=\"border:solid 1px #dbdbdb\">\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"cart-extract-section-head\" style=\"border:0;background-color:#e9ebed;\">\n\t\t\t\t\t\tEntidad emisora\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"cart-extract-section-body\" style=\"border:0\">\n\t\t\t\t\t\tSNOWDIVISION S.L<br />\n\t\t\t\t\t\tCif: B19696988<br />\n\t\t\t\t\t\tPlaza Pradollano 7  <br />\n\t\t\t\t\t\t18196 - Sierra Nevada<br />\n\t\t\t\t\t\t(GRANADA)<br />\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t</table>\n\t\t</td>\n\t</tr>\n</table>\n\n\n<h5>Pagos asociados al pedido:</h5>\n<table cellspacing=\"0\" width=\"100%\" cellpadding=\"5\">\n\t<tr>\n\t\t<td style=\"background-color:#e9ebed;width:20%\">Importe</td>\n\t\t<td style=\"background-color:#e9ebed;width:20%\">Fecha l&iacute;mite</td>\n\t\t<td style=\"background-color:#e9ebed;width:20%\">Método de pago</td>\n\t\t<td style=\"background-color:#e9ebed;width:20%\">Estado</td>\n\t\t<td style=\"background-color:#e9ebed;width:20%\">Acción requerida</td>\n\t</tr>\n\t\t<tr>\n\t\t  <td style=\"background-color:#fff\"><b>2,00&euro;</b></td>\n\t\t  <td style=\"background-color:#fff\"><b>28/01/2026</b></td>\n\t\t  <td style=\"background-color:#fff\"><b>Card checkout</b></td>\n\t\t  <td style=\"background-color:#fff\"><b>Efectuado</b></td>\n\t\t  <td style=\"background-color:#fff\"><b>Ninguna</b></td>\n\t\t</tr>\n\t    \n</table>\n\n\n<br />    \n<h5>Detalles del pedido:</h5>\n<div class=\"cart-orderlines-table cart-orderlines-table-readonly document-web-extract\">\n  <div class=\"cart-content\">\n\t    \t\n    \t\n\t\t\n\t\t\t<table width=\"100%\" cellSpacing=\"0\" style=\"margin-bottom:10px;border:solid 1px #dbdbdb\">\n\t\t\t\t<tr class=\"cart-line-header\">\n\t\t\t\t  <td width=\"66%\" style=\"border:0;padding-left:5px;background-color:#e9ebed;margin:8px;\">\n\t\t\t\t\t<h4 style=\"font-size:14px\">Monster</h4>\n\t\t\t\t  </td>\n\t\t\t\t  <td width=\"17%\" style=\"border:0;font-size:14px;text-align:center;background-color:#e9ebed;margin:8px;\" class=\"cart-line-actions\">\n\t\t\t\t\t  <span style=\"width: 3em;text-align:center;color:#000;padding:0;border:0;\">1</span>\n\t\t\t\t  </td>\n\t\t\t\t  <td width=\"17%\" style=\"border:0;font-size:14px;text-align:right;font-weight:bold;background-color:#e9ebed;margin:8px;\" class=\"cart-line-actions\">\n\t\t\t\t\t\t\t\t  \n\t\t\t\t\t\t\t<!---->\n\t\t\t\t\t\t1,65&euro;\n\t\t\t\t\t\n\t\t\t\t  </td>\n\t\t\t\t</tr>\n\t\t\t\t<tr class=\"cart-line-data\">\n\t\t\t\t\t<td width=\"100%\" colspan=\"3\">\n\t\t\t\t\t\t<table width=\"100%\" border=\"0\" cellSpacing=\"0\">\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td width=\"25%\" style=\"border:0;vertical-align:top\" class=\"cart-line-product-img\">\n\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t<!---->\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t<td width=\"75%\" style=\"border:0;vertical-align:top;padding:10px;font-size:0.9em;\" class=\"cart-line-details-panel\">\n\t\t\t\t\tLocalizador: <b>1e24b828</b><br />\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t<!---->                                  \n\t\t\t\t\t \n\t\t\t\t\t\n\t\t\t\t\t<!---->\n\t\t\t\t\t<!----> \n\t\t\t\t\t\n\t\t\t\t\t\t<!----> \n\t\t\t\t\t\t<!----> \n                    <!---->\n\t\t\t\t\t<!---->\n\t\t\t\t\t\n\t\t\t\t\t<!---->\n\t\t\t\t\t    \n                    <!---->\n\t\t\t\t  </td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t</table>\n\t\t \n\t\n  </div>\n</div>\n\n<div style=\"text-align:right;margin-right:5px\">\n</div>\n<div style=\"text-align:right;margin-right:5px;margin-top:3px\"><b>TOTAL: <span class=\"cart-extract-totals\">2,00</span></b></div>\n\n\n   <div style=\"text-align:right\"><p>Precios con IVA incluido.</p></div>\n\n\n\n<p>Puedes imprimir el justificante de compra haciendo click en este <a href=\"https://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6\">enlace</a>.</p>\n\n<p>Si no puedes usar el enlace puedes pegar la siguiente dirección en tu navegador:<br />\nhttps://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6</p>\n\n<p><b>INFORMACIÓN DE INTERÉS</b></p>\n<p><b>Lea atentamente las condiciones generales de reserva adjuntas</b></p>\n\n<p><span style=\"color:red; text-decoration:underline;\">Recuerde llegar con al menos 2 horas de antelación, de la hora de su clase, a recoger el material para equiparse, evitar colas y llegar a tiempo, para que tenga una experiencia inmejorable.</p>\n\n<!---->\n\n<br/>\n<p style=\"text-decoration:underline\"><b>INFORMACIÓN EXCLUSIVA PARA CLIENTES CON CLASES CONTRATADAS</b></p>\n<p>El punto de encuentro para las CLASES se encuentra en nuestra oficina ubicada en Borreguiles en la salida del telecabina Al-Andalus a la derecha. SURFIN SIERRA NEVADA.</p>\n<p>Ante cualquier problema con la hora de llegada o localización del punto de encuentro de pistas (Borreguiles) llame con tiempo al <b>638 877 288</b> (teléfono de la Escuela).</p>\n\n<p style=\"text-decoration:underline\"><b>MUY IMPORTANTE – PARA CLIENTES CON RESERVAS DE CURSILLOS COLECTIVOS </b></p>\n<p>El curso se realizará en grupos de 4 a 10 personas según el nivel.</p>\n<p>Si no se llega a completar un mínimo de 4 personas, el curso se verá reducido de 2 horas a 1 hora y de 4 horas a 2 horas, respectivamente. En caso de no llegar a un mínimo de 2 personas, el curso podría verse anulado o modificado, dando la empresa otras opciones.</p>\n<p>Las clases comenzarán a la hora establecida en el bono de confirmación de reserva, independientemente del número de alumnos presentes. Si llegase tarde al punto de encuentro en Borreguiles por causas ajenas a nuestra empresa, <b>el tiempo no será recuperable y si este tiempo excede de 20 minutos de la hora de inicio, no será posible incorporarse al cursillo por motivos del progreso de aprendizaje</b>.</p>\n<p><b>FORFAIT</b> para acceder a pistas imprescindible <b>no incluido en los cursillos</b>.</p>\n\n<p style=\"text-decoration:underline\"><b>MUY IMPORTANTE – PARA CLIENTES CON RESERVAS DE CLASES PARTICULARES </b></p>\n<p>Las clases comenzarán a la hora establecida en el bono de confirmación de reserva, independientemente del número de alumnos presentes. Si llegase tarde al punto de encuentro en Borreguiles por causas ajenas a nuestra empresa, <b>el tiempo no será recuperable y si este tiempo excede de 20 minutos de la hora de inicio, se pierde el derecho a dar la clase</b>.</p>\n<p><b>FORFAIT</b> para acceder a pistas imprescindible <b>no incluido en los cursillos</b>.</p>\n<br/>\n<p><b>Por favor, si hay algún error póngase en contacto nuevamente para solucionarlo. No nos hacemos responsables de errores no notificados.</b></p>\n                </div>\n            </td>\n        </tr>\n    </table>\n\n    <!-- Pie -->\n    <table width=\"100%\" cellspacing=\"0\" cellpadding=\"20\" style=\"background-color: #111; font-family: 'Trebuchet MS', 'Lucida Grande', 'Verdana', sans-serif;\">\n        <tr>\n            <td align=\"center\" style=\"font-size: 14px;\">\n                <div style=\"max-width: 600px; width: 100%; margin: 0 auto; text-align: center;\">\n                    <p style=\"margin: 0; color: #fff;\">Plaza Andalucia, Edificio Monachil Local 1 y 2<br>Monachil, España</p>\n                    <p style=\"margin: 10px 0;\">\n                        <a href=\"#\" style=\"color: #1bb5dc; text-decoration: none; margin: 0 10px;\">Aviso legal</a>\n                        <span style=\"color: #666; margin: 0 10px;\">|</span>\n                        <a href=\"#\" style=\"color: #1bb5dc; text-decoration: none; margin: 0 10px;\">Política de privacidad</a>\n                        <span style=\"color: #666; margin: 0 10px;\">|</span>\n                        <a href=\"#\" style=\"color: #1bb5dc; text-decoration: none; margin: 0 10px;\">Condiciones de compra</a>\n                    </p>\n                </div>\n            </td>\n        </tr>\n    </table>\n</body>\n</html>\n<br/><span style='color:white'>(Mensaje:202288cd-5ab5-46aa-8ef1-d25105cd3ab4)</span><br/></body></html>",
          "text": "Email - Rules Shop\n\nRules Shop\n[https://rules-shop.es/File/logoRules.png?id=3888145A-1121-483D-9E19-4F94927C2496]\n\nHola ,\n\nTu compra ha sido efectuada.\n\nDETALLES DE LA COMPRA:\n\nDetalles del Pedido Identificador:\nPVRCA00013779\nCanal:\nCajas\nFecha de efecto:\n28/1/2026 12:44\n\n\n \n \n\nEntidad emisora SNOWDIVISION S.L\nCif: B19696988\nPlaza Pradollano 7\n18196 - Sierra Nevada\n(GRANADA)\n\n\nPAGOS ASOCIADOS AL PEDIDO:\n\nImporte Fecha límite Método de pago Estado Acción requerida 2,00€ 28/01/2026\nCard checkout Efectuado Ninguna\n\n\nDETALLES DEL PEDIDO:\n\nMONSTER\n\n1 1,65€\n\nLocalizador: 1e24b828\n\n\n\nTOTAL: 2,00\n\nPrecios con IVA incluido.\n\nPuedes imprimir el justificante de compra haciendo click en este enlace\n[https://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6].\n\nSi no puedes usar el enlace puedes pegar la siguiente dirección en tu navegador:\nhttps://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6\n\nINFORMACIÓN DE INTERÉS\n\nLea atentamente las condiciones generales de reserva adjuntas\n\nRecuerde llegar con al menos 2 horas de antelación, de la hora de su clase, a\nrecoger el material para equiparse, evitar colas y llegar a tiempo, para que\ntenga una experiencia inmejorable.\n\n\nINFORMACIÓN EXCLUSIVA PARA CLIENTES CON CLASES CONTRATADAS\n\nEl punto de encuentro para las CLASES se encuentra en nuestra oficina ubicada en\nBorreguiles en la salida del telecabina Al-Andalus a la derecha. SURFIN SIERRA\nNEVADA.\n\nAnte cualquier problema con la hora de llegada o localización del punto de\nencuentro de pistas (Borreguiles) llame con tiempo al 638 877 288 (teléfono de\nla Escuela).\n\nMUY IMPORTANTE – PARA CLIENTES CON RESERVAS DE CURSILLOS COLECTIVOS\n\nEl curso se realizará en grupos de 4 a 10 personas según el nivel.\n\nSi no se llega a completar un mínimo de 4 personas, el curso se verá reducido de\n2 horas a 1 hora y de 4 horas a 2 horas, respectivamente. En caso de no llegar a\nun mínimo de 2 personas, el curso podría verse anulado o modificado, dando la\nempresa otras opciones.\n\nLas clases comenzarán a la hora establecida en el bono de confirmación de\nreserva, independientemente del número de alumnos presentes. Si llegase tarde al\npunto de encuentro en Borreguiles por causas ajenas a nuestra empresa, el tiempo\nno será recuperable y si este tiempo excede de 20 minutos de la hora de inicio,\nno será posible incorporarse al cursillo por motivos del progreso de\naprendizaje.\n\nFORFAIT para acceder a pistas imprescindible no incluido en los cursillos.\n\nMUY IMPORTANTE – PARA CLIENTES CON RESERVAS DE CLASES PARTICULARES\n\nLas clases comenzarán a la hora establecida en el bono de confirmación de\nreserva, independientemente del número de alumnos presentes. Si llegase tarde al\npunto de encuentro en Borreguiles por causas ajenas a nuestra empresa, el tiempo\nno será recuperable y si este tiempo excede de 20 minutos de la hora de inicio,\nse pierde el derecho a dar la clase.\n\nFORFAIT para acceder a pistas imprescindible no incluido en los cursillos.\n\n\nPor favor, si hay algún error póngase en contacto nuevamente para solucionarlo.\nNo nos hacemos responsables de errores no notificados.\n\nPlaza Andalucia, Edificio Monachil Local 1 y 2\nMonachil, España\n\nAviso legal | Política de privacidad | Condiciones de compra\n\n\n(Mensaje:202288cd-5ab5-46aa-8ef1-d25105cd3ab4)\n",
          "textAsHtml": "<p>Email - Rules Shop</p><p>Rules Shop<br/>[<a href=\"https://rules-shop.es/File/logoRules.png?id=3888145A-1121-483D-9E19-4F94927C2496\">https://rules-shop.es/File/logoRules.png?id=3888145A-1121-483D-9E19-4F94927C2496</a>]</p><p>Hola ,</p><p>Tu compra ha sido efectuada.</p><p>DETALLES DE LA COMPRA:</p><p>Detalles del Pedido Identificador:<br/>PVRCA00013779<br/>Canal:<br/>Cajas<br/>Fecha de efecto:<br/>28/1/2026 12:44</p><p>&nbsp;<br/>&nbsp;</p><p>Entidad emisora SNOWDIVISION S.L<br/>Cif: B19696988<br/>Plaza Pradollano 7<br/>18196 - Sierra Nevada<br/>(GRANADA)</p><p>PAGOS ASOCIADOS AL PEDIDO:</p><p>Importe Fecha l&iacute;mite M&eacute;todo de pago Estado Acci&oacute;n requerida 2,00&euro; 28/01/2026<br/>Card checkout Efectuado Ninguna</p><p>DETALLES DEL PEDIDO:</p><p>MONSTER</p><p>1 1,65&euro;</p><p>Localizador: 1e24b828</p><p>TOTAL: 2,00</p><p>Precios con IVA incluido.</p><p>Puedes imprimir el justificante de compra haciendo click en este enlace<br/>[<a href=\"https://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6\">https://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6</a>].</p><p>Si no puedes usar el enlace puedes pegar la siguiente direcci&oacute;n en tu navegador:<br/><a href=\"https://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6\">https://rules-shop.es/documentWebExtract?orderGuid=4e0f8e35-735c-4884-b9f8-a24a72fef2b6</a></p><p>INFORMACI&Oacute;N DE INTER&Eacute;S</p><p>Lea atentamente las condiciones generales de reserva adjuntas</p><p>Recuerde llegar con al menos 2 horas de antelaci&oacute;n, de la hora de su clase, a<br/>recoger el material para equiparse, evitar colas y llegar a tiempo, para que<br/>tenga una experiencia inmejorable.</p><p>INFORMACI&Oacute;N EXCLUSIVA PARA CLIENTES CON CLASES CONTRATADAS</p><p>El punto de encuentro para las CLASES se encuentra en nuestra oficina ubicada en<br/>Borreguiles en la salida del telecabina Al-Andalus a la derecha. SURFIN SIERRA<br/>NEVADA.</p><p>Ante cualquier problema con la hora de llegada o localizaci&oacute;n del punto de<br/>encuentro de pistas (Borreguiles) llame con tiempo al 638 877 288 (tel&eacute;fono de<br/>la Escuela).</p><p>MUY IMPORTANTE &ndash; PARA CLIENTES CON RESERVAS DE CURSILLOS COLECTIVOS</p><p>El curso se realizar&aacute; en grupos de 4 a 10 personas seg&uacute;n el nivel.</p><p>Si no se llega a completar un m&iacute;nimo de 4 personas, el curso se ver&aacute; reducido de<br/>2 horas a 1 hora y de 4 horas a 2 horas, respectivamente. En caso de no llegar a<br/>un m&iacute;nimo de 2 personas, el curso podr&iacute;a verse anulado o modificado, dando la<br/>empresa otras opciones.</p><p>Las clases comenzar&aacute;n a la hora establecida en el bono de confirmaci&oacute;n de<br/>reserva, independientemente del n&uacute;mero de alumnos presentes. Si llegase tarde al<br/>punto de encuentro en Borreguiles por causas ajenas a nuestra empresa, el tiempo<br/>no ser&aacute; recuperable y si este tiempo excede de 20 minutos de la hora de inicio,<br/>no ser&aacute; posible incorporarse al cursillo por motivos del progreso de<br/>aprendizaje.</p><p>FORFAIT para acceder a pistas imprescindible no incluido en los cursillos.</p><p>MUY IMPORTANTE &ndash; PARA CLIENTES CON RESERVAS DE CLASES PARTICULARES</p><p>Las clases comenzar&aacute;n a la hora establecida en el bono de confirmaci&oacute;n de<br/>reserva, independientemente del n&uacute;mero de alumnos presentes. Si llegase tarde al<br/>punto de encuentro en Borreguiles por causas ajenas a nuestra empresa, el tiempo<br/>no ser&aacute; recuperable y si este tiempo excede de 20 minutos de la hora de inicio,<br/>se pierde el derecho a dar la clase.</p><p>FORFAIT para acceder a pistas imprescindible no incluido en los cursillos.</p><p>Por favor, si hay alg&uacute;n error p&oacute;ngase en contacto nuevamente para solucionarlo.<br/>No nos hacemos responsables de errores no notificados.</p><p>Plaza Andalucia, Edificio Monachil Local 1 y 2<br/>Monachil, Espa&ntilde;a</p><p>Aviso legal | Pol&iacute;tica de privacidad | Condiciones de compra</p><p>(Mensaje:202288cd-5ab5-46aa-8ef1-d25105cd3ab4)</p>",
          "subject": "Rules - Compra efectuada -  - canal Cajas",
          "date": "2026-01-28T11:46:02.000Z",
          "from": {
            "value": [
              {
                "address": "reservas@rules-shop.es",
                "name": ""
              }
            ],
            "html": "<span class=\"mp_address_group\"><a href=\"mailto:reservas@rules-shop.es\" class=\"mp_address_email\">reservas@rules-shop.es</a></span>",
            "text": "reservas@rules-shop.es"
          },
          "messageId": "<6979f6fa.050a0220.3ba71f.af7c@mx.google.com>"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-01-15T07:50:18.781Z",
      "createdAt": "2026-01-15T07:50:18.781Z",
      "role": "workflow:owner",
      "workflowId": "sQUNg-VuSIFLaMIdA9znD",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 3,
  "updatedAt": "2026-01-28T13:24:00.872Z",
  "versionId": "aece013d-6ff6-4a9f-814f-e7bb6bf3944a"
}