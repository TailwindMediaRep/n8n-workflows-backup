{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-02-05T13:50:33.000Z",
    "createdAt": "2026-02-05T13:45:01.384Z",
    "versionId": "3ebaa34a-24d2-4620-8f8f-f0696b8d95ed",
    "workflowId": "9pcwl5XAK1pZ6dfl",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "informeDiarioPrueba",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -1088,
          32
        ],
        "id": "cfd98e02-755b-443c-9698-ff7a15589388",
        "name": "Webhook",
        "webhookId": "7c1e3b37-6cc8-4f4a-81e3-c5897bdf497c"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "cc0f02f8-8565-4ea6-a6dd-7084a488a75a",
                "leftValue": "={{ $('Webhook').item.json.body[0].headers[\"x-shopify-topic\"] }}",
                "rightValue": "refunds/create",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              },
              {
                "id": "a851fb06-e4c3-42fa-95ec-ecb05cf72335",
                "leftValue": "={{ $('Webhook').item.json.headers[\"x-shopify-topic\"] }}",
                "rightValue": "refunds/create",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -752,
          32
        ],
        "id": "7dda907f-0194-4a60-9830-ed092e805176",
        "name": "If"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
          "query": "query getOrder($id: ID!) {\n  order(id: $id) {\n    id\n    name\n    createdAt\n    email\n    totalPriceSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    lineItems(first: 10) {\n      edges {\n        node {\n          title\n          quantity\n          # NUEVO: Si esto es menor que 'quantity', significa que se ha devuelto\n          refundableQuantity \n          originalUnitPriceSet {\n            shopMoney {\n              amount\n              currencyCode\n            }\n          }\n        }\n      }\n    }\n    # NUEVO: Sección completa con el historial de devoluciones\n    refunds(first: 5) {\n      id\n      createdAt\n      note\n      totalRefundedSet {\n        shopMoney {\n          amount\n          currencyCode\n        }\n      }\n      refundLineItems(first: 10) {\n        edges {\n          node {\n            quantity\n            lineItem {\n              title\n            }\n          }\n        }\n      }\n    }\n    fulfillments {\n      id\n      location {\n        name\n        address {\n          address1\n          city\n          province\n          country\n          zip\n        }\n      }\n    }\n    transactions(first: 5) {\n      formattedGateway\n      kind\n      status\n    }\n    customer {\n      firstName\n      lastName\n      email\n    }\n  }\n}",
          "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $('Webhook').item.json.body.order_id }}\"\n}",
          "headerParametersUi": {
            "parameter": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          -496,
          -64
        ],
        "id": "0feeb4e4-6205-4f45-b33e-30697ae63f7c",
        "name": "obtener pedido",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "EE1JFqauvkjeKX5N",
            "mode": "list",
            "cachedResultName": "PRUEBA_INFORME_DIARIO",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/EE1JFqauvkjeKX5N"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          -912,
          32
        ],
        "id": "6474297f-c463-4e5d-983b-d8b896c15de6",
        "name": "obtener contador"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "EE1JFqauvkjeKX5N",
            "mode": "list",
            "cachedResultName": "PRUEBA_INFORME_DIARIO",
            "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/EE1JFqauvkjeKX5N"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "1"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "contador": "={{ $json.row_number + 1}}",
              "id_documento": "={{ $('obtener contador').first().json.id_documento }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "id_documento",
                "displayName": "id_documento",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "contador",
                "displayName": "contador",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          464,
          16
        ],
        "id": "bed162b7-65a5-4818-9e13-bb7e229b46c4",
        "name": "sumar contador"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "={{ $json.id_documento }}",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Hoja 1",
            "mode": "name"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "ID PEDIDO",
                "lookupValue": "={{ $json.id_pedido }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -400,
          96
        ],
        "id": "88244861-8da4-4978-958f-6f7d064ab40f",
        "name": "obtener producto en otro informe",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "=1NnQWrr02pcOLmsh_nNSDMVTFq8OJ6gq58X5tM3RhoJM",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "Hoja 1",
            "mode": "name"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "row_number": "={{ $json.Numero_linea }}",
              "PRECIO PAGADO": "={{ $json.Precio }}",
              "NOMBRE DE PRODUCTO": "={{ $json.Texto }}",
              "ID PEDIDO": "={{ $('Webhook').first().json.body.order_id }}",
              "SUCURSAL DE VENTA": "={{ $('obtener pedido').first().json.data.order.fulfillments[0].location.name }}",
              "MÉTODO DE PAGO": "={{ $('obtener pedido').first().json.data.order.transactions[0].formattedGateway }}",
              "VARIANTE": "DEVOLUCIÓN"
            },
            "matchingColumns": [
              "row_number"
            ],
            "schema": [
              {
                "id": "ID PEDIDO",
                "displayName": "ID PEDIDO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "SUCURSAL DE VENTA",
                "displayName": "SUCURSAL DE VENTA",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "MÉTODO DE PAGO",
                "displayName": "MÉTODO DE PAGO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "COSTE POR UNIDAD",
                "displayName": "COSTE POR UNIDAD",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO DE PRODUCTO",
                "displayName": "PRECIO DE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "PRECIO PAGADO",
                "displayName": "PRECIO PAGADO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "DESCUENTO",
                "displayName": "DESCUENTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "NOMBRE DE PRODUCTO",
                "displayName": "NOMBRE DE PRODUCTO",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "VARIANTE",
                "displayName": "VARIANTE",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          272,
          16
        ],
        "id": "d702682b-8b7b-40de-8736-6775774287f9",
        "name": "escribir en informe de hoy",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "RCuKUCifcA4jENcY",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          -256,
          16
        ],
        "id": "83856bf3-b702-4a6f-b0bd-70d04e885263",
        "name": "Merge1"
      },
      {
        "parameters": {
          "jsCode": "// --- 1. PREPARACIÓN DE DATOS ---\nconst shopifyItem = items.find(i => i.json.data && i.json.data.order);\nconst dbItems = items.filter(i => i.json['ID PEDIDO']);\n\nif (!shopifyItem) return [];\n\nconst order = shopifyItem.json.data.order;\nconst orderIdSimple = order.id.replace(\"gid://shopify/Order/\", \"\");\nconst movements = [];\n\n// MAPA DEL HISTÓRICO (Lo que el cliente tenía antes de hoy)\n// Usamos un mapa para controlar las cantidades: { \"Gafas\": 1, \"Camiseta\": 2 }\nconst inventoryChecklist = {};\n\ndbItems.forEach(item => {\n    const name = item.json['NOMBRE DE PRODUCTO'];\n    const price = parseFloat(item.json['PRECIO PAGADO'] || 0);\n    \n    if (inventoryChecklist[name]) {\n        inventoryChecklist[name].qty += 1;\n    } else {\n        inventoryChecklist[name] = { qty: 1, price: price };\n    }\n});\n\n// --- 2. PROCESAR \"DEVUELTO\" ---\n// Primero miramos exclusivamente el Refund de hoy\nif (order.refunds && order.refunds.length > 0) {\n    const currentRefund = order.refunds[0]; \n\n    for (const edge of currentRefund.refundLineItems.edges) {\n        const refundItem = edge.node;\n        const name = refundItem.lineItem.title;\n        const qtyReturned = refundItem.quantity;\n        \n        // Buscamos el precio original\n        let price = 0;\n        if (inventoryChecklist[name]) {\n            price = inventoryChecklist[name].price;\n            // IMPORTANTE: \"Gastamos\" el stock histórico. \n            // Si tenía 1 y devuelve 1, ahora en el histórico virtual queda 0.\n            inventoryChecklist[name].qty -= qtyReturned;\n        } else {\n             // Fallback por si no estaba en base de datos\n             const originalLine = order.lineItems.edges.find(e => e.node.title === name);\n             price = originalLine ? parseFloat(originalLine.node.originalUnitPriceSet.shopMoney.amount) : 0;\n        }\n\n        movements.push({\n            \"ID PEDIDO\": orderIdSimple,\n            \"TIPO\": \"DEVUELTO\",\n            \"PRODUCTO\": name,\n            \"CANTIDAD\": -qtyReturned,\n            \"IMPORTE\": (price * qtyReturned) * -1\n        });\n    }\n}\n\n// --- 3. PROCESAR \"SIN CAMBIOS\" Y \"CAMBIO\" ---\n// Ahora recorremos el pedido actual (items vivos)\nfor (const edge of order.lineItems.edges) {\n    const item = edge.node;\n    \n    // Solo miramos items activos (no devueltos completamente en el pasado)\n    if (item.refundableQuantity > 0) {\n        const name = item.title;\n        const currentQty = item.refundableQuantity;\n        const currentPrice = parseFloat(item.originalUnitPriceSet.shopMoney.amount);\n        \n        // Verificamos cuánto queda en el checklist del histórico\n        const oldData = inventoryChecklist[name];\n        const oldQtyAvailable = oldData ? Math.max(0, oldData.qty) : 0;\n\n        // CÁLCULO DE DESGLOSE\n        // 1. ¿Cuántos son SIN CAMBIOS? (El solapamiento entre lo que hay y lo que había)\n        const qtyUnchanged = Math.min(currentQty, oldQtyAvailable);\n        \n        // 2. ¿Cuántos son CAMBIO? (Lo que hay de más respecto a lo viejo)\n        const qtyNew = Math.max(0, currentQty - oldQtyAvailable);\n\n        // -- GENERAR LÍNEA: SIN CAMBIOS --\n        if (qtyUnchanged > 0) {\n            movements.push({\n                \"ID PEDIDO\": orderIdSimple,\n                \"TIPO\": \"SIN CAMBIOS\",\n                \"PRODUCTO\": name,\n                \"CANTIDAD\": qtyUnchanged,\n                \"IMPORTE\": 0 // 0 porque financieramente no afecta al reporte de hoy\n            });\n            // Restamos del checklist para no repetirlo\n            if (inventoryChecklist[name]) inventoryChecklist[name].qty -= qtyUnchanged;\n        }\n\n        // -- GENERAR LÍNEA: CAMBIO --\n        if (qtyNew > 0) {\n            movements.push({\n                \"ID PEDIDO\": orderIdSimple,\n                \"TIPO\": \"CAMBIO\", // Es nuevo o sustitución\n                \"PRODUCTO\": name,\n                \"CANTIDAD\": qtyNew,\n                \"IMPORTE\": currentPrice * qtyNew // Valor positivo\n            });\n        }\n    }\n}\n\nreturn movements;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -96,
          16
        ],
        "id": "9e73f29f-6b1e-4f1e-829a-6cb9a4a98162",
        "name": "juntar información"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "aaebdeef-6cac-4712-a953-8e04b1ff3cbc",
                "name": "Precio",
                "value": "={{ $items().reduce((acumulador, item) => acumulador + (parseFloat(item.json[\"IMPORTE\"]) || 0), 0).toFixed(2) }}",
                "type": "number"
              },
              {
                "id": "82bc8e66-6f80-4613-b1ec-128a8f37050e",
                "name": "Texto",
                "value": "={{ $items().map(item => item.json[\"PRODUCTO\"] + \" (\" + item.json[\"TIPO\"] + \")\").join(\", \") }}",
                "type": "string"
              },
              {
                "id": "ecd82425-252d-456c-878a-87c828085f50",
                "name": "Numero_linea",
                "value": "={{ $('obtener contador').first().json.contador }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          96,
          16
        ],
        "id": "24ddd213-d872-42e1-a420-3be6c3be9c1f",
        "name": "formatear informacion para sheets",
        "executeOnce": true
      },
      {
        "parameters": {
          "operation": "select",
          "schema": {
            "__rl": true,
            "mode": "list",
            "value": "public"
          },
          "table": {
            "__rl": true,
            "value": "Pedidos-Documentos",
            "mode": "list",
            "cachedResultName": "Pedidos-Documentos"
          },
          "where": {
            "values": [
              {
                "column": "id_pedido",
                "value": "={{ $('Webhook').item.json.body.order_id }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -576,
          96
        ],
        "id": "b8220807-8f47-48c2-b93a-ee9bcfb860e5",
        "name": "Select rows from a table",
        "credentials": {
          "postgres": {
            "id": "UPETCYNZNCReuZu8",
            "name": "Postgres Supabase"
          }
        }
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "obtener contador",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "obtener pedido",
              "type": "main",
              "index": 0
            },
            {
              "node": "Select rows from a table",
              "type": "main",
              "index": 0
            }
          ],
          []
        ]
      },
      "obtener pedido": {
        "main": [
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "obtener contador": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "obtener producto en otro informe": {
        "main": [
          [
            {
              "node": "Merge1",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge1": {
        "main": [
          [
            {
              "node": "juntar información",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "juntar información": {
        "main": [
          [
            {
              "node": "formatear informacion para sheets",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "formatear informacion para sheets": {
        "main": [
          [
            {
              "node": "escribir en informe de hoy",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "escribir en informe de hoy": {
        "main": [
          [
            {
              "node": "sumar contador",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Select rows from a table": {
        "main": [
          [
            {
              "node": "obtener producto en otro informe",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Tailwind Media",
    "name": "Version 3ebaa34a",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "3ebaa34a-24d2-4620-8f8f-f0696b8d95ed",
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "obtener contador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "obtener pedido",
            "type": "main",
            "index": 0
          },
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "obtener pedido": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener contador": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "obtener producto en otro informe": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "juntar información",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "juntar información": {
      "main": [
        [
          {
            "node": "formatear informacion para sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formatear informacion para sheets": {
      "main": [
        [
          {
            "node": "escribir en informe de hoy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "escribir en informe de hoy": {
      "main": [
        [
          {
            "node": "sumar contador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "obtener producto en otro informe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-03T13:31:20.630Z",
  "id": "9pcwl5XAK1pZ6dfl",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "pruebaDevoluciones",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "informeDiarioPrueba",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1088,
        32
      ],
      "id": "cfd98e02-755b-443c-9698-ff7a15589388",
      "name": "Webhook",
      "webhookId": "7c1e3b37-6cc8-4f4a-81e3-c5897bdf497c"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cc0f02f8-8565-4ea6-a6dd-7084a488a75a",
              "leftValue": "={{ $('Webhook').item.json.body[0].headers[\"x-shopify-topic\"] }}",
              "rightValue": "refunds/create",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "a851fb06-e4c3-42fa-95ec-ecb05cf72335",
              "leftValue": "={{ $('Webhook').item.json.headers[\"x-shopify-topic\"] }}",
              "rightValue": "refunds/create",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -752,
        32
      ],
      "id": "7dda907f-0194-4a60-9830-ed092e805176",
      "name": "If"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2024-07/graphql.json",
        "query": "query getOrder($id: ID!) {\n  order(id: $id) {\n    id\n    name\n    createdAt\n    email\n    totalPriceSet {\n      shopMoney {\n        amount\n        currencyCode\n      }\n    }\n    lineItems(first: 10) {\n      edges {\n        node {\n          title\n          quantity\n          # NUEVO: Si esto es menor que 'quantity', significa que se ha devuelto\n          refundableQuantity \n          originalUnitPriceSet {\n            shopMoney {\n              amount\n              currencyCode\n            }\n          }\n        }\n      }\n    }\n    # NUEVO: Sección completa con el historial de devoluciones\n    refunds(first: 5) {\n      id\n      createdAt\n      note\n      totalRefundedSet {\n        shopMoney {\n          amount\n          currencyCode\n        }\n      }\n      refundLineItems(first: 10) {\n        edges {\n          node {\n            quantity\n            lineItem {\n              title\n            }\n          }\n        }\n      }\n    }\n    fulfillments {\n      id\n      location {\n        name\n        address {\n          address1\n          city\n          province\n          country\n          zip\n        }\n      }\n    }\n    transactions(first: 5) {\n      formattedGateway\n      kind\n      status\n    }\n    customer {\n      firstName\n      lastName\n      email\n    }\n  }\n}",
        "variables": "={\n  \"id\": \"gid://shopify/Order/{{ $('Webhook').item.json.body.order_id }}\"\n}",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        -496,
        -64
      ],
      "id": "0feeb4e4-6205-4f45-b33e-30697ae63f7c",
      "name": "obtener pedido",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "EE1JFqauvkjeKX5N",
          "mode": "list",
          "cachedResultName": "PRUEBA_INFORME_DIARIO",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/EE1JFqauvkjeKX5N"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -912,
        32
      ],
      "id": "6474297f-c463-4e5d-983b-d8b896c15de6",
      "name": "obtener contador"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "EE1JFqauvkjeKX5N",
          "mode": "list",
          "cachedResultName": "PRUEBA_INFORME_DIARIO",
          "cachedResultUrl": "/projects/x5UZcmGQw2OWHuXb/datatables/EE1JFqauvkjeKX5N"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "contador": "={{ $json.row_number + 1}}",
            "id_documento": "={{ $('obtener contador').first().json.id_documento }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_documento",
              "displayName": "id_documento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "contador",
              "displayName": "contador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        464,
        16
      ],
      "id": "bed162b7-65a5-4818-9e13-bb7e229b46c4",
      "name": "sumar contador"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $json.id_documento }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Hoja 1",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "ID PEDIDO",
              "lookupValue": "={{ $json.id_pedido }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -400,
        96
      ],
      "id": "88244861-8da4-4978-958f-6f7d064ab40f",
      "name": "obtener producto en otro informe",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "=1NnQWrr02pcOLmsh_nNSDMVTFq8OJ6gq58X5tM3RhoJM",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Hoja 1",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.Numero_linea }}",
            "PRECIO PAGADO": "={{ $json.Precio }}",
            "NOMBRE DE PRODUCTO": "={{ $json.Texto }}",
            "ID PEDIDO": "={{ $('Webhook').first().json.body.order_id }}",
            "SUCURSAL DE VENTA": "={{ $('obtener pedido').first().json.data.order.fulfillments[0].location.name }}",
            "MÉTODO DE PAGO": "={{ $('obtener pedido').first().json.data.order.transactions[0].formattedGateway }}",
            "VARIANTE": "DEVOLUCIÓN"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "ID PEDIDO",
              "displayName": "ID PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "SUCURSAL DE VENTA",
              "displayName": "SUCURSAL DE VENTA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "MÉTODO DE PAGO",
              "displayName": "MÉTODO DE PAGO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "COSTE POR UNIDAD",
              "displayName": "COSTE POR UNIDAD",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO DE PRODUCTO",
              "displayName": "PRECIO DE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRECIO PAGADO",
              "displayName": "PRECIO PAGADO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "DESCUENTO",
              "displayName": "DESCUENTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "NOMBRE DE PRODUCTO",
              "displayName": "NOMBRE DE PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "VARIANTE",
              "displayName": "VARIANTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        272,
        16
      ],
      "id": "d702682b-8b7b-40de-8736-6775774287f9",
      "name": "escribir en informe de hoy",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "RCuKUCifcA4jENcY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -256,
        16
      ],
      "id": "83856bf3-b702-4a6f-b0bd-70d04e885263",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "// --- 1. PREPARACIÓN DE DATOS ---\nconst shopifyItem = items.find(i => i.json.data && i.json.data.order);\nconst dbItems = items.filter(i => i.json['ID PEDIDO']);\n\nif (!shopifyItem) return [];\n\nconst order = shopifyItem.json.data.order;\nconst orderIdSimple = order.id.replace(\"gid://shopify/Order/\", \"\");\nconst movements = [];\n\n// MAPA DEL HISTÓRICO (Lo que el cliente tenía antes de hoy)\n// Usamos un mapa para controlar las cantidades: { \"Gafas\": 1, \"Camiseta\": 2 }\nconst inventoryChecklist = {};\n\ndbItems.forEach(item => {\n    const name = item.json['NOMBRE DE PRODUCTO'];\n    const price = parseFloat(item.json['PRECIO PAGADO'] || 0);\n    \n    if (inventoryChecklist[name]) {\n        inventoryChecklist[name].qty += 1;\n    } else {\n        inventoryChecklist[name] = { qty: 1, price: price };\n    }\n});\n\n// --- 2. PROCESAR \"DEVUELTO\" ---\n// Primero miramos exclusivamente el Refund de hoy\nif (order.refunds && order.refunds.length > 0) {\n    const currentRefund = order.refunds[0]; \n\n    for (const edge of currentRefund.refundLineItems.edges) {\n        const refundItem = edge.node;\n        const name = refundItem.lineItem.title;\n        const qtyReturned = refundItem.quantity;\n        \n        // Buscamos el precio original\n        let price = 0;\n        if (inventoryChecklist[name]) {\n            price = inventoryChecklist[name].price;\n            // IMPORTANTE: \"Gastamos\" el stock histórico. \n            // Si tenía 1 y devuelve 1, ahora en el histórico virtual queda 0.\n            inventoryChecklist[name].qty -= qtyReturned;\n        } else {\n             // Fallback por si no estaba en base de datos\n             const originalLine = order.lineItems.edges.find(e => e.node.title === name);\n             price = originalLine ? parseFloat(originalLine.node.originalUnitPriceSet.shopMoney.amount) : 0;\n        }\n\n        movements.push({\n            \"ID PEDIDO\": orderIdSimple,\n            \"TIPO\": \"DEVUELTO\",\n            \"PRODUCTO\": name,\n            \"CANTIDAD\": -qtyReturned,\n            \"IMPORTE\": (price * qtyReturned) * -1\n        });\n    }\n}\n\n// --- 3. PROCESAR \"SIN CAMBIOS\" Y \"CAMBIO\" ---\n// Ahora recorremos el pedido actual (items vivos)\nfor (const edge of order.lineItems.edges) {\n    const item = edge.node;\n    \n    // Solo miramos items activos (no devueltos completamente en el pasado)\n    if (item.refundableQuantity > 0) {\n        const name = item.title;\n        const currentQty = item.refundableQuantity;\n        const currentPrice = parseFloat(item.originalUnitPriceSet.shopMoney.amount);\n        \n        // Verificamos cuánto queda en el checklist del histórico\n        const oldData = inventoryChecklist[name];\n        const oldQtyAvailable = oldData ? Math.max(0, oldData.qty) : 0;\n\n        // CÁLCULO DE DESGLOSE\n        // 1. ¿Cuántos son SIN CAMBIOS? (El solapamiento entre lo que hay y lo que había)\n        const qtyUnchanged = Math.min(currentQty, oldQtyAvailable);\n        \n        // 2. ¿Cuántos son CAMBIO? (Lo que hay de más respecto a lo viejo)\n        const qtyNew = Math.max(0, currentQty - oldQtyAvailable);\n\n        // -- GENERAR LÍNEA: SIN CAMBIOS --\n        if (qtyUnchanged > 0) {\n            movements.push({\n                \"ID PEDIDO\": orderIdSimple,\n                \"TIPO\": \"SIN CAMBIOS\",\n                \"PRODUCTO\": name,\n                \"CANTIDAD\": qtyUnchanged,\n                \"IMPORTE\": 0 // 0 porque financieramente no afecta al reporte de hoy\n            });\n            // Restamos del checklist para no repetirlo\n            if (inventoryChecklist[name]) inventoryChecklist[name].qty -= qtyUnchanged;\n        }\n\n        // -- GENERAR LÍNEA: CAMBIO --\n        if (qtyNew > 0) {\n            movements.push({\n                \"ID PEDIDO\": orderIdSimple,\n                \"TIPO\": \"CAMBIO\", // Es nuevo o sustitución\n                \"PRODUCTO\": name,\n                \"CANTIDAD\": qtyNew,\n                \"IMPORTE\": currentPrice * qtyNew // Valor positivo\n            });\n        }\n    }\n}\n\nreturn movements;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        16
      ],
      "id": "9e73f29f-6b1e-4f1e-829a-6cb9a4a98162",
      "name": "juntar información"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "aaebdeef-6cac-4712-a953-8e04b1ff3cbc",
              "name": "Precio",
              "value": "={{ $items().reduce((acumulador, item) => acumulador + (parseFloat(item.json[\"IMPORTE\"]) || 0), 0).toFixed(2) }}",
              "type": "number"
            },
            {
              "id": "82bc8e66-6f80-4613-b1ec-128a8f37050e",
              "name": "Texto",
              "value": "={{ $items().map(item => item.json[\"PRODUCTO\"] + \" (\" + item.json[\"TIPO\"] + \")\").join(\", \") }}",
              "type": "string"
            },
            {
              "id": "ecd82425-252d-456c-878a-87c828085f50",
              "name": "Numero_linea",
              "value": "={{ $('obtener contador').first().json.contador }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        96,
        16
      ],
      "id": "24ddd213-d872-42e1-a420-3be6c3be9c1f",
      "name": "formatear informacion para sheets",
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "Pedidos-Documentos",
          "mode": "list",
          "cachedResultName": "Pedidos-Documentos"
        },
        "where": {
          "values": [
            {
              "column": "id_pedido",
              "value": "={{ $('Webhook').item.json.body.order_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -576,
        96
      ],
      "id": "b8220807-8f47-48c2-b93a-ee9bcfb860e5",
      "name": "Select rows from a table",
      "credentials": {
        "postgres": {
          "id": "UPETCYNZNCReuZu8",
          "name": "Postgres Supabase"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-12-03T13:31:20.638Z",
      "createdAt": "2025-12-03T13:31:20.638Z",
      "role": "workflow:owner",
      "workflowId": "9pcwl5XAK1pZ6dfl",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-02-06T07:59:55.760Z",
  "versionId": "3ebaa34a-24d2-4620-8f8f-f0696b8d95ed"
}