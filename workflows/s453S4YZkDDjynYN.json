{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-01-20T18:31:41.000Z",
    "createdAt": "2026-01-20T18:31:39.009Z",
    "versionId": "e2eac41b-75fc-48ae-8f4d-3c9d09dc0f0d",
    "workflowId": "s453S4YZkDDjynYN",
    "nodes": [
      {
        "parameters": {
          "pollTimes": {
            "item": [
              {
                "mode": "everyMinute"
              }
            ]
          },
          "simple": false,
          "filters": {
            "q": "(from:no-reply@vinted.es subject:\"Has vendido un art√≠culo en Vinted\") OR (from:info@wallapop.com (subject:\"Sale confirmed! Follow the instructions to send your package\" OR subject:\"¬°Venta confirmada! Sigue las instrucciones para enviar tu paquete\"))"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.gmailTrigger",
        "typeVersion": 1.3,
        "position": [
          -560,
          -16
        ],
        "id": "be0f4b14-0fb1-461d-8188-dfef39c16960",
        "name": "Gmail Trigger",
        "notesInFlow": true,
        "credentials": {
          "gmailOAuth2": {
            "id": "RHR23CJ1w4T4gR4J",
            "name": "Gmail info@rules-shop.es"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// 1. Obtenemos el texto completo\nconst emailText = $input.item.json.text || $input.item.json.html || \"\";\n\n// Limpiamos saltos de l√≠nea y espacios extra\nconst cleanText = emailText.replace(/\\r\\n/g, '\\n').replace(/\\s+/g, ' ');\n\n// --- PATRONES CORREGIDOS (Para soportar los asteriscos * de Gmail) ---\n\n// A. Patr√≥n PRODUCTO\n// Explicaci√≥n: Busca \"ha comprado\", luego espacios, luego Opcionalmente asteriscos [*]?, luego comillas\nconst productPattern = /ha comprado\\s+[*]*[\"‚Äú'](.+?)[\"‚Äù']([*]|[\\.])/i;\n\n// B. Patr√≥n EMAIL\nconst emailPattern = /E-mail:\\s*([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+)/i;\n\n// C. Patr√≥n NOMBRE REAL\nconst realNamePattern = /Direcci√≥n:\\s*([^,]+),/i;\n\n// D. Patr√≥n USUARIO\nconst usernamePattern = /([^\\s]+)\\s+ha comprado/i;\n\n\n// --- EJECUCI√ìN ---\nconst matchProduct = cleanText.match(productPattern);\nconst matchEmail = cleanText.match(emailPattern);\nconst matchRealName = cleanText.match(realNamePattern);\nconst matchUsername = cleanText.match(usernamePattern);\n\n// Variables por defecto\nlet productName = \"Producto Vinted\"; \n// Si encontramos el producto, quitamos posibles comillas o asteriscos extra\nif (matchProduct && matchProduct[1]) {\n  productName = matchProduct[1].replace(/[*]/g, '').trim();\n}\n\nlet finalEmail = \"\";\nlet firstName = \"\";\nlet lastName = \"\";\n\n// 1. EMAIL\nif (matchEmail && matchEmail[1]) {\n  finalEmail = matchEmail[1].trim(); \n} else if (matchUsername && matchUsername[1]) {\n  // Limpiamos asteriscos del usuario si los tiene (*usuario* -> usuario)\n  const cleanUser = matchUsername[1].replace(/\\*/g, '');\n  finalEmail = `${cleanUser}@vinted.tailwind.es`;\n}\n\n// 2. NOMBRE\nif (matchRealName && matchRealName[1]) {\n  const fullName = matchRealName[1].trim();\n  const nameParts = fullName.split(\" \");\n  if (nameParts.length > 1) {\n    lastName = nameParts.pop(); \n    firstName = nameParts.join(\" \"); \n  } else {\n    firstName = fullName;\n    lastName = \"(Vinted)\";\n  }\n} else if (matchUsername && matchUsername[1]) {\n  firstName = matchUsername[1].replace(/\\*/g, '');\n  lastName = \"(Vinted)\";\n}\n\n// Usuario limpio para la nota\nconst cleanUsername = matchUsername ? matchUsername[1].replace(/\\*/g, '') : 'Desconocido';\n\nif (matchProduct || matchEmail) {\n  return {\n    json: {\n      status: \"success\",\n      customer: {\n        first_name: firstName,\n        last_name: lastName,\n        email: finalEmail,\n        tags: [\"Cliente Vinted\"],\n        note: `Comprado en Vinted: ${productName}. Usuario: ${cleanUsername}`\n      },\n      product: {\n        name: productName\n      }\n    }\n  };\n} else {\n  return {\n    json: {\n      error: \"No se pudieron extraer los datos\",\n      debug: cleanText.substring(0, 500)\n    }\n  };\n}"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          48,
          576
        ],
        "id": "4cdfe765-3814-4d6c-8386-333d5b18f607",
        "name": "Code in JavaScript"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "8724e9f2-0555-4c32-8f7d-8ca1767b60c1",
                "name": "NOMBRE",
                "value": "={{ $json.customer.first_name }}",
                "type": "string"
              },
              {
                "id": "6297fbdb-be85-4cda-8ee5-d60c55afb109",
                "name": "APELLIDO",
                "value": "={{ $json.customer.last_name }}",
                "type": "string"
              },
              {
                "id": "cfb53d0f-f6b0-4e5e-8634-e45c2dd8b10f",
                "name": "CORREO",
                "value": "={{ $json.customer.email }}",
                "type": "string"
              },
              {
                "id": "8bb80dc3-9a01-4e1c-b31b-afdfdaf60297",
                "name": "PRODUCTO",
                "value": "={{ $json.product.name }}",
                "type": "string"
              },
              {
                "id": "8c2b37dd-7ccb-4776-9741-e03d7210190b",
                "name": "ETIQUETAS",
                "value": "={{ $json.customer.tags[0] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          192,
          576
        ],
        "id": "2963a16a-a137-414f-aca4-439be18b907b",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "=query findCustomer($query: String!) {\n  customers(first: 1, query: $query) {\n    edges {\n      node {\n        id\n        firstName\n        lastName\n        email\n        tags\n      }\n    }\n  }\n}",
          "variables": "={\n  \"query\": \"email:{{ $json.CORREO }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          336,
          576
        ],
        "id": "9e556f28-8d43-4be4-ba7b-8d56900cbc4e",
        "name": "GraphQL",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "0a8a111e-7d12-42fc-a81f-15619c8f844e",
                "leftValue": "={{ $json.data.customers.edges }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          480,
          576
        ],
        "id": "07b657b9-de88-4ed6-b4d0-25a5afb60bfe",
        "name": "If"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "mutation createCustomer($input: CustomerInput!) {\n  customerCreate(input: $input) {\n    customer {\n      id\n      email\n      firstName\n      lastName\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={\n  \"input\": {\n    \"firstName\": \"{{ $('Edit Fields').item.json.NOMBRE }}\",\n    \"lastName\": \"{{ $('Edit Fields').item.json.APELLIDO }}\",\n    \"email\": \"{{ $('Edit Fields').item.json.CORREO }}\",\n    \"note\": \"Comprado en Vinted: {{ $('Edit Fields').item.json.PRODUCTO }}\",\n    \"tags\": [\"{{ $('Edit Fields').item.json.ETIQUETAS }}\"],\n    \"emailMarketingConsent\": {\n      \"marketingState\": \"NOT_SUBSCRIBED\",\n      \"marketingOptInLevel\": \"SINGLE_OPT_IN\"\n    }\n  }\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          688,
          464
        ],
        "id": "68144495-7bc0-466e-b603-a1fafbd441df",
        "name": "A√±adir_cliente",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
          "variables": "={\n  \"query\": \"title:{{ $('Edit Fields').item.json.PRODUCTO }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          848,
          464
        ],
        "id": "f20f86b5-a2b9-42fb-8629-6b6ba10cea71",
        "name": "Buscar_producto",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          1008,
          464
        ],
        "id": "ab8aebba-4287-4b13-a305-515ed8f25399",
        "name": "restar_stock",
        "alwaysOutputData": true,
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
          "variables": "={\n  \"query\": \"title:{{ $('Edit Fields').item.json.PRODUCTO }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          688,
          672
        ],
        "id": "4c19a890-aa0e-44ab-90b1-204ec92702ed",
        "name": "Buscar_producto1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          848,
          672
        ],
        "id": "8e64ac46-3900-4875-a0ef-18c385328599",
        "name": "restar_stock1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
                "leftValue": "={{ $json.errors[0].message }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          1168,
          464
        ],
        "id": "a909fe50-1c1b-4f9f-ae40-0e3b91cc632f",
        "name": "If1"
      },
      {
        "parameters": {
          "sendTo": "info@rules-shop.es",
          "subject": "Producto Vendido en Vinted",
          "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Vinted</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Vinted pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Vinted:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields').item.json.NOMBRE }} {{ $('Edit Fields').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          1360,
          352
        ],
        "id": "09ed8cc6-5578-408e-8ff3-1ecbb8888a74",
        "name": "Send a message",
        "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
        "credentials": {
          "gmailOAuth2": {
            "id": "RHR23CJ1w4T4gR4J",
            "name": "Gmail info@rules-shop.es"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          1360,
          560
        ],
        "id": "2b2db4d5-44ac-4970-8818-ab095e365864",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
                "leftValue": "={{ $json.errors[0].message }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          1184,
          848
        ],
        "id": "bf81a752-f9ff-4baf-a060-0a33f423123e",
        "name": "If2"
      },
      {
        "parameters": {
          "sendTo": "info@rules-shop.es",
          "subject": "Producto Vendido en Vinted",
          "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Vinted</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Vinted pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Vinted:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields').item.json.NOMBRE }} {{ $('Edit Fields').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          1376,
          736
        ],
        "id": "a9b80301-c949-4fbb-85a4-eeeeaa265f30",
        "name": "Send a message1",
        "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
        "credentials": {
          "gmailOAuth2": {
            "id": "RHR23CJ1w4T4gR4J",
            "name": "Gmail info@rules-shop.es"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          1376,
          944
        ],
        "id": "4a1662d9-5d0a-488d-8608-e82719a46545",
        "name": "No Operation, do nothing1"
      },
      {
        "parameters": {
          "jsCode": "// 1. Obtenemos el HTML crudo del correo\nconst htmlContent = $input.item.json.html || \"\";\n\n// 2. Definimos las Expresiones Regulares (Regex) H√çBRIDAS\n//    Usamos el s√≠mbolo \"|\" que significa \"O\" (uno u otro)\n\n// A. PRODUCTO\n// La estructura HTML de margen suele ser id√©ntica en ambos idiomas.\n// Busca texto dentro de un p√°rrafo con margen espec√≠fico.\nconst productRegex = /margin:0 8px\">([^<]+)<\\/p>/i;\n\n// B. CLIENTE (NOMBRE) - AQU√ç EST√Å LA MAGIA\n// Busca \"Purchased by:\" (Ingl√©s) O \"Comprado por:\" (Espa√±ol)\n// Luego salta el c√≥digo hasta encontrar el div con el color negro (#000000)\nconst buyerRegex = /(?:Purchased by:|Comprado por:)[\\s\\S]*?color:#000000;\">(.*?)<\\/div>/i;\n\n// C. PRECIO\n// La palabra \"Total\" se escribe igual en Ingl√©s y Espa√±ol.\n// Busca \"Total\", salta c√≥digo y busca el precio grande (32px)\nconst priceRegex = /Total[\\s\\S]*?font-size:32px\">([\\d.,]+)‚Ç¨<\\/span>/i;\n\n\n// --- EJECUCI√ìN Y EXTRACCI√ìN ---\n\nconst matchProduct = htmlContent.match(productRegex);\nconst matchBuyer = htmlContent.match(buyerRegex);\nconst matchPrice = htmlContent.match(priceRegex);\n\n// --- PROCESAMIENTO DE DATOS ---\n\n// 1. PRODUCTO\nlet productName = \"Producto Wallapop Desconocido\";\nif (matchProduct && matchProduct[1]) {\n    productName = matchProduct[1].trim();\n}\n\n// 2. PRECIO\nlet salePrice = \"0.00\";\nif (matchPrice && matchPrice[1]) {\n    salePrice = matchPrice[1].trim();\n}\n\n// 3. CLIENTE Y EMAIL\nlet firstName = \"Cliente\";\nlet lastName = \"Wallapop\";\nlet finalEmail = \"info@wallapop.com\"; \n\nif (matchBuyer && matchBuyer[1]) {\n    const fullName = matchBuyer[1].trim(); \n    \n    // Generar Email Ficticio (normalizar caracteres raros)\n    // Esto convierte \"Pablo M.\" o \"John D.\" en \"pablom\" o \"johnd\"\n    const safeUser = fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(); \n    finalEmail = `${safeUser}@wallapop.local`;\n\n    // Separar Nombre y Apellido\n    const nameParts = fullName.split(\" \");\n    if (nameParts.length > 1) {\n        lastName = nameParts.pop(); \n        firstName = nameParts.join(\" \"); \n    } else {\n        firstName = fullName;\n    }\n}\n\n// --- SALIDA DE DATOS ---\n\nif (matchProduct || matchBuyer) {\n    return {\n        json: {\n            status: \"success\",\n            language_detected: matchBuyer && matchBuyer[0].includes(\"Purchased\") ? \"English\" : \"Spanish\",\n            customer: {\n                first_name: firstName,\n                last_name: lastName,\n                email: finalEmail,\n                tags: [\"Cliente Wallapop\"],\n                note: `Venta Wallapop: ${productName}. Precio: ${salePrice}‚Ç¨. (Detectado auto)`\n            },\n            product: {\n                name: productName,\n                price: salePrice\n            }\n        }\n    };\n} else {\n    return {\n        json: {\n            error: \"No se pudieron encontrar los datos en el HTML\",\n            debug_html_snippet: htmlContent.substring(0, 500)\n        }\n    };\n}"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          32,
          -240
        ],
        "id": "8bc0e663-5e3f-4a51-8174-dcdb04e902d5",
        "name": "Code in JavaScript1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "8724e9f2-0555-4c32-8f7d-8ca1767b60c1",
                "name": "NOMBRE",
                "value": "={{ $json.customer.first_name }}",
                "type": "string"
              },
              {
                "id": "6297fbdb-be85-4cda-8ee5-d60c55afb109",
                "name": "APELLIDO",
                "value": "={{ $json.customer.last_name }}",
                "type": "string"
              },
              {
                "id": "8bb80dc3-9a01-4e1c-b31b-afdfdaf60297",
                "name": "PRODUCTO",
                "value": "={{ $json.product.name }}",
                "type": "string"
              },
              {
                "id": "8c2b37dd-7ccb-4776-9741-e03d7210190b",
                "name": "ETIQUETAS",
                "value": "={{ $json.customer.tags[0] }}",
                "type": "string"
              },
              {
                "id": "4c465cb1-2285-4c68-99a1-4d0b42265f3d",
                "name": "CORREO",
                "value": "={{ $json.customer.email }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          176,
          -240
        ],
        "id": "a97dac04-1287-45fc-bdc5-f1d912402fbb",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "=query findCustomer($query: String!) {\n  customers(first: 1, query: $query) {\n    edges {\n      node {\n        id\n        firstName\n        lastName\n        email\n        tags\n      }\n    }\n  }\n}",
          "variables": "={\n  \"query\": \"email:{{ $json.CORREO }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          320,
          -240
        ],
        "id": "9266dc4c-a8b4-4137-ad52-c33168ad7496",
        "name": "GraphQL1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "0a8a111e-7d12-42fc-a81f-15619c8f844e",
                "leftValue": "={{ $json.data.customers.edges }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          464,
          -240
        ],
        "id": "b6ea7c20-97b7-4d70-895e-f3aa18aa86b9",
        "name": "If3"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "mutation createCustomer($input: CustomerInput!) {\n  customerCreate(input: $input) {\n    customer {\n      id\n      email\n      firstName\n      lastName\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={\n  \"input\": {\n    \"firstName\": \"{{ $('Edit Fields1').item.json.NOMBRE }}\",\n    \"lastName\": \"{{ $('Edit Fields1').item.json.APELLIDO }}\",\n    \"email\": \"{{ $('Edit Fields1').item.json.CORREO }}\",\n    \"note\": \"Comprado en Vinted: {{ $('Edit Fields1').item.json.PRODUCTO }}\",\n    \"tags\": [\"{{ $('Edit Fields1').item.json.ETIQUETAS }}\"],\n    \"emailMarketingConsent\": {\n      \"marketingState\": \"NOT_SUBSCRIBED\",\n      \"marketingOptInLevel\": \"SINGLE_OPT_IN\"\n    }\n  }\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          672,
          -368
        ],
        "id": "f6d00919-0089-46fb-b314-93f8adc51178",
        "name": "A√±adir_cliente1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
          "variables": "={\n  \"query\": \"title:{{ $('Edit Fields1').item.json.PRODUCTO }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          832,
          -368
        ],
        "id": "fc5e3489-8363-4b4a-87e4-620d77469737",
        "name": "Buscar_producto2",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          992,
          -368
        ],
        "id": "b019dbc0-ecf0-43da-81b8-7d02d69c17fe",
        "name": "restar_stock2",
        "alwaysOutputData": true,
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
          "variables": "={\n  \"query\": \"title:{{ $('Edit Fields1').item.json.PRODUCTO }}\"\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          672,
          -144
        ],
        "id": "14129625-811b-4b14-80ac-5d88882f2dc8",
        "name": "Buscar_producto3",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        }
      },
      {
        "parameters": {
          "authentication": "headerAuth",
          "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
          "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
          "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
        },
        "type": "n8n-nodes-base.graphql",
        "typeVersion": 1.1,
        "position": [
          832,
          -144
        ],
        "id": "b47e91da-60fc-4c07-a1e7-4bcff6a19523",
        "name": "restar_stock3",
        "credentials": {
          "httpHeaderAuth": {
            "id": "OPt2Cl0dnwcU4qRk",
            "name": "ShopifyInformes"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
                "leftValue": "={{ $json.errors[0].message }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          1152,
          -368
        ],
        "id": "88ec5680-5129-4826-a8e6-f7102997932a",
        "name": "If4"
      },
      {
        "parameters": {
          "sendTo": "info@rules-shop.es",
          "subject": "Producto Vendido en Vinted",
          "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Wallapop</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Wallapop pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Wallapop:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields1').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields1').item.json.NOMBRE }} {{ $('Edit Fields1').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          1344,
          -480
        ],
        "id": "c5ac73a8-0655-49ed-b397-32e4c94dbfab",
        "name": "Send a message2",
        "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
        "credentials": {
          "gmailOAuth2": {
            "id": "RHR23CJ1w4T4gR4J",
            "name": "Gmail info@rules-shop.es"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          1344,
          -256
        ],
        "id": "81f6bb15-151d-4313-be55-dd33e82eeee7",
        "name": "No Operation, do nothing2"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
                "leftValue": "={{ $json.errors[0].message }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          1168,
          32
        ],
        "id": "8bfd2d74-9826-4218-8a54-d0f54d000e39",
        "name": "If5"
      },
      {
        "parameters": {
          "sendTo": "info@rules-shop.es",
          "subject": "Producto Vendido en Vinted",
          "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Wallapop</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Wallapop pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Wallapop:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields1').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields1').item.json.NOMBRE }} {{ $('Edit Fields1').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          1360,
          -80
        ],
        "id": "f3adfb9a-00fb-4b05-ba3c-0bfefdad6238",
        "name": "Send a message3",
        "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
        "credentials": {
          "gmailOAuth2": {
            "id": "RHR23CJ1w4T4gR4J",
            "name": "Gmail info@rules-shop.es"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          1360,
          128
        ],
        "id": "18e53cd3-4282-4ae5-839d-e41de0f9eb99",
        "name": "No Operation, do nothing3"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "f80c1b3d-2b33-46fa-ad29-fcf5df34694f",
                "leftValue": "={{ $json.from.text }}",
                "rightValue": "\"Wallapop\" <info@wallapop.com>",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -368,
          -16
        ],
        "id": "be40b303-7a0f-4030-aa5f-5d3f3b29bb7f",
        "name": "If6"
      },
      {
        "parameters": {
          "content": "## De Wallapop",
          "height": 864,
          "width": 1760,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -160,
          -544
        ],
        "id": "a9eb70be-445d-4bc2-982a-068a3647bb60",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "## De Vinted",
          "height": 816,
          "width": 1760,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -160,
          336
        ],
        "id": "0402b9a5-e42a-494a-8105-07c95b00002c",
        "name": "Sticky Note1"
      }
    ],
    "connections": {
      "Gmail Trigger": {
        "main": [
          [
            {
              "node": "If6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "GraphQL",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "A√±adir_cliente",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Buscar_producto1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "A√±adir_cliente": {
        "main": [
          [
            {
              "node": "Buscar_producto",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscar_producto": {
        "main": [
          [
            {
              "node": "restar_stock",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscar_producto1": {
        "main": [
          [
            {
              "node": "restar_stock1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "restar_stock": {
        "main": [
          [
            {
              "node": "If1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If1": {
        "main": [
          [
            {
              "node": "Send a message",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If2": {
        "main": [
          [
            {
              "node": "Send a message1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "restar_stock1": {
        "main": [
          [
            {
              "node": "If2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript1": {
        "main": [
          [
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "GraphQL1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "GraphQL1": {
        "main": [
          [
            {
              "node": "If3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If3": {
        "main": [
          [
            {
              "node": "A√±adir_cliente1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Buscar_producto3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "A√±adir_cliente1": {
        "main": [
          [
            {
              "node": "Buscar_producto2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscar_producto2": {
        "main": [
          [
            {
              "node": "restar_stock2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "restar_stock2": {
        "main": [
          [
            {
              "node": "If4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Buscar_producto3": {
        "main": [
          [
            {
              "node": "restar_stock3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "restar_stock3": {
        "main": [
          [
            {
              "node": "If5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If4": {
        "main": [
          [
            {
              "node": "Send a message2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If5": {
        "main": [
          [
            {
              "node": "Send a message3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If6": {
        "main": [
          [
            {
              "node": "Code in JavaScript1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Info Tailwind",
    "name": "Version e2eac41b",
    "description": "",
    "autosaved": false
  },
  "activeVersionId": "e2eac41b-75fc-48ae-8f4d-3c9d09dc0f0d",
  "connections": {
    "Gmail Trigger": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "GraphQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "A√±adir_cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar_producto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "A√±adir_cliente": {
      "main": [
        [
          {
            "node": "Buscar_producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_producto": {
      "main": [
        [
          {
            "node": "restar_stock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_producto1": {
      "main": [
        [
          {
            "node": "restar_stock1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "restar_stock": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Send a message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "restar_stock1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "GraphQL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GraphQL1": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "A√±adir_cliente1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar_producto3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "A√±adir_cliente1": {
      "main": [
        [
          {
            "node": "Buscar_producto2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_producto2": {
      "main": [
        [
          {
            "node": "restar_stock2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "restar_stock2": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_producto3": {
      "main": [
        [
          {
            "node": "restar_stock3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "restar_stock3": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Send a message2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Send a message3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-03T10:25:57.653Z",
  "id": "s453S4YZkDDjynYN",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Cliente_Vinted/Wallapop_info@rules-shop.es",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {
          "q": "(from:no-reply@vinted.es subject:\"Has vendido un art√≠culo en Vinted\") OR (from:info@wallapop.com (subject:\"Sale confirmed! Follow the instructions to send your package\" OR subject:\"¬°Venta confirmada! Sigue las instrucciones para enviar tu paquete\"))"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -560,
        -16
      ],
      "id": "be0f4b14-0fb1-461d-8188-dfef39c16960",
      "name": "Gmail Trigger",
      "notesInFlow": true,
      "credentials": {
        "gmailOAuth2": {
          "id": "RHR23CJ1w4T4gR4J",
          "name": "Gmail info@rules-shop.es"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtenemos el texto completo\nconst emailText = $input.item.json.text || $input.item.json.html || \"\";\n\n// Limpiamos saltos de l√≠nea y espacios extra\nconst cleanText = emailText.replace(/\\r\\n/g, '\\n').replace(/\\s+/g, ' ');\n\n// --- PATRONES CORREGIDOS (Para soportar los asteriscos * de Gmail) ---\n\n// A. Patr√≥n PRODUCTO\n// Explicaci√≥n: Busca \"ha comprado\", luego espacios, luego Opcionalmente asteriscos [*]?, luego comillas\nconst productPattern = /ha comprado\\s+[*]*[\"‚Äú'](.+?)[\"‚Äù']([*]|[\\.])/i;\n\n// B. Patr√≥n EMAIL\nconst emailPattern = /E-mail:\\s*([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+)/i;\n\n// C. Patr√≥n NOMBRE REAL\nconst realNamePattern = /Direcci√≥n:\\s*([^,]+),/i;\n\n// D. Patr√≥n USUARIO\nconst usernamePattern = /([^\\s]+)\\s+ha comprado/i;\n\n\n// --- EJECUCI√ìN ---\nconst matchProduct = cleanText.match(productPattern);\nconst matchEmail = cleanText.match(emailPattern);\nconst matchRealName = cleanText.match(realNamePattern);\nconst matchUsername = cleanText.match(usernamePattern);\n\n// Variables por defecto\nlet productName = \"Producto Vinted\"; \n// Si encontramos el producto, quitamos posibles comillas o asteriscos extra\nif (matchProduct && matchProduct[1]) {\n  productName = matchProduct[1].replace(/[*]/g, '').trim();\n}\n\nlet finalEmail = \"\";\nlet firstName = \"\";\nlet lastName = \"\";\n\n// 1. EMAIL\nif (matchEmail && matchEmail[1]) {\n  finalEmail = matchEmail[1].trim(); \n} else if (matchUsername && matchUsername[1]) {\n  // Limpiamos asteriscos del usuario si los tiene (*usuario* -> usuario)\n  const cleanUser = matchUsername[1].replace(/\\*/g, '');\n  finalEmail = `${cleanUser}@vinted.tailwind.es`;\n}\n\n// 2. NOMBRE\nif (matchRealName && matchRealName[1]) {\n  const fullName = matchRealName[1].trim();\n  const nameParts = fullName.split(\" \");\n  if (nameParts.length > 1) {\n    lastName = nameParts.pop(); \n    firstName = nameParts.join(\" \"); \n  } else {\n    firstName = fullName;\n    lastName = \"(Vinted)\";\n  }\n} else if (matchUsername && matchUsername[1]) {\n  firstName = matchUsername[1].replace(/\\*/g, '');\n  lastName = \"(Vinted)\";\n}\n\n// Usuario limpio para la nota\nconst cleanUsername = matchUsername ? matchUsername[1].replace(/\\*/g, '') : 'Desconocido';\n\nif (matchProduct || matchEmail) {\n  return {\n    json: {\n      status: \"success\",\n      customer: {\n        first_name: firstName,\n        last_name: lastName,\n        email: finalEmail,\n        tags: [\"Cliente Vinted\"],\n        note: `Comprado en Vinted: ${productName}. Usuario: ${cleanUsername}`\n      },\n      product: {\n        name: productName\n      }\n    }\n  };\n} else {\n  return {\n    json: {\n      error: \"No se pudieron extraer los datos\",\n      debug: cleanText.substring(0, 500)\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        576
      ],
      "id": "4cdfe765-3814-4d6c-8386-333d5b18f607",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8724e9f2-0555-4c32-8f7d-8ca1767b60c1",
              "name": "NOMBRE",
              "value": "={{ $json.customer.first_name }}",
              "type": "string"
            },
            {
              "id": "6297fbdb-be85-4cda-8ee5-d60c55afb109",
              "name": "APELLIDO",
              "value": "={{ $json.customer.last_name }}",
              "type": "string"
            },
            {
              "id": "cfb53d0f-f6b0-4e5e-8634-e45c2dd8b10f",
              "name": "CORREO",
              "value": "={{ $json.customer.email }}",
              "type": "string"
            },
            {
              "id": "8bb80dc3-9a01-4e1c-b31b-afdfdaf60297",
              "name": "PRODUCTO",
              "value": "={{ $json.product.name }}",
              "type": "string"
            },
            {
              "id": "8c2b37dd-7ccb-4776-9741-e03d7210190b",
              "name": "ETIQUETAS",
              "value": "={{ $json.customer.tags[0] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        192,
        576
      ],
      "id": "2963a16a-a137-414f-aca4-439be18b907b",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "=query findCustomer($query: String!) {\n  customers(first: 1, query: $query) {\n    edges {\n      node {\n        id\n        firstName\n        lastName\n        email\n        tags\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"email:{{ $json.CORREO }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        336,
        576
      ],
      "id": "9e556f28-8d43-4be4-ba7b-8d56900cbc4e",
      "name": "GraphQL",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0a8a111e-7d12-42fc-a81f-15619c8f844e",
              "leftValue": "={{ $json.data.customers.edges }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        480,
        576
      ],
      "id": "07b657b9-de88-4ed6-b4d0-25a5afb60bfe",
      "name": "If"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation createCustomer($input: CustomerInput!) {\n  customerCreate(input: $input) {\n    customer {\n      id\n      email\n      firstName\n      lastName\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"firstName\": \"{{ $('Edit Fields').item.json.NOMBRE }}\",\n    \"lastName\": \"{{ $('Edit Fields').item.json.APELLIDO }}\",\n    \"email\": \"{{ $('Edit Fields').item.json.CORREO }}\",\n    \"note\": \"Comprado en Vinted: {{ $('Edit Fields').item.json.PRODUCTO }}\",\n    \"tags\": [\"{{ $('Edit Fields').item.json.ETIQUETAS }}\"],\n    \"emailMarketingConsent\": {\n      \"marketingState\": \"NOT_SUBSCRIBED\",\n      \"marketingOptInLevel\": \"SINGLE_OPT_IN\"\n    }\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        688,
        464
      ],
      "id": "68144495-7bc0-466e-b603-a1fafbd441df",
      "name": "A√±adir_cliente",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"title:{{ $('Edit Fields').item.json.PRODUCTO }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        848,
        464
      ],
      "id": "f20f86b5-a2b9-42fb-8629-6b6ba10cea71",
      "name": "Buscar_producto",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        1008,
        464
      ],
      "id": "ab8aebba-4287-4b13-a305-515ed8f25399",
      "name": "restar_stock",
      "alwaysOutputData": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"title:{{ $('Edit Fields').item.json.PRODUCTO }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        688,
        672
      ],
      "id": "4c19a890-aa0e-44ab-90b1-204ec92702ed",
      "name": "Buscar_producto1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        848,
        672
      ],
      "id": "8e64ac46-3900-4875-a0ef-18c385328599",
      "name": "restar_stock1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
              "leftValue": "={{ $json.errors[0].message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1168,
        464
      ],
      "id": "a909fe50-1c1b-4f9f-ae40-0e3b91cc632f",
      "name": "If1"
    },
    {
      "parameters": {
        "sendTo": "info@rules-shop.es",
        "subject": "Producto Vendido en Vinted",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Vinted</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Vinted pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Vinted:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields').item.json.NOMBRE }} {{ $('Edit Fields').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1360,
        352
      ],
      "id": "09ed8cc6-5578-408e-8ff3-1ecbb8888a74",
      "name": "Send a message",
      "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
      "credentials": {
        "gmailOAuth2": {
          "id": "RHR23CJ1w4T4gR4J",
          "name": "Gmail info@rules-shop.es"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1360,
        560
      ],
      "id": "2b2db4d5-44ac-4970-8818-ab095e365864",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
              "leftValue": "={{ $json.errors[0].message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1184,
        848
      ],
      "id": "bf81a752-f9ff-4baf-a060-0a33f423123e",
      "name": "If2"
    },
    {
      "parameters": {
        "sendTo": "info@rules-shop.es",
        "subject": "Producto Vendido en Vinted",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Vinted</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Vinted pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Vinted:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields').item.json.NOMBRE }} {{ $('Edit Fields').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1376,
        736
      ],
      "id": "a9b80301-c949-4fbb-85a4-eeeeaa265f30",
      "name": "Send a message1",
      "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
      "credentials": {
        "gmailOAuth2": {
          "id": "RHR23CJ1w4T4gR4J",
          "name": "Gmail info@rules-shop.es"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1376,
        944
      ],
      "id": "4a1662d9-5d0a-488d-8608-e82719a46545",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtenemos el HTML crudo del correo\nconst htmlContent = $input.item.json.html || \"\";\n\n// 2. Definimos las Expresiones Regulares (Regex) H√çBRIDAS\n//    Usamos el s√≠mbolo \"|\" que significa \"O\" (uno u otro)\n\n// A. PRODUCTO\n// La estructura HTML de margen suele ser id√©ntica en ambos idiomas.\n// Busca texto dentro de un p√°rrafo con margen espec√≠fico.\nconst productRegex = /margin:0 8px\">([^<]+)<\\/p>/i;\n\n// B. CLIENTE (NOMBRE) - AQU√ç EST√Å LA MAGIA\n// Busca \"Purchased by:\" (Ingl√©s) O \"Comprado por:\" (Espa√±ol)\n// Luego salta el c√≥digo hasta encontrar el div con el color negro (#000000)\nconst buyerRegex = /(?:Purchased by:|Comprado por:)[\\s\\S]*?color:#000000;\">(.*?)<\\/div>/i;\n\n// C. PRECIO\n// La palabra \"Total\" se escribe igual en Ingl√©s y Espa√±ol.\n// Busca \"Total\", salta c√≥digo y busca el precio grande (32px)\nconst priceRegex = /Total[\\s\\S]*?font-size:32px\">([\\d.,]+)‚Ç¨<\\/span>/i;\n\n\n// --- EJECUCI√ìN Y EXTRACCI√ìN ---\n\nconst matchProduct = htmlContent.match(productRegex);\nconst matchBuyer = htmlContent.match(buyerRegex);\nconst matchPrice = htmlContent.match(priceRegex);\n\n// --- PROCESAMIENTO DE DATOS ---\n\n// 1. PRODUCTO\nlet productName = \"Producto Wallapop Desconocido\";\nif (matchProduct && matchProduct[1]) {\n    productName = matchProduct[1].trim();\n}\n\n// 2. PRECIO\nlet salePrice = \"0.00\";\nif (matchPrice && matchPrice[1]) {\n    salePrice = matchPrice[1].trim();\n}\n\n// 3. CLIENTE Y EMAIL\nlet firstName = \"Cliente\";\nlet lastName = \"Wallapop\";\nlet finalEmail = \"info@wallapop.com\"; \n\nif (matchBuyer && matchBuyer[1]) {\n    const fullName = matchBuyer[1].trim(); \n    \n    // Generar Email Ficticio (normalizar caracteres raros)\n    // Esto convierte \"Pablo M.\" o \"John D.\" en \"pablom\" o \"johnd\"\n    const safeUser = fullName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase(); \n    finalEmail = `${safeUser}@wallapop.local`;\n\n    // Separar Nombre y Apellido\n    const nameParts = fullName.split(\" \");\n    if (nameParts.length > 1) {\n        lastName = nameParts.pop(); \n        firstName = nameParts.join(\" \"); \n    } else {\n        firstName = fullName;\n    }\n}\n\n// --- SALIDA DE DATOS ---\n\nif (matchProduct || matchBuyer) {\n    return {\n        json: {\n            status: \"success\",\n            language_detected: matchBuyer && matchBuyer[0].includes(\"Purchased\") ? \"English\" : \"Spanish\",\n            customer: {\n                first_name: firstName,\n                last_name: lastName,\n                email: finalEmail,\n                tags: [\"Cliente Wallapop\"],\n                note: `Venta Wallapop: ${productName}. Precio: ${salePrice}‚Ç¨. (Detectado auto)`\n            },\n            product: {\n                name: productName,\n                price: salePrice\n            }\n        }\n    };\n} else {\n    return {\n        json: {\n            error: \"No se pudieron encontrar los datos en el HTML\",\n            debug_html_snippet: htmlContent.substring(0, 500)\n        }\n    };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32,
        -240
      ],
      "id": "8bc0e663-5e3f-4a51-8174-dcdb04e902d5",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8724e9f2-0555-4c32-8f7d-8ca1767b60c1",
              "name": "NOMBRE",
              "value": "={{ $json.customer.first_name }}",
              "type": "string"
            },
            {
              "id": "6297fbdb-be85-4cda-8ee5-d60c55afb109",
              "name": "APELLIDO",
              "value": "={{ $json.customer.last_name }}",
              "type": "string"
            },
            {
              "id": "8bb80dc3-9a01-4e1c-b31b-afdfdaf60297",
              "name": "PRODUCTO",
              "value": "={{ $json.product.name }}",
              "type": "string"
            },
            {
              "id": "8c2b37dd-7ccb-4776-9741-e03d7210190b",
              "name": "ETIQUETAS",
              "value": "={{ $json.customer.tags[0] }}",
              "type": "string"
            },
            {
              "id": "4c465cb1-2285-4c68-99a1-4d0b42265f3d",
              "name": "CORREO",
              "value": "={{ $json.customer.email }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        176,
        -240
      ],
      "id": "a97dac04-1287-45fc-bdc5-f1d912402fbb",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "=query findCustomer($query: String!) {\n  customers(first: 1, query: $query) {\n    edges {\n      node {\n        id\n        firstName\n        lastName\n        email\n        tags\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"email:{{ $json.CORREO }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        320,
        -240
      ],
      "id": "9266dc4c-a8b4-4137-ad52-c33168ad7496",
      "name": "GraphQL1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0a8a111e-7d12-42fc-a81f-15619c8f844e",
              "leftValue": "={{ $json.data.customers.edges }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        464,
        -240
      ],
      "id": "b6ea7c20-97b7-4d70-895e-f3aa18aa86b9",
      "name": "If3"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation createCustomer($input: CustomerInput!) {\n  customerCreate(input: $input) {\n    customer {\n      id\n      email\n      firstName\n      lastName\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"firstName\": \"{{ $('Edit Fields1').item.json.NOMBRE }}\",\n    \"lastName\": \"{{ $('Edit Fields1').item.json.APELLIDO }}\",\n    \"email\": \"{{ $('Edit Fields1').item.json.CORREO }}\",\n    \"note\": \"Comprado en Vinted: {{ $('Edit Fields1').item.json.PRODUCTO }}\",\n    \"tags\": [\"{{ $('Edit Fields1').item.json.ETIQUETAS }}\"],\n    \"emailMarketingConsent\": {\n      \"marketingState\": \"NOT_SUBSCRIBED\",\n      \"marketingOptInLevel\": \"SINGLE_OPT_IN\"\n    }\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        672,
        -368
      ],
      "id": "f6d00919-0089-46fb-b314-93f8adc51178",
      "name": "A√±adir_cliente1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"title:{{ $('Edit Fields1').item.json.PRODUCTO }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        832,
        -368
      ],
      "id": "fc5e3489-8363-4b4a-87e4-620d77469737",
      "name": "Buscar_producto2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        992,
        -368
      ],
      "id": "b019dbc0-ecf0-43da-81b8-7d02d69c17fe",
      "name": "restar_stock2",
      "alwaysOutputData": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "query findStockIds($query: String!) {\n  products(first: 1, query: $query) {\n    edges {\n      node {\n        title\n        variants(first: 1) {\n          edges {\n            node {\n              inventoryItem {\n                id\n                inventoryLevels(first: 1) {\n                  edges {\n                    node {\n                      location {\n                        id\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}",
        "variables": "={\n  \"query\": \"title:{{ $('Edit Fields1').item.json.PRODUCTO }}\"\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        672,
        -144
      ],
      "id": "14129625-811b-4b14-80ac-5d88882f2dc8",
      "name": "Buscar_producto3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "endpoint": "https://rulesshop.myshopify.com/admin/api/2025-10/graphql.json",
        "query": "mutation adjustStock($input: InventoryAdjustQuantitiesInput!) {\n  inventoryAdjustQuantities(input: $input) {\n    inventoryAdjustmentGroup {\n      changes {\n        delta\n        quantityAfterChange\n      }\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}",
        "variables": "={\n  \"input\": {\n    \"reason\": \"correction\",\n    \"name\": \"available\",\n    \"changes\": [\n      {\n        \"delta\": -1,\n        \"inventoryItemId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.id }}\",\n        \"locationId\": \"{{ $json.data.products.edges[0].node.variants.edges[0].node.inventoryItem.inventoryLevels.edges[0].node.location.id }}\"\n      }\n    ]\n  }\n}"
      },
      "type": "n8n-nodes-base.graphql",
      "typeVersion": 1.1,
      "position": [
        832,
        -144
      ],
      "id": "b47e91da-60fc-4c07-a1e7-4bcff6a19523",
      "name": "restar_stock3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "OPt2Cl0dnwcU4qRk",
          "name": "ShopifyInformes"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
              "leftValue": "={{ $json.errors[0].message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1152,
        -368
      ],
      "id": "88ec5680-5129-4826-a8e6-f7102997932a",
      "name": "If4"
    },
    {
      "parameters": {
        "sendTo": "info@rules-shop.es",
        "subject": "Producto Vendido en Vinted",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Wallapop</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Wallapop pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Wallapop:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields1').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields1').item.json.NOMBRE }} {{ $('Edit Fields1').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1344,
        -480
      ],
      "id": "c5ac73a8-0655-49ed-b397-32e4c94dbfab",
      "name": "Send a message2",
      "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
      "credentials": {
        "gmailOAuth2": {
          "id": "RHR23CJ1w4T4gR4J",
          "name": "Gmail info@rules-shop.es"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1344,
        -256
      ],
      "id": "81f6bb15-151d-4313-be55-dd33e82eeee7",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "35743f6d-5a5c-4753-b456-a418f8b61963",
              "leftValue": "={{ $json.errors[0].message }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1168,
        32
      ],
      "id": "8bfd2d74-9826-4218-8a54-d0f54d000e39",
      "name": "If5"
    },
    {
      "parameters": {
        "sendTo": "info@rules-shop.es",
        "subject": "Producto Vendido en Vinted",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff;\">\n  \n  <h2 style=\"color: #D32F2F; margin-top: 0;\">‚ö†Ô∏è Acci√≥n Requerida: Stock Wallapop</h2>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Hola equipo, se ha vendido un producto en Wallapop pero <strong>el nombre no coincide exactamente</strong> con el de Shopify.\n  </p>\n  \n  <p style=\"color: #555555; font-size: 16px; line-height: 1.5;\">\n    Por seguridad, la automatizaci√≥n no ha descontado el stock. <strong>Por favor, cambie el stock manualmente.</strong>\n  </p>\n\n  <hr style=\"border: 0; border-top: 1px solid #eeeeee; margin: 20px 0;\">\n\n  <div style=\"background-color: #f9f9f9; padding: 15px; border-left: 5px solid #D32F2F; border-radius: 4px;\">\n    <p style=\"margin: 0; font-size: 14px; color: #888;\">Producto vendido en Wallapop:</p>\n    <p style=\"margin: 5px 0 0 0; font-size: 18px; font-weight: bold; color: #333;\">\n      {{ $('Edit Fields1').item.json.PRODUCTO }}\n    </p>\n  </div>\n\n  <p style=\"margin-top: 20px; font-size: 14px; color: #666;\">\n    <strong>Cliente:</strong> {{ $('Edit Fields1').item.json.NOMBRE }} {{ $('Edit Fields1').item.json.APELLIDO }}\n  </p>\n\n  <p style=\"font-size: 12px; color: #aaaaaa; margin-top: 30px; text-align: center;\">\n    Notificaci√≥n autom√°tica enviada por n8n ü§ñ\n  </p>\n\n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1360,
        -80
      ],
      "id": "f3adfb9a-00fb-4b05-ba3c-0bfefdad6238",
      "name": "Send a message3",
      "webhookId": "885e2e6b-4434-4af0-b7eb-9ecdf17d58a5",
      "credentials": {
        "gmailOAuth2": {
          "id": "RHR23CJ1w4T4gR4J",
          "name": "Gmail info@rules-shop.es"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1360,
        128
      ],
      "id": "18e53cd3-4282-4ae5-839d-e41de0f9eb99",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f80c1b3d-2b33-46fa-ad29-fcf5df34694f",
              "leftValue": "={{ $json.from.text }}",
              "rightValue": "\"Wallapop\" <info@wallapop.com>",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -368,
        -16
      ],
      "id": "be40b303-7a0f-4030-aa5f-5d3f3b29bb7f",
      "name": "If6"
    },
    {
      "parameters": {
        "content": "## De Wallapop",
        "height": 864,
        "width": 1760,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -160,
        -544
      ],
      "id": "a9eb70be-445d-4bc2-982a-068a3647bb60",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## De Vinted",
        "height": 816,
        "width": 1760,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -160,
        336
      ],
      "id": "0402b9a5-e42a-494a-8105-07c95b00002c",
      "name": "Sticky Note1"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-12-03T10:25:57.656Z",
      "createdAt": "2025-12-03T10:25:57.656Z",
      "role": "workflow:owner",
      "workflowId": "s453S4YZkDDjynYN",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": [
        4
      ]
    },
    "node:Gmail Trigger": {
      "Gmail Trigger": {
        "lastTimeChecked": 1768919293,
        "possibleDuplicates": [
          "19bdbce6024c5d42",
          "19bda67d121da517"
        ]
      }
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-01-20T18:31:39.007Z",
  "versionId": "e2eac41b-75fc-48ae-8f4d-3c9d09dc0f0d"
}