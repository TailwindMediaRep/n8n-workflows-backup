{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "dias_libres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dias_libres": {
      "main": [
        [
          {
            "node": "rejilla_canva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "rejilla_canva": {
      "main": [
        [
          {
            "node": "autorelleno_canva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "autorelleno_canva": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "comprobar_diseño",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-12T07:24:14.681Z",
  "id": "TukzsIQAbmNh69ly",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Booking",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -304,
        0
      ],
      "id": "8ab0c352-e75d-4666-a0b6-4aaa12cc73b5",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "url": "https://api.lodgify.com/v1/properties/549560",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {}
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json'"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        0
      ],
      "id": "dbacd693-8938-49aa-a7fe-91f51acc831b",
      "name": "HTTP Request",
      "alwaysOutputData": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "sNqsPd1BVM39QUPE",
          "name": "Lodgify_SkiRoom"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// 1. CONFIGURACIÓN\n// ==========================================\n// Usamos la fecha del sistema (20 de Enero de 2026 según tu contexto)\nconst today = new Date(); \ntoday.setHours(0, 0, 0, 0); // Reseteamos horas para comparar solo días\n\n// Variables para filtrar \"ESTE MES\"\nconst currentMonth = today.getMonth(); // 0 = Enero\nconst currentYear = today.getFullYear(); // 2026\n\n// ==========================================\n// 2. OBTENER DATOS\n// ==========================================\nconst data = items[0].json;\n\n// Detectamos la estancia mínima (priorizamos la de la habitación, que suele ser la real)\n// En tu JSON: Root = 1 día, Room = 3 días. Usamos la de la Room (3) para ser precisos.\nconst minStay = data.rooms && data.rooms[0] ? data.rooms[0].price_unit_in_days : (data.price_unit_in_days || 1);\n\n// Listas de fechas\nconst allowedCheckInDates = data.in_out.check_in || [];\nconst blockedDates = data.in_out.not_available || [];\n\n// Convertimos los bloqueos a un Set para búsqueda rápida\nconst blockedSet = new Set(blockedDates.map(item => item.date));\n\n// Función auxiliar para sumar días\nfunction addDays(dateStr, days) {\n    const date = new Date(dateStr);\n    date.setDate(date.getDate() + days);\n    return date.toISOString().split('T')[0];\n}\n\n// ==========================================\n// 3. LÓGICA DE FILTRADO\n// ==========================================\nlet validDates = [];\n\nfor (const item of allowedCheckInDates) {\n    const checkInDateStr = item.date;\n    const checkInDateObj = new Date(checkInDateStr);\n    \n    // --- FILTRO 1: ¿Es fecha pasada? ---\n    // Si la fecha es anterior a hoy, la saltamos\n    if (checkInDateObj < today) continue;\n\n    // --- FILTRO 2: ¿Es de ESTE MES? ---\n    // Si el mes o el año no coinciden con hoy, lo saltamos.\n    if (checkInDateObj.getMonth() !== currentMonth || checkInDateObj.getFullYear() !== currentYear) {\n        continue;\n    }\n\n    // --- FILTRO 3: ¿Está ocupado el día de llegada? ---\n    if (blockedSet.has(checkInDateStr)) continue;\n\n    // --- FILTRO 4: Regla de Estancia Mínima ---\n    // Verificamos si los días consecutivos necesarios (según minStay) están libres\n    let isMinStaySatisfied = true;\n\n    // Empezamos desde 1 porque el día 0 (llegada) ya vimos que está libre\n    for (let i = 1; i < minStay; i++) {\n        const nextDay = addDays(checkInDateStr, i);\n        if (blockedSet.has(nextDay)) {\n            isMinStaySatisfied = false;\n            break; // Encontramos un bloqueo en medio de la estancia mínima\n        }\n    }\n\n    // Si pasa todos los filtros, ¡es válido!\n    if (isMinStaySatisfied) {\n        validDates.push(checkInDateStr);\n    }\n}\n\n// ==========================================\n// 4. RESULTADO\n// ==========================================\nreturn [\n    {\n        json: {\n            target_month_name: today.toLocaleString('es-ES', { month: 'long' }),\n            min_stay_rule: minStay,\n            total_valid_days_this_month: validDates.length,\n            days: validDates\n        }\n    }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        0
      ],
      "id": "71447863-ab18-4fc5-ba85-e4b80d992a89",
      "name": "dias_libres"
    },
    {
      "parameters": {
        "jsCode": "// ==========================================\n// CONFIGURACIÓN\n// ==========================================\nconst crossSymbol = \"X\"; \n// Definimos el tamaño de la rejilla a 42 (6 semanas x 7 días)\n// Esto asegura que sirva para CUALQUIER mes del año\nconst totalGridCells = 42; \n\n// ==========================================\n// LÓGICA\n// ==========================================\nconst input = items[0].json;\n\n// 1. Días disponibles\nconst daysList = input.days || (input.data ? input.data.days : []) || [];\nconst availableDates = new Set(daysList);\n\n// 2. Configuración del Mes (Enero 2026)\n// Enero 2026 empieza en Jueves.\n// En semana L-M-X-J-V-S-D, Jueves es la 4ª posición.\n// Por tanto, hay 3 huecos vacíos al principio (L, M, X).\nconst startOffset = 3; \n\n// Días totales del mes (31 para Enero)\nconst daysInMonth = 31;\n\nconst canvaVariables = {};\n\n// 3. Generamos las 42 variables (p1...p42)\nfor (let pos = 1; pos <= totalGridCells; pos++) {\n    const varName = `p${pos}`; \n    \n    // Calculamos a qué día corresponde esta casilla\n    const dayNumber = pos - startOffset;\n\n    // CASO A: Huecos iniciales (antes del día 1)\n    if (dayNumber <= 0) {\n        canvaVariables[varName] = \"\"; \n        continue;\n    }\n\n    // CASO B: Huecos finales (después del día 31)\n    // Aquí es donde las casillas 36 a 42 se quedarán vacías automáticamente\n    if (dayNumber > daysInMonth) {\n        canvaVariables[varName] = \"\"; \n        continue;\n    }\n\n    // CASO C: Días reales del mes\n    const dateStr = `2026-01-${dayNumber.toString().padStart(2, '0')}`;\n\n    // Lógica de tachado\n    if (availableDates.has(dateStr)) {\n        canvaVariables[varName] = \"\"; // Disponible = Limpio\n    } else {\n        canvaVariables[varName] = crossSymbol; // Ocupado = Tachado\n    }\n}\n\nreturn [{ json: canvaVariables }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        0
      ],
      "id": "de580307-9b1f-4954-b91b-504f01007d32",
      "name": "rejilla_canva"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.canva.com/rest/v1/autofills",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"brand_template_id\": \"EAG-9UBJb7g\",\n  \"export_name\": \"Calendario Enero\",\n  \"data\": {\n    \"P1\": { \"type\": \"text\", \"text\": \"{{ $json.p1 }}\" },\n    \"P2\": { \"type\": \"text\", \"text\": \"{{ $json.p2 }}\" },\n    \"P3\": { \"type\": \"text\", \"text\": \"{{ $json.p3 }}\" },\n    \"P4\": { \"type\": \"text\", \"text\": \"{{ $json.p4 }}\" },\n    \"P5\": { \"type\": \"text\", \"text\": \"{{ $json.p5 }}\" },\n    \"P6\": { \"type\": \"text\", \"text\": \"{{ $json.p6 }}\" },\n    \"P7\": { \"type\": \"text\", \"text\": \"{{ $json.p7 }}\" },\n    \"P8\": { \"type\": \"text\", \"text\": \"{{ $json.p8 }}\" },\n    \"P9\": { \"type\": \"text\", \"text\": \"{{ $json.p9 }}\" },\n    \"P10\": { \"type\": \"text\", \"text\": \"{{ $json.p10 }}\" },\n    \"P11\": { \"type\": \"text\", \"text\": \"{{ $json.p11 }}\" },\n    \"P12\": { \"type\": \"text\", \"text\": \"{{ $json.p12 }}\" },\n    \"P13\": { \"type\": \"text\", \"text\": \"{{ $json.p13 }}\" },\n    \"P14\": { \"type\": \"text\", \"text\": \"{{ $json.p14 }}\" },\n    \"P15\": { \"type\": \"text\", \"text\": \"{{ $json.p15 }}\" },\n    \"P16\": { \"type\": \"text\", \"text\": \"{{ $json.p16 }}\" },\n    \"P17\": { \"type\": \"text\", \"text\": \"{{ $json.p17 }}\" },\n    \"P18\": { \"type\": \"text\", \"text\": \"{{ $json.p18 }}\" },\n    \"P19\": { \"type\": \"text\", \"text\": \"{{ $json.p19 }}\" },\n    \"P20\": { \"type\": \"text\", \"text\": \"{{ $json.p20 }}\" },\n    \"P21\": { \"type\": \"text\", \"text\": \"{{ $json.p21 }}\" },\n    \"P22\": { \"type\": \"text\", \"text\": \"{{ $json.p22 }}\" },\n    \"P23\": { \"type\": \"text\", \"text\": \"{{ $json.p23 }}\" },\n    \"P24\": { \"type\": \"text\", \"text\": \"{{ $json.p24 }}\" },\n    \"P25\": { \"type\": \"text\", \"text\": \"{{ $json.p25 }}\" },\n    \"P26\": { \"type\": \"text\", \"text\": \"{{ $json.p26 }}\" },\n    \"P27\": { \"type\": \"text\", \"text\": \"{{ $json.p27 }}\" },\n    \"P28\": { \"type\": \"text\", \"text\": \"{{ $json.p28 }}\" },\n    \"P29\": { \"type\": \"text\", \"text\": \"{{ $json.p29 }}\" },\n    \"P30\": { \"type\": \"text\", \"text\": \"{{ $json.p30 }}\" },\n    \"P31\": { \"type\": \"text\", \"text\": \"{{ $json.p31 }}\" },\n    \"P32\": { \"type\": \"text\", \"text\": \"{{ $json.p32 }}\" },\n    \"P33\": { \"type\": \"text\", \"text\": \"{{ $json.p33 }}\" },\n    \"P34\": { \"type\": \"text\", \"text\": \"{{ $json.p34 }}\" },\n    \"P35\": { \"type\": \"text\", \"text\": \"{{ $json.p35 }}\" },\n    \"P36\": { \"type\": \"text\", \"text\": \"{{ $json.p36 }}\" },\n    \"P37\": { \"type\": \"text\", \"text\": \"{{ $json.p37 }}\" },\n    \"P38\": { \"type\": \"text\", \"text\": \"{{ $json.p38 }}\" },\n    \"P39\": { \"type\": \"text\", \"text\": \"{{ $json.p39 }}\" },\n    \"P40\": { \"type\": \"text\", \"text\": \"{{ $json.p40 }}\" },\n    \"P41\": { \"type\": \"text\", \"text\": \"{{ $json.p41 }}\" },\n    \"P42\": { \"type\": \"text\", \"text\": \"{{ $json.p42 }}\" },\n    \"NOMBRE_MES\": {\"type\": \"text\", \"text\": \"{{ $('dias_libres').item.json.target_month_name }}\" }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        512,
        0
      ],
      "id": "733346af-b852-4d8e-9fee-506cb1a6f8e6",
      "name": "autorelleno_canva",
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "executeOnce": false,
      "alwaysOutputData": false,
      "notesInFlow": false,
      "credentials": {
        "oAuth2Api": {
          "id": "eHEbZK7oC3pW1LQr",
          "name": "Canva"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        704,
        0
      ],
      "id": "00b76dac-e59a-4f88-9e9f-10d3856d2958",
      "name": "Wait",
      "webhookId": "62d1b964-0d3e-47a7-885f-6f510379f170"
    },
    {
      "parameters": {
        "url": "=https://api.canva.com/rest/v1/autofills/{{ $json.job.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        896,
        0
      ],
      "id": "f9dc10dd-0f8b-4b47-a900-b9ab0c1eaf17",
      "name": "comprobar_diseño",
      "credentials": {
        "oAuth2Api": {
          "id": "eHEbZK7oC3pW1LQr",
          "name": "Canva"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-12-12T07:24:14.685Z",
      "createdAt": "2025-12-12T07:24:14.685Z",
      "role": "workflow:owner",
      "workflowId": "TukzsIQAbmNh69ly",
      "projectId": "x5UZcmGQw2OWHuXb"
    }
  ],
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2026-01-20T13:37:55.916Z",
  "versionId": "701d25dd-16f8-4424-b5e5-e6b5ba2dadf9"
}